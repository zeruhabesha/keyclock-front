{"version":3,"file":"JwksSettings-DiafDiDg.js","sources":["../../../../../../../src/identity-providers/add/JwksSettings.tsx"],"sourcesContent":["import IdentityProviderRepresentation from \"@keycloak/keycloak-admin-client/lib/defs/identityProviderRepresentation\";\r\nimport { AlertVariant, FormGroup, Button } from \"@patternfly/react-core\";\r\nimport { useFormContext, useWatch } from \"react-hook-form\";\r\nimport { DefaultSwitchControl } from \"../../components/SwitchControl\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport {\r\n  TextAreaControl,\r\n  TextControl,\r\n  useAlerts,\r\n} from \"@keycloak/keycloak-ui-shared\";\r\nimport {\r\n  ImportFile,\r\n  ImportKeyDialog,\r\n} from \"../../clients/keys/ImportKeyDialog\";\r\nimport useToggle from \"../../utils/useToggle\";\r\nimport { useAdminClient } from \"../../admin-client\";\r\n\r\ntype JwksSettingsProps = {\r\n  readOnly?: boolean;\r\n};\r\n\r\nexport const JwksSettings = ({ readOnly = false }: JwksSettingsProps) => {\r\n  const { t } = useTranslation();\r\n  const { control, setValue } =\r\n    useFormContext<IdentityProviderRepresentation>();\r\n  const { adminClient } = useAdminClient();\r\n  const { addAlert, addError } = useAlerts();\r\n  const [openImportKeys, toggleOpenImportKeys, setOpenImportKeys] = useToggle();\r\n  const useJwks = useWatch({\r\n    control,\r\n    name: \"config.useJwksUrl\",\r\n    defaultValue: \"true\",\r\n  });\r\n  const publicKeySignatureVerifier = useWatch({\r\n    control,\r\n    name: \"config.publicKeySignatureVerifier\",\r\n  });\r\n\r\n  const importKey = async (importFile: ImportFile) => {\r\n    try {\r\n      const formData = new FormData();\r\n      const { file, ...rest } = importFile;\r\n\r\n      for (const [key, value] of Object.entries(rest)) {\r\n        formData.append(key, value);\r\n      }\r\n\r\n      formData.append(\"file\", file);\r\n      const info = await adminClient.identityProviders.uploadCertificate(\r\n        {},\r\n        formData,\r\n      );\r\n      if (info.jwks) {\r\n        setValue(\"config.publicKeySignatureVerifier\", info.jwks);\r\n        setValue(\"config.publicKeySignatureVerifierKeyId\", \"\");\r\n        addAlert(t(\"importSuccess\"), AlertVariant.success);\r\n      } else if (info.publicKey) {\r\n        setValue(\"config.publicKeySignatureVerifier\", info.publicKey);\r\n        addAlert(t(\"importSuccess\"), AlertVariant.success);\r\n      } else {\r\n        addError(\"importError\", t(\"emptyResources\"));\r\n      }\r\n    } catch (error) {\r\n      addError(\"importError\", error);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <DefaultSwitchControl\r\n        name=\"config.useJwksUrl\"\r\n        label={t(\"useJwksUrl\")}\r\n        labelIcon={t(\"useJwksUrlHelp\")}\r\n        isDisabled={readOnly}\r\n        defaultValue={\"true\"}\r\n        stringify\r\n      />\r\n      {useJwks === \"true\" ? (\r\n        <TextControl\r\n          name=\"config.jwksUrl\"\r\n          label={t(\"jwksUrl\")}\r\n          labelIcon={t(\"jwksUrlHelp\")}\r\n          type=\"url\"\r\n          readOnly={readOnly}\r\n          rules={{\r\n            required: t(\"required\"),\r\n          }}\r\n        />\r\n      ) : (\r\n        <>\r\n          {openImportKeys && (\r\n            <ImportKeyDialog\r\n              toggleDialog={toggleOpenImportKeys}\r\n              save={importKey}\r\n              title=\"importKey\"\r\n              description=\"importKeysDescription\"\r\n            />\r\n          )}\r\n          {!publicKeySignatureVerifier?.trim().startsWith(\"{\") && (\r\n            <TextControl\r\n              name=\"config.publicKeySignatureVerifierKeyId\"\r\n              label={t(\"validatingPublicKeyId\")}\r\n              labelIcon={t(\"validatingPublicKeyIdHelp\")}\r\n              readOnly={readOnly}\r\n            />\r\n          )}\r\n          <TextAreaControl\r\n            name=\"config.publicKeySignatureVerifier\"\r\n            label={t(\"validatingPublicKey\")}\r\n            labelIcon={t(\"validatingPublicKeyHelp\")}\r\n            rules={{ required: t(\"required\") }}\r\n            readOnly={readOnly}\r\n          />\r\n          {!readOnly && (\r\n            <FormGroup fieldId=\"kc-import-certificate-button\">\r\n              <Button\r\n                variant=\"secondary\"\r\n                data-testid=\"import-certificate-button\"\r\n                onClick={() => setOpenImportKeys(true)}\r\n              >\r\n                {t(\"import\")}\r\n              </Button>\r\n            </FormGroup>\r\n          )}\r\n        </>\r\n      )}\r\n    </>\r\n  );\r\n};\r\n"],"names":["JwksSettings","readOnly","t","useTranslation","control","setValue","useFormContext","adminClient","useAdminClient","addAlert","addError","useAlerts","openImportKeys","toggleOpenImportKeys","setOpenImportKeys","useToggle","useJwks","useWatch","publicKeySignatureVerifier","importKey","importFile","formData","file","rest","key","value","info","AlertVariant","error","jsxs","Fragment","jsx","DefaultSwitchControl","TextControl","ImportKeyDialog","TextAreaControl","FormGroup","Button"],"mappings":"iRAqBO,MAAMA,EAAe,CAAC,CAAE,SAAAC,EAAW,MAA+B,CACvE,KAAM,CAAE,EAAAC,CAAA,EAAMC,EAAA,EACR,CAAE,QAAAC,EAAS,SAAAC,CAAA,EACfC,EAAA,EACI,CAAE,YAAAC,CAAA,EAAgBC,EAAA,EAClB,CAAE,SAAAC,EAAU,SAAAC,CAAA,EAAaC,EAAA,EACzB,CAACC,EAAgBC,EAAsBC,CAAiB,EAAIC,EAAA,EAC5DC,EAAUC,EAAS,CACvB,QAAAb,EACA,KAAM,oBACN,aAAc,MAAA,CACf,EACKc,EAA6BD,EAAS,CAC1C,QAAAb,EACA,KAAM,mCAAA,CACP,EAEKe,EAAY,MAAOC,GAA2B,CAClD,GAAI,CACF,MAAMC,EAAW,IAAI,SACf,CAAE,KAAAC,EAAM,GAAGC,CAAA,EAASH,EAE1B,SAAW,CAACI,EAAKC,CAAK,IAAK,OAAO,QAAQF,CAAI,EAC5CF,EAAS,OAAOG,EAAKC,CAAK,EAG5BJ,EAAS,OAAO,OAAQC,CAAI,EAC5B,MAAMI,EAAO,MAAMnB,EAAY,kBAAkB,kBAC/C,CAAA,EACAc,CAAA,EAEEK,EAAK,MACPrB,EAAS,oCAAqCqB,EAAK,IAAI,EACvDrB,EAAS,yCAA0C,EAAE,EACrDI,EAASP,EAAE,eAAe,EAAGyB,EAAa,OAAO,GACxCD,EAAK,WACdrB,EAAS,oCAAqCqB,EAAK,SAAS,EAC5DjB,EAASP,EAAE,eAAe,EAAGyB,EAAa,OAAO,GAEjDjB,EAAS,cAAeR,EAAE,gBAAgB,CAAC,CAE/C,OAAS0B,EAAO,CACdlB,EAAS,cAAekB,CAAK,CAC/B,CACF,EAEA,OACEC,EAAAC,EAAA,CACE,SAAA,CAAAC,EAACC,EAAA,CACC,KAAK,oBACL,MAAO9B,EAAE,YAAY,EACrB,UAAWA,EAAE,gBAAgB,EAC7B,WAAYD,EACZ,aAAc,OACd,UAAS,EAAA,CAAA,EAEVe,IAAY,OACXe,EAACE,EAAA,CACC,KAAK,iBACL,MAAO/B,EAAE,SAAS,EAClB,UAAWA,EAAE,aAAa,EAC1B,KAAK,MACL,SAAAD,EACA,MAAO,CACL,SAAUC,EAAE,UAAU,CAAA,CACxB,CAAA,EAGF2B,EAAAC,EAAA,CACG,SAAA,CAAAlB,GACCmB,EAACG,EAAA,CACC,aAAcrB,EACd,KAAMM,EACN,MAAM,YACN,YAAY,uBAAA,CAAA,EAGf,CAACD,GAA4B,KAAA,EAAO,WAAW,GAAG,GACjDa,EAACE,EAAA,CACC,KAAK,yCACL,MAAO/B,EAAE,uBAAuB,EAChC,UAAWA,EAAE,2BAA2B,EACxC,SAAAD,CAAA,CAAA,EAGJ8B,EAACI,EAAA,CACC,KAAK,oCACL,MAAOjC,EAAE,qBAAqB,EAC9B,UAAWA,EAAE,yBAAyB,EACtC,MAAO,CAAE,SAAUA,EAAE,UAAU,CAAA,EAC/B,SAAAD,CAAA,CAAA,EAED,CAACA,GACA8B,EAACK,EAAA,CAAU,QAAQ,+BACjB,SAAAL,EAACM,EAAA,CACC,QAAQ,YACR,cAAY,4BACZ,QAAS,IAAMvB,EAAkB,EAAI,EAEpC,WAAE,QAAQ,CAAA,CAAA,CACb,CACF,CAAA,CAAA,CAEJ,CAAA,EAEJ,CAEJ"}