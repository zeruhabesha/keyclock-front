{"version":3,"file":"DedicatedScopes-BBK4hG1F.js","sources":["../../../../../../../src/clients/scopes/DedicatedScope.tsx","../../../../../../../src/clients/scopes/DedicatedScopes.tsx"],"sourcesContent":["import type ClientRepresentation from \"@keycloak/keycloak-admin-client/lib/defs/clientRepresentation\";\r\nimport type { RoleMappingPayload } from \"@keycloak/keycloak-admin-client/lib/defs/roleRepresentation\";\r\nimport {\r\n  AlertVariant,\r\n  Divider,\r\n  FormGroup,\r\n  PageSection,\r\n  Switch,\r\n} from \"@patternfly/react-core\";\r\nimport { useState } from \"react\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { HelpItem } from \"@keycloak/keycloak-ui-shared\";\r\nimport { useAdminClient } from \"../../admin-client\";\r\nimport { useAlerts } from \"@keycloak/keycloak-ui-shared\";\r\nimport { FormAccess } from \"../../components/form/FormAccess\";\r\nimport { RoleMapping, Row } from \"../../components/role-mapping/RoleMapping\";\r\nimport { useAccess } from \"../../context/access/Access\";\r\n\r\ntype DedicatedScopeProps = {\r\n  client: ClientRepresentation;\r\n};\r\n\r\nexport const DedicatedScope = ({\r\n  client: initialClient,\r\n}: DedicatedScopeProps) => {\r\n  const { adminClient } = useAdminClient();\r\n\r\n  const { t } = useTranslation();\r\n  const { addAlert, addError } = useAlerts();\r\n\r\n  const [client, setClient] = useState<ClientRepresentation>(initialClient);\r\n\r\n  const { hasAccess } = useAccess();\r\n  const isManager = hasAccess(\"manage-clients\") || client.access?.manage;\r\n\r\n  const assignRoles = async (rows: Row[]) => {\r\n    try {\r\n      const realmRoles = rows\r\n        .filter((row) => row.client === undefined)\r\n        .map((row) => row.role as RoleMappingPayload)\r\n        .flat();\r\n      await Promise.all([\r\n        adminClient.clients.addRealmScopeMappings(\r\n          {\r\n            id: client.id!,\r\n          },\r\n          realmRoles,\r\n        ),\r\n        ...rows\r\n          .filter((row) => row.client !== undefined)\r\n          .map((row) =>\r\n            adminClient.clients.addClientScopeMappings(\r\n              {\r\n                id: client.id!,\r\n                client: row.client!.id!,\r\n              },\r\n              [row.role as RoleMappingPayload],\r\n            ),\r\n          ),\r\n      ]);\r\n\r\n      addAlert(t(\"clientScopeSuccess\"), AlertVariant.success);\r\n    } catch (error) {\r\n      addError(\"clientScopeError\", error);\r\n    }\r\n  };\r\n\r\n  const update = async () => {\r\n    const newClient = { ...client, fullScopeAllowed: !client.fullScopeAllowed };\r\n    try {\r\n      await adminClient.clients.update({ id: client.id! }, newClient);\r\n      addAlert(t(\"clientScopeSuccess\"), AlertVariant.success);\r\n      setClient(newClient);\r\n    } catch (error) {\r\n      addError(\"clientScopeError\", error);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <PageSection>\r\n      <FormAccess\r\n        role=\"manage-clients\"\r\n        fineGrainedAccess={client.access?.manage}\r\n        isHorizontal\r\n      >\r\n        <FormGroup\r\n          hasNoPaddingTop\r\n          label={t(\"fullScopeAllowed\")}\r\n          labelIcon={\r\n            <HelpItem\r\n              helpText={t(\"fullScopeAllowedHelp\")}\r\n              fieldLabelId=\"fullScopeAllowed\"\r\n            />\r\n          }\r\n          fieldId=\"fullScopeAllowed\"\r\n        >\r\n          <Switch\r\n            id=\"fullScopeAllowed\"\r\n            label={t(\"on\")}\r\n            labelOff={t(\"off\")}\r\n            isChecked={client.fullScopeAllowed}\r\n            onChange={update}\r\n            aria-label={t(\"fullScopeAllowed\")}\r\n          />\r\n        </FormGroup>\r\n      </FormAccess>\r\n      {!client.fullScopeAllowed && (\r\n        <>\r\n          <Divider />\r\n          <RoleMapping\r\n            name={client.clientId!}\r\n            id={client.id!}\r\n            type=\"clients\"\r\n            save={assignRoles}\r\n            isManager={isManager}\r\n          />\r\n        </>\r\n      )}\r\n    </PageSection>\r\n  );\r\n};\r\n","import type ClientRepresentation from \"@keycloak/keycloak-admin-client/lib/defs/clientRepresentation\";\r\nimport type ProtocolMapperRepresentation from \"@keycloak/keycloak-admin-client/lib/defs/protocolMapperRepresentation\";\r\nimport type { ProtocolMapperTypeRepresentation } from \"@keycloak/keycloak-admin-client/lib/defs/serverInfoRepesentation\";\r\nimport { useAlerts, useFetch } from \"@keycloak/keycloak-ui-shared\";\r\nimport {\r\n  AlertVariant,\r\n  PageSection,\r\n  Tab,\r\n  TabTitleText,\r\n} from \"@patternfly/react-core\";\r\nimport { useState } from \"react\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { useNavigate } from \"react-router-dom\";\r\nimport { useAdminClient } from \"../../admin-client\";\r\nimport { MapperList } from \"../../client-scopes/details/MapperList\";\r\nimport { KeycloakSpinner } from \"@keycloak/keycloak-ui-shared\";\r\nimport {\r\n  RoutableTabs,\r\n  useRoutableTab,\r\n} from \"../../components/routable-tabs/RoutableTabs\";\r\nimport { ViewHeader } from \"../../components/view-header/ViewHeader\";\r\nimport { useParams } from \"../../utils/useParams\";\r\nimport {\r\n  DedicatedScopeDetailsParams,\r\n  DedicatedScopeTab,\r\n  toDedicatedScope,\r\n} from \"../routes/DedicatedScopeDetails\";\r\nimport { toMapper } from \"../routes/Mapper\";\r\nimport { DedicatedScope } from \"./DedicatedScope\";\r\n\r\nexport default function DedicatedScopes() {\r\n  const { adminClient } = useAdminClient();\r\n\r\n  const { t } = useTranslation();\r\n  const navigate = useNavigate();\r\n  const { realm, clientId } = useParams<DedicatedScopeDetailsParams>();\r\n  const { addAlert, addError } = useAlerts();\r\n\r\n  const [client, setClient] = useState<ClientRepresentation>();\r\n\r\n  useFetch(() => adminClient.clients.findOne({ id: clientId }), setClient, []);\r\n\r\n  const useTab = (tab: DedicatedScopeTab) =>\r\n    useRoutableTab(toDedicatedScope({ realm, clientId, tab }));\r\n\r\n  const mappersTab = useTab(\"mappers\");\r\n  const scopeTab = useTab(\"scope\");\r\n\r\n  if (!client) {\r\n    return <KeycloakSpinner />;\r\n  }\r\n\r\n  const addMappers = async (\r\n    mappers: ProtocolMapperTypeRepresentation | ProtocolMapperRepresentation[],\r\n  ): Promise<void> => {\r\n    if (!Array.isArray(mappers)) {\r\n      const mapper = mappers as ProtocolMapperTypeRepresentation;\r\n      navigate(\r\n        toMapper({\r\n          realm,\r\n          id: client.id!,\r\n          mapperId: mapper.id!,\r\n          viewMode: \"new\",\r\n        }),\r\n      );\r\n    } else {\r\n      try {\r\n        await adminClient.clients.addMultipleProtocolMappers(\r\n          { id: client.id! },\r\n          mappers as ProtocolMapperRepresentation[],\r\n        );\r\n        setClient(await adminClient.clients.findOne({ id: client.id! }));\r\n        addAlert(t(\"mappingCreatedSuccess\"), AlertVariant.success);\r\n      } catch (error) {\r\n        addError(\"mappingCreatedError\", error);\r\n      }\r\n    }\r\n  };\r\n\r\n  const onDeleteMapper = async (mapper: ProtocolMapperRepresentation) => {\r\n    try {\r\n      await adminClient.clients.delProtocolMapper({\r\n        id: client.id!,\r\n        mapperId: mapper.id!,\r\n      });\r\n      setClient({\r\n        ...client,\r\n        protocolMappers: client.protocolMappers?.filter(\r\n          (m) => m.id !== mapper.id,\r\n        ),\r\n      });\r\n      addAlert(t(\"mappingDeletedSuccess\"), AlertVariant.success);\r\n    } catch (error) {\r\n      addError(\"mappingDeletedError\", error);\r\n    }\r\n    return true;\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <ViewHeader\r\n        titleKey={client.clientId! + \"-dedicated\"}\r\n        subKey=\"dedicatedScopeExplain\"\r\n        divider={false}\r\n      />\r\n      <PageSection variant=\"light\" className=\"pf-v5-u-p-0\">\r\n        <RoutableTabs\r\n          isBox\r\n          mountOnEnter\r\n          defaultLocation={toDedicatedScope({\r\n            realm,\r\n            clientId,\r\n            tab: \"mappers\",\r\n          })}\r\n        >\r\n          <Tab\r\n            title={<TabTitleText>{t(\"mappers\")}</TabTitleText>}\r\n            data-testid=\"mappersTab\"\r\n            {...mappersTab}\r\n          >\r\n            <MapperList\r\n              model={client}\r\n              onAdd={addMappers}\r\n              onDelete={onDeleteMapper}\r\n              detailLink={(mapperId) =>\r\n                toMapper({ realm, id: client.id!, mapperId, viewMode: \"edit\" })\r\n              }\r\n            />\r\n          </Tab>\r\n          <Tab\r\n            title={<TabTitleText>{t(\"scope\")}</TabTitleText>}\r\n            data-testid=\"scopeTab\"\r\n            {...scopeTab}\r\n          >\r\n            <DedicatedScope client={client} />\r\n          </Tab>\r\n        </RoutableTabs>\r\n      </PageSection>\r\n    </>\r\n  );\r\n}\r\n"],"names":["DedicatedScope","initialClient","adminClient","useAdminClient","t","useTranslation","addAlert","addError","useAlerts","client","setClient","useState","hasAccess","useAccess","isManager","assignRoles","rows","realmRoles","row","AlertVariant","error","update","newClient","PageSection","jsx","FormAccess","FormGroup","HelpItem","Switch","jsxs","Fragment","Divider","RoleMapping","DedicatedScopes","navigate","useNavigate","realm","clientId","useParams","useFetch","useTab","tab","useRoutableTab","toDedicatedScope","mappersTab","scopeTab","KeycloakSpinner","addMappers","mappers","mapper","toMapper","onDeleteMapper","m","ViewHeader","RoutableTabs","Tab","TabTitleText","MapperList","mapperId"],"mappings":"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"}