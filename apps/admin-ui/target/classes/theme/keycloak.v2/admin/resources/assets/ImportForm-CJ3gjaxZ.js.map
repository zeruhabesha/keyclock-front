{"version":3,"file":"ImportForm-CJ3gjaxZ.js","sources":["../../../../../../../src/clients/import/ImportForm.tsx"],"sourcesContent":["import { fetchWithError } from \"@keycloak/keycloak-admin-client\";\r\nimport type ClientRepresentation from \"@keycloak/keycloak-admin-client/lib/defs/clientRepresentation\";\r\nimport {\r\n  ActionGroup,\r\n  AlertVariant,\r\n  Button,\r\n  PageSection,\r\n} from \"@patternfly/react-core\";\r\nimport { useState } from \"react\";\r\nimport { FormProvider, useForm } from \"react-hook-form\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { Link, useNavigate } from \"react-router-dom\";\r\nimport { FormSubmitButton, TextControl } from \"@keycloak/keycloak-ui-shared\";\r\nimport { useAdminClient } from \"../../admin-client\";\r\nimport { useAlerts } from \"@keycloak/keycloak-ui-shared\";\r\nimport { FormAccess } from \"../../components/form/FormAccess\";\r\nimport { FileUploadForm } from \"../../components/json-file-upload/FileUploadForm\";\r\nimport { ViewHeader } from \"../../components/view-header/ViewHeader\";\r\nimport { useRealm } from \"../../context/realm-context/RealmContext\";\r\nimport {\r\n  addTrailingSlash,\r\n  convertFormValuesToObject,\r\n  convertToFormValues,\r\n} from \"../../util\";\r\nimport { getAuthorizationHeaders } from \"../../utils/getAuthorizationHeaders\";\r\nimport { ClientDescription } from \"../ClientDescription\";\r\nimport { FormFields } from \"../ClientDetails\";\r\nimport { CapabilityConfig } from \"../add/CapabilityConfig\";\r\nimport { toClient } from \"../routes/Client\";\r\nimport { toClients } from \"../routes/Clients\";\r\n\r\nconst isXml = (text: string) => text.match(/(<.[^(><.)]+>)/g);\r\n\r\nexport default function ImportForm() {\r\n  const { adminClient } = useAdminClient();\r\n\r\n  const { t } = useTranslation();\r\n  const navigate = useNavigate();\r\n  const { realm } = useRealm();\r\n  const form = useForm<FormFields>();\r\n  const { handleSubmit, setValue, formState } = form;\r\n  const [imported, setImported] = useState<ClientRepresentation>({});\r\n\r\n  const { addAlert, addError } = useAlerts();\r\n\r\n  const handleFileChange = async (contents: string) => {\r\n    try {\r\n      const parsed = await parseFileContents(contents);\r\n\r\n      convertToFormValues(parsed, setValue);\r\n      setImported(parsed);\r\n    } catch (error) {\r\n      addError(\"importParseError\", error);\r\n    }\r\n  };\r\n\r\n  async function parseFileContents(\r\n    contents: string,\r\n  ): Promise<ClientRepresentation> {\r\n    if (!isXml(contents)) {\r\n      return JSON.parse(contents);\r\n    }\r\n\r\n    const response = await fetchWithError(\r\n      `${addTrailingSlash(\r\n        adminClient.baseUrl,\r\n      )}admin/realms/${realm}/client-description-converter`,\r\n      {\r\n        method: \"POST\",\r\n        body: contents,\r\n        headers: getAuthorizationHeaders(await adminClient.getAccessToken()),\r\n      },\r\n    );\r\n\r\n    if (!response.ok) {\r\n      throw new Error(\r\n        `Server responded with invalid status: ${response.statusText}`,\r\n      );\r\n    }\r\n\r\n    return response.json();\r\n  }\r\n\r\n  const save = async (client: ClientRepresentation) => {\r\n    try {\r\n      const newClient = await adminClient.clients.create({\r\n        ...imported,\r\n        ...convertFormValuesToObject({\r\n          ...client,\r\n          attributes: client.attributes || {},\r\n        }),\r\n      });\r\n      addAlert(t(\"clientImportSuccess\"), AlertVariant.success);\r\n      navigate(toClient({ realm, clientId: newClient.id, tab: \"settings\" }));\r\n    } catch (error) {\r\n      addError(\"clientImportError\", error);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <ViewHeader titleKey=\"importClient\" subKey=\"clientsExplain\" />\r\n      <PageSection variant=\"light\">\r\n        <FormAccess\r\n          isHorizontal\r\n          onSubmit={handleSubmit(save)}\r\n          role=\"manage-clients\"\r\n        >\r\n          <FormProvider {...form}>\r\n            <FileUploadForm\r\n              id=\"realm-file\"\r\n              language=\"json\"\r\n              extension=\".json,.xml\"\r\n              helpText={t(\"helpFileUploadClient\")}\r\n              onChange={handleFileChange}\r\n            />\r\n            <ClientDescription hasConfigureAccess />\r\n            <TextControl name=\"protocol\" label={t(\"type\")} readOnly />\r\n            <CapabilityConfig unWrap={true} />\r\n            <ActionGroup>\r\n              <FormSubmitButton\r\n                formState={formState}\r\n                allowInvalid\r\n                allowNonDirty\r\n              >\r\n                {t(\"save\")}\r\n              </FormSubmitButton>\r\n              <Button\r\n                variant=\"link\"\r\n                component={(props) => (\r\n                  <Link {...props} to={toClients({ realm })} />\r\n                )}\r\n              >\r\n                {t(\"cancel\")}\r\n              </Button>\r\n            </ActionGroup>\r\n          </FormProvider>\r\n        </FormAccess>\r\n      </PageSection>\r\n    </>\r\n  );\r\n}\r\n"],"names":["isXml","text","ImportForm","adminClient","useAdminClient","t","useTranslation","navigate","useNavigate","realm","useRealm","form","useForm","handleSubmit","setValue","formState","imported","setImported","useState","addAlert","addError","useAlerts","handleFileChange","contents","parsed","parseFileContents","convertToFormValues","error","response","fetchWithError","addTrailingSlash","getAuthorizationHeaders","jsxs","Fragment","jsx","ViewHeader","PageSection","FormAccess","client","newClient","convertFormValuesToObject","AlertVariant","toClient","FormProvider","FileUploadForm","ClientDescription","TextControl","CapabilityConfig","ActionGroup","FormSubmitButton","Button","props","Link","toClients"],"mappings":"imBA+BA,MAAMA,EAASC,GAAiBA,EAAK,MAAM,iBAAiB,EAE5D,SAAwBC,IAAa,CACnC,KAAM,CAAE,YAAAC,CAAA,EAAgBC,EAAA,EAElB,CAAE,EAAAC,CAAA,EAAMC,EAAA,EACRC,EAAWC,EAAA,EACX,CAAE,MAAAC,CAAA,EAAUC,EAAA,EACZC,EAAOC,EAAA,EACP,CAAE,aAAAC,EAAc,SAAAC,EAAU,UAAAC,CAAA,EAAcJ,EACxC,CAACK,EAAUC,CAAW,EAAIC,EAA+B,CAAA,CAAE,EAE3D,CAAE,SAAAC,EAAU,SAAAC,CAAA,EAAaC,EAAA,EAEzBC,EAAmB,MAAOC,GAAqB,CACnD,GAAI,CACF,MAAMC,EAAS,MAAMC,EAAkBF,CAAQ,EAE/CG,EAAoBF,EAAQV,CAAQ,EACpCG,EAAYO,CAAM,CACpB,OAASG,EAAO,CACdP,EAAS,mBAAoBO,CAAK,CACpC,CACF,EAEA,eAAeF,EACbF,EAC+B,CAC/B,GAAI,CAACvB,EAAMuB,CAAQ,EACjB,OAAO,KAAK,MAAMA,CAAQ,EAG5B,MAAMK,EAAW,MAAMC,EACrB,GAAGC,EACD3B,EAAY,OAAA,CACb,gBAAgBM,CAAK,gCACtB,CACE,OAAQ,OACR,KAAMc,EACN,QAASQ,EAAwB,MAAM5B,EAAY,gBAAgB,CAAA,CACrE,EAGF,GAAI,CAACyB,EAAS,GACZ,MAAM,IAAI,MACR,yCAAyCA,EAAS,UAAU,EAAA,EAIhE,OAAOA,EAAS,KAAA,CAClB,CAkBA,OACEI,EAAAC,EAAA,CACE,SAAA,CAAAC,EAACC,EAAA,CAAW,SAAS,eAAe,OAAO,iBAAiB,EAC5DD,EAACE,EAAA,CAAY,QAAQ,QACnB,SAAAF,EAACG,EAAA,CACC,aAAY,GACZ,SAAUxB,EAtBL,MAAOyB,GAAiC,CACnD,GAAI,CACF,MAAMC,EAAY,MAAMpC,EAAY,QAAQ,OAAO,CACjD,GAAGa,EACH,GAAGwB,EAA0B,CAC3B,GAAGF,EACH,WAAYA,EAAO,YAAc,CAAA,CAAC,CACnC,CAAA,CACF,EACDnB,EAASd,EAAE,qBAAqB,EAAGoC,EAAa,OAAO,EACvDlC,EAASmC,EAAS,CAAE,MAAAjC,EAAO,SAAU8B,EAAU,GAAI,IAAK,UAAA,CAAY,CAAC,CACvE,OAASZ,EAAO,CACdP,EAAS,oBAAqBO,CAAK,CACrC,CACF,CAQmC,EAC3B,KAAK,iBAEL,SAAAK,EAACW,EAAA,CAAc,GAAGhC,EAChB,SAAA,CAAAuB,EAACU,EAAA,CACC,GAAG,aACH,SAAS,OACT,UAAU,aACV,SAAUvC,EAAE,sBAAsB,EAClC,SAAUiB,CAAA,CAAA,EAEZY,EAACW,EAAA,CAAkB,mBAAkB,EAAA,CAAC,EACtCX,EAACY,GAAY,KAAK,WAAW,MAAOzC,EAAE,MAAM,EAAG,SAAQ,GAAC,EACxD6B,EAACa,EAAA,CAAiB,OAAQ,EAAA,CAAM,IAC/BC,EAAA,CACC,SAAA,CAAAd,EAACe,EAAA,CACC,UAAAlC,EACA,aAAY,GACZ,cAAa,GAEZ,WAAE,MAAM,CAAA,CAAA,EAEXmB,EAACgB,EAAA,CACC,QAAQ,OACR,UAAYC,GACVjB,EAACkB,EAAA,CAAM,GAAGD,EAAO,GAAIE,EAAU,CAAE,MAAA5C,CAAA,CAAO,CAAA,CAAG,EAG5C,WAAE,QAAQ,CAAA,CAAA,CACb,CAAA,CACF,CAAA,CAAA,CACF,CAAA,CAAA,CACF,CACF,CAAA,EACF,CAEJ"}