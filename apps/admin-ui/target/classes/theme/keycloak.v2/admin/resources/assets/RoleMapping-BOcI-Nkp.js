import{jsx as o,jsxs as k,Fragment as K}from"react/jsx-runtime";import{bm as N,u as j,a as D,M as G,k as J,x as H,aX as Q,v as W,g as U,C as Z,aS as ee,aM as te,aN as ne,D as P,al as se,bF as ie,c0 as le,_ as ae,B as oe,o as re,c5 as ce,aY as de,T as $,cc as pe}from"./main-o1hptXRo.js";import{useState as M}from"react";import{t as X}from"./translationFormatter-DQJeO7lr.js";import{u as me}from"./ConfirmDialog-BkU7melV.js";import{u as ge}from"./useLocaleSort-C-diWts5.js";const O={delete:["delClientRoleMappings","delRealmRoleMappings"],listEffective:["listRoleMappings","listCompositeRealmRoleMappings","listCompositeClientRoleMappings"],listAvailable:["listAvailableClientRoleMappings","listAvailableRealmRoleMappings"]},V={delete:["delClientScopeMappings","delRealmScopeMappings"],listEffective:["listScopeMappings","listCompositeRealmScopeMappings","listCompositeClientScopeMappings"],listAvailable:["listAvailableClientScopeMappings","listAvailableRealmScopeMappings"]},F={groups:O,users:O,clientScopes:V,clients:V,roles:{delete:["delCompositeRoles","delCompositeRoles"],listEffective:["getCompositeRoles","getCompositeRoles","getCompositeRolesForClient"],listAvailable:["listRoles","find"]}},ue=(t,e)=>t[e],y=(t,e,s,...n)=>ue(t,e)[s](...n),Re=(t,e,s,n)=>n.map(l=>{const r={id:l.role.id,name:l.role.name},i=F[e]?.delete[l.client?0:1];return y(t,e,i,{id:s,clientUniqueId:l.client?.id,client:l.client?.id,roles:[r]},[r])}),fe=async(t,e,s)=>{const n=F[e].listEffective[0],l=y(t,e,n,{id:s});if(e!=="roles")return l;const r=await l;return{clientMappings:await Promise.all(r.filter(c=>c.clientRole).map(async c=>{const u=await t.clients.findOne({id:c.containerId});return c.containerId=u?.clientId,{...u,mappings:[c]}})),realmMappings:r.filter(c=>!c.clientRole)}},he=async(t,e,s)=>{const n=F[e].listEffective[1];if(e!=="roles")return(await y(t,e,n,{id:s})).map(i=>({role:i}));const l=await y(t,e,n,{id:s}),r=await Promise.all(l.filter(i=>i.composite).map(i=>y(t,e,n,{id:i.id})));return[...l,...r.flat()].map(i=>({role:i}))},Ce=async(t,e,s)=>{const n=F[e].listAvailable[1];return(await y(t,e,n,s)).map(l=>({role:l}))},L=async(t,{id:e,type:s,first:n,max:l,search:r,endpoint:i})=>N(t,`/ui-ext/${i}/${s}/${encodeURIComponent(e)}`,{first:(n||0).toString(),max:(l||10).toString(),search:r||""}),ve=(t,e)=>L(t,{...e,endpoint:"available-roles"}),Me=(t,e)=>L(t,{...e,endpoint:"effective-roles"}),Fe=(t,e)=>N(t,"ui-ext/brute-force-user",e),Be=(t,e)=>L(t,{...e,endpoint:"authentication-management"}),ye=({role:t})=>{const{t:e}=D();return o(ie,{wrapModifier:"truncate",children:X(e)(t.description)})},_=({label:t,variant:e,isDisabled:s,onFilerTypeChange:n,...l})=>{const{t:r}=D(),[i,c]=Z(),{hasAccess:u}=ee(),h=u("view-realm")||u("query-users");return o(te,{onOpenChange:c,toggle:m=>o(se,{ref:m,onClick:c,variant:e||"primary",isDisabled:s,"data-testid":"add-role-mapping-button",children:r(t||"assignRole")}),isOpen:i,...l,children:k(ne,{children:[o(P,{"data-testid":"client-role",component:"button",onClick:()=>{n("clients")},children:r("clientRoles")}),h&&o(P,{"data-testid":"roles-role",component:"button",onClick:()=>{n("roles")},children:r("realmRoles")})]})})},be=({id:t,name:e,type:s,isRadio:n,filterType:l,onAssign:r,onClose:i,title:c,actionLabel:u})=>{const{adminClient:h}=j(),{t:m}=D(),[R,b]=M([]),A=ge(),B=({role:{name:g}})=>g?.toUpperCase(),I=async(g,f,C)=>{const v={first:g,max:f};C&&(v.search=C);const d=await Ce(h,s,{...v,id:t});return A(d,B).map(a=>({role:a.role,id:a.role.id}))},E=async(g,f,C)=>{const v=await ve(h,{id:t,type:s,first:g||0,max:f||10,search:C});return A(v.map(d=>({client:{clientId:d.client,id:d.clientId},role:{id:d.id,name:d.role,description:d.description},id:d.id})),({client:{clientId:d},role:{name:x}})=>`${d}${x}`)},S=[{name:"role.name",displayKey:"name",transforms:[Q(30)]},{name:"client.clientId",displayKey:"clientId"},{name:"role.description",displayKey:"description",cellRenderer:ye}];return l==="roles"&&S.splice(1,1),o(G,{variant:J.large,title:c||m("assignRolesTo",{type:m(l==="roles"?"realm":"client"),client:e}),isOpen:!0,onClose:i,actions:[o(U,{"data-testid":"assign",isDisabled:R.length===0,variant:"primary",onClick:()=>{r(R),i()},children:u||m("assign")},"confirm"),o(U,{"data-testid":"cancel",variant:"link",onClick:i,children:m("cancel")},"cancel")],children:o(H,{onSelect:g=>b([...g]),searchPlaceholderKey:l==="roles"?"searchByRoleName":"search",isPaginated:!(l==="roles"&&s!=="roles"),canSelectAll:!0,isRadio:n,loader:l==="roles"?I:E,ariaLabelKey:"associatedRolesText",columns:S,emptyState:o(W,{message:m("noRoles"),instructions:m("noRealmRolesToAssign")})})})},Ae=(t,e,s)=>[...s?t.map(n=>({id:n.role.id,...n,role:{...n.role,isInherited:!1}})):e.map(n=>({id:n.role.id,...n,role:{...n.role,isInherited:t.find(l=>l.role.id===n.role.id)===void 0}}))],Ie=({role:t,client:e})=>k(K,{children:[e?.clientId&&o(le,{isRead:!0,className:"keycloak-admin--role-mapping__client-name",children:e.clientId}),t.name]}),Ee=({name:t,id:e,type:s,isManager:n=!0,save:l})=>{const{adminClient:r}=j(),{t:i}=D(),{addAlert:c,addError:u}=ae(),[h,m]=M(0),R=()=>m(h+1),[b,A]=M(!0),[B,I]=M(!1),[E,S]=M("clients"),[g,f]=M([]),C=async a=>{await l(a),R()},v=async()=>{let a=[],w=[];b||(a=await he(r,s,e),w=(await Me(r,{type:s,id:e})).map(p=>({client:{clientId:p.client,id:p.clientId},role:{id:p.id,name:p.role,description:p.description}})),a=a.filter(p=>!w.some(T=>T.role.id===p.role.id)));const q=await fe(r,s,e),Y=q.realmMappings?.map(p=>({role:p}))||[],z=Object.values(q.clientMappings||{}).map(p=>p.mappings.map(T=>({client:{clientId:p.client,...p},role:T}))).flat();return[...Ae([...z,...Y],[...w,...a],b)]},[d,x]=me({titleKey:"removeMappingTitle",messageKey:i("removeMappingConfirm",{count:g.length}),continueButtonLabel:"remove",continueButtonVariant:oe.danger,onCancel:()=>{f([]),R()},onConfirm:async()=>{try{await Promise.all(Re(r,s,e,g)),c(i("roleMappingUpdatedSuccess"),re.success),f([]),R()}catch(a){u("roleMappingUpdatedError",a)}}});return k(K,{children:[B&&o(be,{id:e,type:s,filterType:E,name:t,onAssign:C,onClose:()=>I(!1)}),o(x,{}),o(H,{"data-testid":"assigned-roles",loader:v,canSelectAll:!0,onSelect:a=>f(a),searchPlaceholderKey:"searchByName",ariaLabelKey:"roleList",isRowDisabled:a=>a.role.isInherited||!1,toolbarItem:k(K,{children:[o($,{children:o(pe,{label:i("hideInheritedRoles"),id:"hideInheritedRoles","data-testid":"hideInheritedRoles",isChecked:b,onChange:(a,w)=>{A(w),R()}})}),n&&k(K,{children:[o($,{children:o(_,{onFilerTypeChange:a=>{S(a),I(!0)}})}),o($,{children:o(U,{variant:"link","data-testid":"unAssignRole",onClick:d,isDisabled:g.length===0,children:i("unAssignRole")})})]})]}),actions:n?[{title:i("unAssignRole"),onRowClick:async a=>(f([a]),d(),!1)}]:[],columns:[{name:"role.name",displayKey:"name",transforms:[Q(30)],cellRenderer:Ie},{name:"role.isInherited",displayKey:"inherent",cellFormatters:[ce(),de()]},{name:"role.description",displayKey:"description",cellFormatters:[X(i)]}],emptyState:o(W,{message:i(`noRoles-${s}`),instructions:i(`noRolesInstructions-${s}`),secondaryActions:[{text:i("showInheritedRoles"),onClick:()=>{A(!1),R()}}],children:o(_,{onFilerTypeChange:a=>{S(a),I(!0)}})})},`${e}${h}`)]})};export{be as A,Ee as R,Ie as S,_ as a,Fe as b,Be as f};
//# sourceMappingURL=RoleMapping-BOcI-Nkp.js.map
