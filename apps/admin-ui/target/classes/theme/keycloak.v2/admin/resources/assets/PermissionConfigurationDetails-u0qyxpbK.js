import{jsx as e,jsxs as S,Fragment as U}from"react/jsx-runtime";import{u as M,d as ce,a as z,j as J,_ as W,N as le,M as Q,k as $,F as pe,l as X,Q as j,U as de,A as Y,g as E,B as V,H as me,I as ye,J as ue,o as B,C as Z,y as K,x as ee,e6 as ge,v as ie,aM as se,aN as te,D as L,al as oe,b8 as ne,a0 as Pe,O as fe,R as he,a7 as ve,W as Ce,b as Te,dU as G,p as Se,P as we,L as be,e7 as xe}from"./main-o1hptXRo.js";import{useEffect as Ae,useState as x,useMemo as Fe}from"react";import{u as Ie}from"./ConfirmDialog-BkU7melV.js";import{F as Oe}from"./FormAccess-BnhQnYb9.js";import{V as De}from"./ViewHeader-BDBsroi3.js";import{u as ke}from"./useParams-CGVhlaFZ.js";import{L as Ee,a as Ne}from"./policyRepresentation-CscDyJFY.js";import{L as Ve,G as _,J as Le,T as Re,a as Ke,b as Me,C as ze,c as Be,d as He,e as Ue,f as qe}from"./NewPolicyDialog-CIlfdiTN.js";import{c as R}from"./capitalize-_YB1UYl_.js";import{s as q}from"./sortBy-DjlFeX8O.js";import{F as re}from"./filter-icon-DYNmdQ7O.js";import{S as je}from"./ScopePicker-Ba7ikc0T.js";import{u as Ge,R as _e}from"./useSortedResourceTypes-DOYOPDde.js";import"react-dom";import"./useIsAdminPermissionsClient-BY-AG4cQ.js";import"./useLocaleSort-C-diWts5.js";import"./ClientSelect-BY77LEpN.js";import"./ClientScopeTypes-D2w5c8Pp.js";import"./utils-C-TUnOch.js";import"./GroupPickerDialog-U3luvxlw.js";import"./DataListItemRow-B_0B-ko6.js";import"./CodeEditor-C4IS5oxi.js";import"./SwitchControl-CU1bUhmR.js";import"./RoleMapping-BOcI-Nkp.js";import"./translationFormatter-DQJeO7lr.js";import"./DatePicker-DiXxo4Fo.js";import"./debounce-Dbkg0MD5.js";import"./_baseSlice-F8doVSIJ.js";import"./_baseFlatten-BLlCkxtA.js";const Je={name:"",description:"",type:"group",policies:[],decisionStrategy:Ne.UNANIMOUS,logic:Ee.POSITIVE},H={aggregate:Ue,client:He,user:Be,"client-scope":ze,group:_,regex:Me,role:Ke,time:Re,js:Le,default:_},We=r=>r in H,Qe=({permissionClientId:r,providers:l,policies:b,toggleDialog:t,onAssign:n})=>{const{adminClient:o}=M(),{realmRepresentation:A}=ce(),{t:p}=z(),u=J({mode:"onChange",defaultValues:Je}),{addAlert:F,addError:k}=W(),{handleSubmit:T,reset:v}=u,I=A?.adminPermissionsEnabled,P=le({control:u.control,name:"type"});function a(){return P&&We(P)?H[P]:H.default}const m=a();Ae(()=>{if(P){const{name:c,description:C,decisionStrategy:O,logic:w}=u.getValues();v({type:P,name:c,description:C,decisionStrategy:O,logic:w})}},[P,v,u]);const y=async c=>{const{groups:C,roles:O,policies:w,clients:D,...s}=c,g={...s,...C&&C.length>0&&{groups:C},...O&&O.length>0&&{roles:O},...w&&w.length>0&&{policies:w},...D&&D.length>0&&{clients:D},...s.type==="group"&&(!C||C.length===0)&&{groups:[]},...s.type==="client"&&(!D||D.length===0)&&{clients:[]}};try{const d=await o.clients.createPolicy({id:r,type:P},g);n(d),t(),F(p("createPolicySuccess"),B.success)}catch(d){k("policySaveError",d)}};return e(Q,{"aria-label":p("createPermissionPolicy"),variant:$.medium,header:e(me,{children:e(ye,{component:ue.h1,children:p("createPermissionPolicy")})}),isOpen:!0,onClose:t,children:S(pe,{id:"createPermissionPolicy-form",onSubmit:async c=>{c.stopPropagation(),await T(y)(c)},isHorizontal:!0,children:[S(X,{...u,children:[e(j,{name:"name",label:p("name"),rules:{required:p("required")}}),e(j,{name:"description",label:p("description")}),l&&l.length>0&&e(de,{name:"type",label:p("policyType"),labelIcon:p("policyTypeHelpText"),options:l.map(c=>({key:c.type,value:R(c.type)})),controller:{defaultValue:""}}),e(m,{isPermissionClient:I,permissionClientId:r}),e(Ve,{})]}),e(Y,{children:S("div",{className:"pf-v5-u-mt-md",children:[e(E,{variant:V.primary,className:"pf-v5-u-mr-md",type:"submit","data-testid":"save",isDisabled:b?.length===0&&P==="aggregate",children:p("save")}),e(E,{variant:"link","data-testid":"cancel",onClick:t,children:p("cancel")})]})})]})})},$e=({toggleDialog:r,onAssign:l,open:b,permissionClientId:t})=>{const{t:n}=z(),{adminClient:o}=M(),[A,p]=x([]),[u,F]=x(void 0),[k,T]=Z(),[v,I]=x([]);K(()=>o.clients.listPolicyProviders({id:t}),a=>{const m=a.filter(y=>y.type!=="resource"&&y.type!=="scope").map(y=>y.name).filter(y=>y!==void 0);I(q(m))},[t]);const P=async(a,m,y)=>{const c={id:t,permission:"false",first:a,max:m};return y&&(c.name=y),u&&(c.type=u),await o.clients.listPolicies(c)||[]};return e(Q,{variant:$.medium,title:n("assignExistingPolicies"),isOpen:b,onClose:r,actions:[S(U,{children:[e(E,{id:"modal-assignExistingPolicies","data-testid":"confirm",variant:V.primary,onClick:()=>{const a=A.map(m=>({policy:m}));l(a),r()},isDisabled:A.length===0,children:n("assign")},"assign"),e(E,{id:"modal-cancelExistingPolicies","data-testid":"cancel",variant:V.link,onClick:()=>{p([]),r()},children:n("cancel")},"cancel")]})],children:e(ee,{loader:P,ariaLabelKey:n("chooseAPolicyType"),searchPlaceholderKey:n("searchClientAuthorizationPolicy"),isSearching:!0,searchTypeComponent:e(se,{onSelect:(a,m)=>{F(m),T()},onOpenChange:T,toggle:a=>e(oe,{ref:a,"data-testid":"filter-type-dropdown-existingPolicies",id:"toggle-id-10",onClick:T,icon:e(re,{}),statusIcon:e(ne,{}),children:u||n("allTypes")}),isOpen:k,children:S(te,{children:[e(L,{"data-testid":"filter-type-dropdown-existingPolicies-all",onClick:()=>F(void 0),children:n("allTypes")},"all"),v.map(a=>e(L,{"data-testid":`filter-type-dropdown-existingPolicies-${a}`,onClick:()=>F(a),children:a},a))]})}),canSelectAll:!0,onSelect:a=>p(a),columns:[{name:"name"},{name:"type",cellFormatters:[ge()]},{name:"description"}],emptyState:e(ie,{message:n("emptyAssignExistingPolicies"),instructions:n("emptyAssignExistingPoliciesInstructions")})},u)})},Xe=({permissionClientId:r,providers:l,policies:b,resourceType:t})=>{const{adminClient:n}=M(),{t:o}=z(),{control:A,getValues:p,setValue:u,trigger:F,formState:{errors:k}}=Pe(),T=p("policies"),[v,I]=x(!1),[P,a]=x(!1),[m,y]=x([]),[c,C]=x(void 0),[O,w]=Z();K(()=>T&&T.length>0?Promise.all(T.map(i=>n.clients.findOnePolicyWithType({id:r,type:i.type,policyId:i.id}))):Promise.resolve([]),i=>{const f=i.filter(h=>h);y(f)},[b]);const D=q(l?l.filter(i=>i.type!=="resource"&&i.type!=="scope").map(i=>i.name):[]),s=async i=>{const f=i.map(({policy:h})=>({id:h.id}));u("policies",[...p("policies")||[],...f]),await F("policies"),y([...m,...i.map(({policy:h})=>h)])},g=i=>{const f=m.filter(h=>h.id!==i.id);y(f),u("policies",f.map(h=>({id:h.id,name:h.name,type:h.type,description:h.description})))},d=c?m.filter(i=>R(i.type)===c):m;return S(fe,{label:o("policies"),labelIcon:e(Ce,{helpText:o("permissionPoliciesHelp"),fieldLabelId:"policies"}),fieldId:"policies",isRequired:!0,children:[e(he,{name:"policies",control:A,defaultValue:[],rules:{validate:i=>!i||i.length===0?!1:i.every(({id:f})=>f&&f.trim().length>0)},render:()=>S(U,{children:[v&&e($e,{permissionClientId:r,open:v,toggleDialog:()=>I(!v),onAssign:s}),P&&e(Qe,{toggleDialog:()=>a(!P),permissionClientId:r,providers:l,policies:b,resourceType:t,onAssign:async i=>{await s([{policy:i}])}}),e(E,{"data-testid":"select-assignedPolicy-button",variant:"secondary",onClick:()=>{I(!0)},children:o("assignExistingPolicies")}),e(E,{"data-testid":"select-createNewPolicy-button",className:"pf-v5-u-ml-md",variant:"secondary",onClick:()=>{a(!0)},children:o("createNewPolicy")})]})}),m.length>0&&e(ee,{loader:d,ariaLabelKey:o("policies"),searchPlaceholderKey:o("searchClientAuthorizationPolicy"),isSearching:!0,searchTypeComponent:e(se,{onSelect:(i,f)=>{C(f),w()},onOpenChange:w,toggle:i=>e(oe,{ref:i,"data-testid":"filter-type-dropdown-existingPolicies",id:"toggle-id-10",onClick:w,icon:e(re,{}),statusIcon:e(ne,{}),children:c?R(c):o("allTypes")}),isOpen:O,children:S(te,{children:[e(L,{"data-testid":"filter-type-dropdown-existingPolicies-all",onClick:()=>C(void 0),children:o("allTypes")},"all"),D.map(i=>e(L,{"data-testid":`filter-type-dropdown-existingPolicies-${i}`,onClick:()=>C(i),children:i},i))]})}),actionResolver:i=>[{title:o("unAssignPolicy"),onClick:()=>g(i.data)}],columns:[{name:"name",displayKey:o("name")},{name:"type",displayKey:o("type"),cellFormatters:[i=>R(String(i||""))]},{name:"description",displayKey:o("description")}],emptyState:e(ie,{message:o("emptyAssignExistingPolicies"),instructions:o("emptyAssignExistingPoliciesInstructions")})}),k.policies&&e(ve,{message:o("requiredPolicies")})]})};function Ii(){const{adminClient:r}=M(),{t:l}=z(),{realm:b,permissionClientId:t,permissionId:n,resourceType:o}=ke(),A=Te(),p=J(),{handleSubmit:u,reset:F}=p,{addAlert:k,addError:T}=W(),[v,I]=x(),[P,a]=x(),[m,y]=x(),c=Ge({clientId:t}),C=Fe(()=>c.filter(({type:s})=>s===o).flatMap(({scopes:s=[]})=>s).map(s=>s||""),[c,o]);K(async()=>{if(!t)return{};const[s,g]=await Promise.all([r.clients.listPolicyProviders({id:t}),r.clients.listPolicies({id:t,permission:"false"})]);return{providers:s,policies:g}},({providers:s,policies:g})=>{const d=s?.filter(i=>i.type!=="resource"&&i.type!=="scope");a(q(d,i=>i.type)),y(g||[])},[t]),K(async()=>{if(!n)return{};const[s,g,d,i]=await Promise.all([r.clients.findOnePermission({id:t,type:"scope",permissionId:n}),r.clients.getAssociatedResources({id:t,permissionId:n}),r.clients.getAssociatedPolicies({id:t,permissionId:n}),r.clients.getAssociatedScopes({id:t,permissionId:n})]);if(!s)throw new Error(l("notFound"));return{permission:s,resources:g,policies:d,scopes:i}},({permission:s,resources:g,policies:d,scopes:i})=>{const f=g?.map(N=>N.name)||[],h=d?.map(N=>N.id)||[],ae=i?.map(N=>N.name)||[];F({...s,resources:f,policies:d,scopes:i}),I({...s,resources:f,policies:h,scopes:ae})},[t,n]);const O=async s=>{try{const g={...s,policies:s.policies?.map(d=>d.id),scopes:s.scopes?.map(d=>d.name),resourceType:o};if(n)await r.clients.updatePermission({id:t,type:"scope",permissionId:n},g);else{const d=await r.clients.createPermission({id:t,type:"scope"},g);I(d),A(xe({realm:b,permissionClientId:t,permissionId:d.id,resourceType:o}))}k(l(n?"updatePermissionSuccess":"createPermissionSuccess"),B.success)}catch(g){T("permissionSaveError",g)}},[w,D]=Ie({titleKey:"deletePermission",messageKey:l("deleteAdminPermissionConfirm",{permission:v?.name}),continueButtonVariant:V.danger,continueButtonLabel:"confirm",onConfirm:async()=>{try{await r.clients.delPermission({id:t,type:"scope",permissionId:n}),k(l("permissionDeletedSuccess"),B.success),A(G({realm:b,permissionClientId:t,tab:"permissions"}))}catch(s){T("permissionDeletedError",s)}}});return v?S(U,{children:[e(D,{}),e(De,{titleKey:n?v?.name:l("createPermission"),subKey:n?v?.description:l("createPermissionOfType",{resourceType:o}),dropdownItems:n?[e(L,{"data-testid":"delete-permission",onClick:()=>w(),children:l("delete")},"delete")]:void 0}),e(we,{variant:"light",children:S(Oe,{isHorizontal:!0,onSubmit:u(O),role:"anyone",children:[S(X,{...p,children:[e(qe,{clientId:t}),e(je,{clientId:t,resourceTypeScopes:C??[]}),e(_e,{resourceType:o}),e(Xe,{permissionClientId:t,providers:P,policies:m,resourceType:o})]}),e(Y,{children:S("div",{className:"pf-v5-u-mt-md",children:[e(E,{variant:V.primary,className:"pf-v5-u-mr-md",type:"submit","data-testid":"save",children:l("save")}),e(E,{variant:"link","data-testid":"cancel",component:s=>e(be,{...s,to:G({realm:b,permissionClientId:t,tab:"permissions"})}),children:l("cancel")})]})})]})})]}):e(Se,{})}export{Ii as default};
//# sourceMappingURL=PermissionConfigurationDetails-u0qyxpbK.js.map
