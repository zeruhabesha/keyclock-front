import{jsx as e,jsxs as y,Fragment as Y}from"react/jsx-runtime";import{d8 as bt,cN as yt,f3 as Ct,f4 as vt,dw as wt,f5 as It,f6 as kt,f7 as Tt,u as Z,a as z,M as We,k as Fe,x as Ie,bF as Pt,g as N,c as Dt,b as it,_ as de,d as Pe,C as Me,y as ke,e6 as Lt,B as he,dP as ot,e4 as At,v as Be,T as Ee,aM as dt,aN as lt,D as Te,al as ct,L as mt,cR as St,a0 as Et,P as fe,cz as Ve,o as X,aX as $,aY as Ue,Y as xt,Z as Rt,aQ as je,dA as Ut,bo as qe,ay as ge,aK as W,aR as He,aP as M,a_ as Ot,j as De,F as Ke,O as Ne,a3 as ut,eP as Mt,di as Nt,N as Ft,l as ze,f8 as Bt,bJ as Xe,a7 as Ze,p as pt,aa as Kt,W as zt,bl as et,aA as Ge,am as Gt,aS as $e,cc as Vt,E as jt,f9 as qt,cB as Ht,Q as tt,e as _t,bP as rt,H as xe,I as Re,cD as Wt,c5 as $t,at as _e,cK as Jt,an as Qt,ao as Yt,bT as Xt,aL as Zt,bS as er,z as tr,G as at}from"./main-o1hptXRo.js";import{useState as u,useMemo as ht,useRef as rr,Fragment as ar}from"react";import{u as pe,C as gt}from"./ConfirmDialog-BkU7melV.js";import{u as ue,R as sr}from"./RoutableTabs-DyhWhd6v.js";import{V as nr}from"./ViewHeader-BDBsroi3.js";import{U as ir}from"./UserProfileContext-DwkKusZd.js";import{u as Je}from"./useParams-CGVhlaFZ.js";import{d as or}from"./differenceBy-LE-r3AO1.js";import{S as dr,C as lr}from"./SearchInputComponent-D_sKM8QK.js";import{A as cr}from"./AttributeForm-DTyI1Rh5.js";import{a as Oe,R as mr,F as ur,f as pr,U as hr,t as gr}from"./UserForm-BECrTAgu.js";import{U as fr}from"./userProfileMetadata-CFgHgJ2w.js";import{u as Qe}from"./useFormatDate-CuGjRZ4j.js";import{s as ft}from"./sortBy-DjlFeX8O.js";import{C as br,S as yr,i as Cr}from"./SessionsTable-4N_7uyd-.js";import{u as vr}from"./useLocaleSort-C-diWts5.js";import{P as wr}from"./pencil-alt-icon-pqpZW-gk.js";import{T as Ir}from"./TimeSelectorControl-B1N9IKgG.js";import{D as kr}from"./SwitchControl-CU1bUhmR.js";import{G as Tr,a as Pr}from"./GroupPickerDialog-U3luvxlw.js";import{Q as Dr}from"./question-circle-icon-C0dl_LB7.js";import{c as ye}from"./capitalize-_YB1UYl_.js";import{R as Lr}from"./RoleMapping-BOcI-Nkp.js";import{U as Ar}from"./UserEvents-CCx8BrF_.js";/* empty css                     */import{A as Sr}from"./AdminEvents-DIrkh5pf.js";import{a as ae,b as se,T as Er}from"./Tabs-DSwQhKoJ.js";import"react-dom";import"./PageHandler-B1ed5nYb.js";import"./DynamicComponents-CnLlz98z.js";import"./ClientSelect-BY77LEpN.js";import"./IdentityProviderSelect-rmWlUbIg.js";import"./ActionListItem-Cy-NQlq4.js";import"./MultiLineInput-OP0faqms.js";import"./CodeEditor-C4IS5oxi.js";import"./constants-BclHbWtx.js";import"./_baseFlatten-BLlCkxtA.js";import"./FormAccess-BnhQnYb9.js";import"./KeyValueInput-BOsiIUR1.js";import"./CopyToClipboardButton-Cl576S4v.js";import"./TimeSelector-1gdltitc.js";import"./DataListItemRow-B_0B-ko6.js";import"./_baseSlice-F8doVSIJ.js";import"./translationFormatter-DQJeO7lr.js";import"./DropdownPanel-vRJu3PnV.js";import"./warning-triangle-icon-Cc02WUGl.js";import"./pickBy-JGveacY0.js";import"./DatePicker-DiXxo4Fo.js";import"./DescriptionListTerm-CNzJUZBE.js";var xr="[object Map]",Rr="[object Set]",Ur=Object.prototype,Or=Ur.hasOwnProperty;function st(t){if(t==null)return!0;if(bt(t)&&(yt(t)||typeof t=="string"||typeof t.splice=="function"||Ct(t)||vt(t)||wt(t)))return!t.length;var a=It(t);if(a==xr||a==Rr)return!t.size;if(kt(t))return!Tt(t).length;for(var s in t)if(Or.call(t,s))return!1;return!0}const Mr=({isJoin:t=!0,existingOrgs:a,onAdd:s,onClose:n})=>{const{adminClient:h}=Z(),{t:i}=z(),[l,f]=u([]),m=async(c,p,d)=>{const k={first:c,search:d,max:p+a.length},T=await h.organizations.find(k);return or(T,a,"id")};return e(We,{variant:Fe.small,title:i(t?"joinOrganization":"sendInvitation"),isOpen:!0,onClose:n,actions:[e(N,{"data-testid":"join",variant:"primary",onClick:async()=>{await s(l),n()},children:i(t?"join":"send")},"confirm"),e(N,{"data-testid":"cancel",variant:"link",onClick:n,children:i("cancel")},"cancel")],children:e(Ie,{loader:m,isPaginated:!0,ariaLabelKey:"organizationsList",searchPlaceholderKey:"searchOrganization",canSelectAll:!0,onSelect:c=>f([...c]),columns:[{name:"name",displayKey:"organizationName"},{name:"description",cellRenderer:c=>e(Pt,{wrapModifier:"truncate",children:c.description})}]})})},Nr=({user:t})=>{const{adminClient:a}=Z(),{t:s}=z(),{id:n}=Dt(),h=it(),{addAlert:i,addError:l}=de(),{realm:f}=Pe(),[m,c]=u(0),p=()=>c(m+1),[d,k,T]=Me(),[S,I]=u(!0),[C,U]=u(!1),[G,ee]=u([]),[H,V]=u([]),[_,J]=u(""),[E,O]=u(""),[o,R]=u([]),[K,P]=u(!1),ne=[{value:"Managed",label:"Managed"},{value:"Unmanaged",label:"Unmanaged"}],Q=()=>{P(!K)},g=(L,F)=>{o.includes(F)?R(o.filter(q=>q!==F)):R([...o,F]),P(!1),p()};ke(async()=>{const L=await a.organizations.memberOrganizations({userId:n});let q=await Promise.all(L.map(async le=>{const ie=le.id,we=(await a.organizations.listMembers({orgId:ie})).filter(ce=>ce.username===t.username).map(ce=>Lt()(ce.membershipType));return{...le,membershipType:we}}));return o.length>0&&(q=q.filter(le=>le.membershipType?.some(ie=>o.includes(ie)))),E&&(q=q.filter(le=>le.name?.toLowerCase().includes(E.toLowerCase()))),q},ee,[m,o,E]);const x=L=>{J(L)},B=()=>{O(_),p()},j=()=>{J(""),O(""),p()},[be,Ce]=pe({titleKey:"removeConfirmOrganizationTitle",messageKey:s("organizationRemoveConfirm",{count:H.length}),continueButtonLabel:"remove",continueButtonVariant:he.danger,onConfirm:async()=>{try{await Promise.all(H.map(F=>a.organizations.delMember({orgId:F.id,userId:n}))),i(s("organizationRemovedSuccess")),await a.users.findOne({id:n})||h(ot({realm:f})),V([]),p()}catch(L){l("organizationRemoveError",L)}}});return y(Y,{children:[C&&e(Mr,{isJoin:S,existingOrgs:G,onClose:()=>U(!1),onAdd:async L=>{try{await Promise.all(L.map(F=>{const q=new FormData;return q.append("id",n),S?a.organizations.addMember({orgId:F.id,userId:`"${t.id}"`}):a.organizations.inviteExistingUser({orgId:F.id},q)})),i(s(S?"userAddedOrganization":"userInvitedOrganization",{count:L.length})),p()}catch(F){l(S?"userAddedOrganizationError":"userInvitedError",F)}}}),e(Ce,{}),e(At,{link:({organization:L,children:F})=>e(mt,{to:St({realm:f,id:L.id,tab:"settings"}),children:F},L.id),loader:G,isSearching:E.length>0||o.length>0,onSelect:L=>V(L),deleteLabel:"remove",onDelete:L=>{V([L]),be()},toolbarItem:y(Y,{children:[e(Ee,{children:e(dr,{value:_,placeholder:s("searchMembers"),onChange:x,onSearch:B,onClear:j,"aria-label":s("searchMembers")})}),e(Ee,{children:e(dt,{onOpenChange:T,toggle:L=>e(ct,{ref:L,id:"toggle-id",onClick:k,variant:"primary",children:s("joinOrganization")}),isOpen:d,children:y(lt,{children:[e(Te,{onClick:()=>{I(!0),U(!0)},children:s("joinOrganization")},"join"),e(Te,{onClick:()=>{I(!1),U(!0)},children:s("sendInvite")},"invite")]})})}),e(Ee,{children:e(N,{"data-testid":"removeOrganization",variant:"secondary",isDisabled:H.length===0,onClick:()=>be(),children:s("remove")})}),e(Ee,{children:e(lr,{filterPlaceholderText:s("filterByMembershipType"),isOpen:K,options:ne,onOpenChange:L=>P(L),onToggleClick:Q,onSelect:g,selectedItems:o,width:"260px"})})]}),children:e(Be,{message:s("emptyUserOrganizations"),instructions:s("emptyUserOrganizationsInstructions"),secondaryActions:[{text:s("joinOrganization"),onClick:()=>{I(!0),U(!0)}},{text:s("sendInvitation"),onClick:()=>{I(!1),U(!0)}}]})})]})},Fr=({user:t,save:a,upConfig:s})=>{const n=Et();return e(fe,{variant:Ve.light,children:e(cr,{form:n,save:a,fineGrainedAccess:t.access?.manage,reset:()=>n.reset({...n.getValues(),attributes:Oe(t).attributes}),name:"unmanagedAttributes",isDisabled:fr.AdminView==s?.unmanagedAttributePolicy})})},Br=()=>{const{adminClient:t}=Z(),[a,s]=u(),{t:n}=z(),{addAlert:h,addError:i}=de(),l=Qe(),[f,m]=u(0),{id:c}=Je(),p=C=>ft(C,U=>U.clientId?.toUpperCase()),d=()=>m(new Date().getTime()),k=async()=>{const C=await t.users.listConsents({id:c});return p(C)},T=({grantedClientScopes:C})=>e(xt,{className:"kc-consents-chip-group",children:C.map(U=>e(Rt,{isReadOnly:!0,className:"kc-consents-chip",children:U},U))}),[S,I]=pe({titleKey:"revokeClientScopesTitle",messageKey:n("revokeClientScopes",{clientId:a?.clientId}),continueButtonLabel:"revoke",continueButtonVariant:he.danger,onConfirm:async()=>{try{await t.users.revokeConsent({id:c,clientId:a.clientId}),d(),h(n("deleteGrantsSuccess"),X.success)}catch(C){i("deleteGrantsError",C)}}});return y(Y,{children:[e(I,{}),e(Ie,{loader:k,ariaLabelKey:"roleList",searchPlaceholderKey:" ",columns:[{name:"clientId",displayKey:"Client",cellFormatters:[Ue()],transforms:[$(20)]},{name:"grantedClientScopes",displayKey:"grantedClientScopes",cellRenderer:T,transforms:[$(30)]},{name:"createdDate",displayKey:"created",transforms:[$(20)],cellRenderer:({createdDate:C})=>C?l(new Date(C)):"—"},{name:"lastUpdatedDate",displayKey:"lastUpdated",transforms:[$(10)],cellRenderer:({lastUpdatedDate:C})=>C?l(new Date(C)):"—"}],actions:[{title:n("revoke"),onRowClick:C=>{s(C),S()}}],emptyState:e(Be,{hasIcon:!0,icon:br,message:n("noConsents"),instructions:n("noConsentsText")})},f)]})},Kr=({title:t,credentialData:a,onClose:s})=>{const{t:n}=z();return e(We,{variant:Fe.medium,title:t,"data-testid":"passwordDataDialog",isOpen:!0,onClose:s,children:y(je,{"aria-label":t,"data-testid":"password-data-dialog",variant:Ut.compact,children:[e(qe,{children:y(ge,{children:[e(W,{children:n("showPasswordDataName")}),e(W,{children:n("showPasswordDataValue")})]})}),e(He,{children:a.map((h,i)=>y(ge,{children:[e(M,{children:h[0]}),e(M,{children:h[1]})]},i))})]})})},zr=({credential:t,resetPassword:a,toggleDelete:s,children:n})=>{const h=Qe(),{t:i}=z(),[l,f]=Me(),[m,c]=Me(),p=vr(),d=ht(()=>{if(!t.credentialData)return[];const k=JSON.parse(t.credentialData);return p(Object.entries(k),([T])=>T).map(([T,S])=>typeof S=="string"?[T,S]:[T,JSON.stringify(S)])},[t.credentialData]);return y(Y,{children:[l&&Object.keys(t).length!==0&&e(Kr,{title:t.userLabel||i("passwordDataTitle"),credentialData:d,onClose:()=>{f()}}),e(M,{children:n}),e(M,{children:h(new Date(t.createdDate))}),e(M,{children:e(N,{className:"kc-showData-btn",variant:"link","data-testid":"showDataBtn",onClick:f,children:i("showDataBtn")})}),t.type==="password"?e(M,{isActionCell:!0,children:e(N,{variant:"secondary","data-testid":"resetPasswordBtn",onClick:a,children:i("resetPasswordBtn")})}):e(M,{}),e(M,{isActionCell:!0,children:e(dt,{popperProps:{position:"right"},onOpenChange:c,toggle:k=>e(ct,{ref:k,isExpanded:m,onClick:c,variant:"plain","aria-label":"Kebab toggle",children:e(Ot,{})}),isOpen:m,children:e(lt,{children:e(Te,{"data-testid":"deleteDropdownItem",component:"button",onClick:()=>{s(),c()},children:i("deleteBtn")},t.id)})})})]})},Gr=({userId:t,credential:a,isEditable:s,toggle:n})=>{const{adminClient:h}=Z(),{t:i}=z(),{register:l,handleSubmit:f}=De(),{addAlert:m,addError:c}=de();return e(Ke,{isHorizontal:!0,className:"kc-form-userLabel",onSubmit:f(async d=>{try{await h.users.updateCredentialLabel({id:t,credentialId:a.id},d.userLabel||""),m(i("updateCredentialUserLabelSuccess"),X.success),n()}catch(k){c("updateCredentialUserLabelError",k)}}),children:e(Ne,{fieldId:"kc-userLabel",className:"kc-userLabel-row",children:e("div",{className:"kc-form-group-userLabel",children:s?y(Y,{children:[e(ut,{"data-testid":"userLabelFld",defaultValue:a.userLabel,className:"kc-userLabel","aria-label":i("userLabel"),...l("userLabel")}),y("div",{className:"kc-userLabel-actionBtns",children:[e(N,{"data-testid":"editUserLabelAcceptBtn",variant:"link",className:"kc-editUserLabelAcceptBtn","aria-label":i("acceptBtn"),type:"submit",icon:e(Mt,{})}),e(N,{"data-testid":"editUserLabelCancelBtn",variant:"link",className:"kc-editUserLabel-cancelBtn","aria-label":i("cancelBtn"),onClick:n,icon:e(Nt,{})})]})]}):y(Y,{children:[a.userLabel,e(N,{"aria-label":i("editUserLabel"),variant:"link",className:"kc-editUserLabel-btn",onClick:n,"data-testid":"editUserLabelBtn",icon:e(wr,{})})]})})})})},Vr=()=>{const{t}=z();return e(Ir,{name:"lifespan",label:t("lifespan"),labelIcon:t("lifespanHelp"),units:["minute","hour","day"],menuAppendTo:"parent",controller:{}})},jr=({userId:t,onClose:a})=>{const{adminClient:s}=Z(),{realmRepresentation:n}=Pe(),{t:h}=z(),i=De({defaultValues:{actions:[],lifespan:n?.actionTokenGeneratedByAdminLifespan}}),{handleSubmit:l,control:f}=i,m=Ft({control:f,name:"actions"}),c=!st(m),{addAlert:p,addError:d}=de(),k=async({actions:T,lifespan:S})=>{if(!st(T))try{await s.users.executeActionsEmail({id:t,actions:T,lifespan:S}),p(h("credentialResetEmailSuccess"),X.success),a()}catch(I){d("credentialResetEmailError",I)}};return e(gt,{variant:Fe.medium,titleKey:"credentialReset",open:!0,onCancel:a,toggleDialog:a,continueButtonLabel:"credentialResetConfirm",onConfirm:async()=>{await l(k)()},confirmButtonDisabled:!c,children:e(Ke,{id:"userCredentialsReset-form",isHorizontal:!0,"data-testid":"credential-reset-modal",children:y(ze,{...i,children:[e(mr,{name:"actions",label:"resetAction",help:"resetActions"}),e(Vr,{})]})})})},qr={password:"",passwordConfirmation:"",temporaryPassword:!0},Hr=({user:t,isResetPassword:a,onAddRequiredActions:s,refresh:n,onClose:h})=>{const{adminClient:i}=Z(),{t:l}=z(),f=De({defaultValues:qr,mode:"onChange"}),{register:m,formState:{isValid:c,errors:p},watch:d,handleSubmit:k,clearErrors:T,setError:S}=f,[I,C]=Me(!0),U=d("password",""),G=d("passwordConfirmation",""),{addAlert:ee,addError:H}=de(),[V,_]=pe({titleKey:a?"resetPasswordConfirm":"setPasswordConfirm",messageKey:a?l("resetPasswordConfirmText",{username:t.username}):l("setPasswordConfirmText",{username:t.username}),continueButtonLabel:a?"resetPassword":"savePassword",continueButtonVariant:he.danger,onConfirm:()=>k(J)()}),J=async({password:o,temporaryPassword:R})=>{try{await i.users.resetPassword({id:t.id,credential:{temporary:R,type:"password",value:o}}),R&&s?.([Bt.UPDATE_PASSWORD]);const P=(await i.users.getCredentials({id:t.id})).find(Q=>Q.type==="password");P&&P.federationLink===void 0&&await i.users.updateCredentialLabel({id:t.id,credentialId:P.id},l("defaultPasswordLabel")),ee(l(a?"resetCredentialsSuccess":"savePasswordSuccess"),X.success),n()}catch(K){H(a?"resetPasswordError":"savePasswordError",K)}h()},{onChange:E,...O}=m("password",{required:!0});return y(Y,{children:[e(_,{}),e(gt,{titleKey:a?l("resetPasswordFor",{username:t.username}):l("setPasswordFor",{username:t.username}),open:I,onCancel:h,toggleDialog:C,onConfirm:V,confirmButtonDisabled:!c,continueButtonLabel:"save",children:y(Ke,{id:"userCredentials-form",isHorizontal:!0,className:"keycloak__user-credentials__reset-form",children:[y(Ne,{name:"password",label:l("password"),fieldId:"password",isRequired:!0,children:[e(Xe,{"data-testid":"passwordField",id:"password",onChange:async o=>{await E(o),o.currentTarget&&G!==o.currentTarget.value?S("passwordConfirmation",{message:l("confirmPasswordDoesNotMatch")}):T("passwordConfirmation")},...O}),p.password&&e(Ze,{message:l("required")})]}),y(Ne,{name:"passwordConfirmation",label:l(a?"resetPasswordConfirmation":"passwordConfirmation"),fieldId:"passwordConfirmation",isRequired:!0,children:[e(Xe,{"data-testid":"passwordConfirmationField",id:"passwordConfirmation",...m("passwordConfirmation",{required:!0,validate:o=>o===U||l("confirmPasswordDoesNotMatch")})}),p.passwordConfirmation&&e(Ze,{message:p.passwordConfirmation.message})]}),e(ze,{...f,children:e(kr,{name:"temporaryPassword",label:l("temporaryPassword"),labelIcon:l("temporaryPasswordHelpText"),className:"pf-v5-u-mb-md",defaultValue:"true"})})]})})]})},nt=({credential:t,userId:a,toggleDelete:s,resetPassword:n,isUserLabelEdit:h,setIsUserLabelEdit:i,refresh:l})=>e(zr,{credential:t,toggleDelete:()=>s(t),resetPassword:n,children:e(Gr,{credential:t,userId:a,isEditable:h?.status&&h.rowKey===t.id||!1,toggle:()=>{i({status:!h?.status,rowKey:t.id}),h?.status&&l()}})},t.id),_r=({user:t,setUser:a})=>{const{adminClient:s}=Z(),{t:n}=z(),{addAlert:h,addError:i}=de(),[l,f]=u(0),m=Qe(),c=()=>f(l+1),[p,d]=u(!1),[k,T]=u(!1),[S,I]=u([]),[C,U]=u([]),[G,ee]=u({}),[H,V]=u(!1),[_,J]=u(),E=rr(null),[O,o]=u({draggedItemId:"",draggingToItemIndex:-1,dragging:!1,tempItemOrder:[""]});ke(()=>t.enabled?s.users.getCredentials({id:t.id}):Promise.resolve([]),r=>{r=[...r.filter(w=>w.federationLink===void 0)],I(r);const b=r.reduce((w,A)=>(w[A.type]=w[A.type]||[],w[A.type].push(A),w),Object.create(null)),v=Object.keys(b).map(w=>({key:w,value:b[w]}));U(v.map(w=>({...w,isExpanded:!1})))},[l]);const R=()=>d(!p),K=()=>{T(!k)},P=()=>{V(!0),R()},[ne,Q]=pe({titleKey:n("deleteCredentialsConfirmTitle"),messageKey:n("deleteCredentialsConfirm"),continueButtonLabel:n("delete"),continueButtonVariant:he.danger,onConfirm:async()=>{try{await s.users.deleteCredential({id:t.id,credentialId:G.id}),h(n("deleteCredentialsSuccess"),X.success),f(r=>r+1)}catch(r){i("deleteCredentialsError",r)}}}),g=ht(()=>C.flatMap(r=>[r.value.map(({id:b})=>b).toString(),...r.isExpanded?r.value.map(b=>b.id):[]]),[C]),x=r=>{r.dataTransfer.effectAllowed="move",r.dataTransfer.setData("text/plain",r.currentTarget.id);const b=r.currentTarget.id;r.currentTarget.classList.add(Ge.modifiers.ghostRow),r.currentTarget.setAttribute("aria-pressed","true"),o({...O,draggedItemId:b,dragging:!0})},B=(r,b,v)=>{const w=r.indexOf(b);if(w===v)return r;const A=[...r];return A.splice(v,0,A.splice(w,1)[0]),A},j=r=>{if(!E.current)return;const b=E.current,v=Array.from(b.children);v.every(({id:w},A)=>w===r[A])||(b.replaceChildren(),r.forEach(w=>{b.appendChild(v.find(({id:A})=>A===w))}))},be=()=>{E.current&&(Array.from(E.current.children).forEach(r=>{r.classList.remove(Ge.modifiers.ghostRow),r.setAttribute("aria-pressed","false")}),o({...O,draggedItemId:"",draggingToItemIndex:-1,dragging:!1}))},Ce=r=>{L(r)||(j(g),o({...O,draggingToItemIndex:-1}))},L=r=>{if(!E.current)return!1;const b=E.current.getBoundingClientRect();return r.clientX>b.x&&r.clientX<b.x+b.width&&r.clientY>b.y&&r.clientY<b.y+b.height},F=async r=>{L(r)?await Le(O.draggedItemId,O.tempItemOrder):be()},q=r=>{r.preventDefault();const v=r.target.closest("tr");if(!(!v||E.current&&!E.current.contains(v)||v.id===O.draggedItemId)){const w=v.id,A=Array.from(E.current?.children||[]).findIndex(re=>re.id===w);if(A===O.draggingToItemIndex)return;const te=B(g,O.draggedItemId,A);j(te),o({...O,draggingToItemIndex:A,tempItemOrder:te})}},le=r=>{a({...t,requiredActions:[...t.requiredActions??[],...r]})},ie=({target:r})=>{r instanceof HTMLTableRowElement&&(r.classList.remove(Ge.modifiers.ghostRow),r.setAttribute("aria-pressed","false"),o({...O,draggedItemId:"",draggingToItemIndex:-1,dragging:!1}))},Le=async(r,b)=>{const v=g.findIndex(re=>re===r),w=b.findIndex(re=>re===r),A=w-v,te=r.split(",");try{for(const re of te)for(let Ye=0;Ye<Math.abs(A);Ye++)A>0?await s.users.moveCredentialPositionDown({id:t.id,credentialId:re,newPreviousCredentialId:g[w]}):await s.users.moveCredentialPositionUp({id:t.id,credentialId:re});c(),h(n("updatedCredentialMoveSuccess"),X.success)}catch(re){i("updatedCredentialMoveError",re)}},ve=r=>{ee(r),ne()},we=t.federationLink,[ce,Ae]=u([]);if(ke(()=>t.enabled?s.users.getCredentials({id:t.id}):Promise.resolve([]),r=>{r=[...r.filter(b=>b.federationLink!==void 0)],Ae(r)},[l]),!ce)return e(pt,{});const Se=ce.length>0,D=C.length===0,oe=!t.credentials||t.credentials.length===0,me=D&&oe&&!Se;return y(Y,{children:[p&&e(Hr,{user:t,isResetPassword:H,onAddRequiredActions:le,refresh:c,onClose:()=>d(!1)}),k&&e(jr,{userId:t.id,onClose:()=>T(!1)}),e(Q,{}),t.email&&!me&&e(N,{className:"kc-resetCredentialBtn-header",variant:"primary","data-testid":"credentialResetBtn",onClick:()=>T(!0),children:n("credentialResetBtn")}),S.length!==0&&!S.find(r=>r.type==="password")&&!ce.find(r=>r.type==="password")&&y(Y,{children:[e(N,{className:"kc-setPasswordBtn-tbl","data-testid":"setPasswordBtn-table",variant:"primary",form:"userCredentials-form",onClick:()=>{d(!0)},children:n("setPassword")}),e(Kt,{})]}),C.length!==0&&e(fe,{variant:Ve.light,children:y(je,{variant:"compact",children:[e(qe,{children:y(ge,{className:"kc-table-header",children:[e(W,{children:e(zt,{helpText:n("userCredentialsHelpText"),fieldLabelId:"userCredentialsHelpTextLabel"})}),e(W,{"aria-hidden":"true"}),e(W,{children:n("type")}),e(W,{children:n("userLabel")}),e(W,{children:n("createdAt")}),e(W,{children:n("data")}),e(W,{"aria-hidden":"true"}),e(W,{"aria-hidden":"true"})]})}),e(He,{ref:E,onDragOver:q,onDrop:q,onDragLeave:Ce,children:C.map((r,b)=>y(ar,{children:[y(ge,{id:r.value.map(({id:v})=>v).toString(),draggable:C.length>1,onDrop:F,onDragEnd:ie,onDragStart:x,children:[e(M,{className:C.length===1?"one-row":"",draggableRow:{id:`draggable-row-${r.value.map(({id:v})=>v)}`}}),r.value.length>1?e(M,{className:"kc-expandRow-btn",expand:{rowIndex:b,isExpanded:r.isExpanded,onToggle:(v,w)=>{const A=C.map((te,re)=>re===w?{...te,isExpanded:!te.isExpanded}:te);U(A)}}}):e(M,{}),e(M,{dataLabel:`columns-${r.key}`,className:"kc-notExpandableRow-credentialType","data-testid":"credentialType",children:et(r.key)}),r.value.length<=1&&r.value.map(v=>e(nt,{credential:v,userId:t.id,toggleDelete:ve,resetPassword:P,isUserLabelEdit:_,setIsUserLabelEdit:J,refresh:c},v.id))]}),r.isExpanded&&r.value.map(v=>y(ge,{id:v.id,draggable:!0,onDrop:F,onDragEnd:ie,onDragStart:x,children:[e(M,{}),e(M,{className:"kc-draggable-dropdown-type-icon",draggableRow:{id:`draggable-row-${r.value.map(({id:w})=>w)}`}}),e(M,{dataLabel:`child-columns-${v.id}`,className:"kc-expandableRow-credentialType",children:et(v.type)}),e(nt,{credential:v,userId:t.id,toggleDelete:ve,resetPassword:P,isUserLabelEdit:_,setIsUserLabelEdit:J,refresh:c})]},v.id))]},r.key))})]})}),we&&Se&&e(fe,{variant:Ve.light,children:y(je,{variant:"compact",children:[e(qe,{children:y(ge,{children:[e(W,{children:n("type")}),e(W,{children:n("providedBy")}),e(W,{children:n("createdAt")}),e(W,{"aria-hidden":"true"})]})}),e(He,{children:ce.map(r=>y(ge,{children:[e(M,{children:e("b",{children:r.type})}),e(M,{children:e(ur,{user:t})}),e(M,{children:m(new Date(r.createdDate))}),r.type==="password"&&e(M,{modifier:"fitContent",children:e(N,{variant:"secondary",onClick:R,children:n("setPassword")})})]},r.type))})]})}),me&&e(Be,{hasIcon:!0,message:n("noCredentials"),instructions:n("noCredentialsText"),primaryActionText:n("setPassword"),onPrimaryAction:R,secondaryActions:t.email?[{text:n("credentialResetBtn"),onClick:K,type:he.link}]:void 0})]})},Wr=({user:t})=>{const{adminClient:a}=Z(),{t:s}=z(),{addAlert:n,addError:h}=de(),[i,l]=u(0),f=()=>l(i+1),[m,c]=u([]),[p,d]=u(!0),[k,T]=u([]),[S,I]=u(!1),{enabled:C}=Gt(),{hasAccess:U}=$e(),G=U("manage-users"),ee=o=>ft(o,R=>R.path?.toUpperCase()),H=async(o,R,K)=>{const P={first:o,max:R},ne=K||"";ne&&(P.search=ne);const Q=await a.users.listGroups({...P,id:t.id});T([...Q]);const g=[];return p||Q.forEach(x=>{const B=(x.path?.substring(1).match(/((~\/)|[^/])+/g)||[]).slice(0,-1);g.push(...B.map(j=>({name:j,path:x.path?.substring(0,x.path.indexOf(j)+j.length)})))}),ee(Ht([...Q,...g],"path"))},V=()=>{I(!S)},[_,J]=pe({titleKey:s("leaveGroup",{count:m.length,name:m[0]?.name}),messageKey:s("leaveGroupConfirmDialog",{count:m.length,groupname:m[0]?.name,username:t.username}),continueButtonLabel:"leave",continueButtonVariant:he.danger,onConfirm:async()=>{try{await Promise.all(m.map(o=>a.users.delFromGroup({id:t.id,groupId:o.id}))),c([]),n(s("removedGroupMembership"),X.success)}catch(o){h("removedGroupMembershipError",o)}f()}}),E=o=>{c(o),_()},O=async o=>{try{await Promise.all(o.map(R=>a.users.addToGroup({id:t.id,groupId:R.id}))),n(s("addedGroupMembership"),X.success)}catch(R){h("addedGroupMembershipError",R)}f()};return y(Y,{children:[e(J,{}),S&&e(Tr,{id:t.id,type:"selectMany",text:{title:s("joinGroupsFor",{username:t.username}),ok:"join"},canBrowse:G,onClose:()=>I(!1),onConfirm:async(o=[])=>{await O(o),I(!1)}}),e(Ie,{loader:H,className:"keycloak_user-section_groups-table",isPaginated:!0,ariaLabelKey:"roleList",searchPlaceholderKey:"searchGroup",canSelectAll:!0,onSelect:o=>c(p?o:qt(o,k,"id")),isRowDisabled:o=>!p&&k.every(R=>R.id!==o.id),toolbarItem:y(Y,{children:[e(N,{className:"kc-join-group-button",onClick:V,"data-testid":"add-group-button",isDisabled:!t.access?.manageGroupMembership,children:s("joinGroup")}),e(Vt,{label:s("directMembership"),id:"kc-direct-membership-checkbox",onChange:()=>{d(!p),f()},isChecked:p,className:"pf-v5-u-mt-sm"},"direct-membership-check"),e(N,{onClick:()=>E(m),"data-testid":"leave-group-button",variant:"link",isDisabled:m.length===0,className:"pf-v5-u-ml-md",children:s("leave")}),C&&e(jt,{"aria-label":"Basic popover",position:"bottom",bodyContent:e("div",{children:s("whoWillAppearPopoverTextUsers")}),children:e(N,{variant:"link",className:"kc-who-will-appear-button",icon:e(Dr,{}),children:s("whoWillAppearLinkTextUsers")},"who-will-appear-button")})]}),columns:[{name:"groupMembership",displayKey:"groupMembership",cellRenderer:o=>o.name||"-",transforms:[$(40)]},{name:"path",displayKey:"path",cellRenderer:o=>e(Pr,{group:o}),transforms:[$(45)]},{name:"",cellRenderer:o=>k.some(K=>K.id===o.id)||k.length===0||p?e(N,{"data-testid":`leave-${o.name}`,onClick:()=>E([o]),variant:"link",isDisabled:!t.access?.manageGroupMembership,children:s("leave")}):"-",transforms:[$(20)]}],emptyState:e(Be,{hasIcon:!0,message:s("noGroups"),instructions:s("noGroupsText"),primaryActionText:s("joinGroup"),onPrimaryAction:V})},i)]})},$r=({userId:t,federatedId:a,onClose:s,onRefresh:n})=>{const{adminClient:h}=Z(),{t:i}=z(),{addAlert:l,addError:f}=de(),m=De({mode:"onChange"}),{handleSubmit:c,formState:{isValid:p}}=m,d=async k=>{try{await h.users.addToFederatedIdentity({id:t,federatedIdentityId:a,federatedIdentity:k}),l(i("idpLinkSuccess"),X.success),s(),n()}catch(T){f("couldNotLinkIdP",T)}};return e(We,{variant:Fe.small,title:i("linkAccountTitle",{provider:ye(a)}),onClose:s,actions:[e(N,{"data-testid":"confirm",variant:"primary",type:"submit",form:"group-form",isDisabled:!p,children:i("link")},"confirm"),e(N,{"data-testid":"cancel",variant:he.link,onClick:s,children:i("cancel")},"cancel")],isOpen:!0,children:e(Ke,{id:"group-form",onSubmit:c(d),children:y(ze,{...m,children:[e(Ne,{label:i("identityProvider"),fieldId:"identityProvider",children:e(ut,{id:"identityProvider","data-testid":"idpNameInput",value:ye(a),readOnly:!0})}),e(tt,{name:"userId",label:i("userID"),helperText:i("userIdHelperText"),autoFocus:!0,rules:{required:i("required")}}),e(tt,{name:"userName",label:i("username"),helperText:i("usernameHelperText"),rules:{required:i("required")}})]})})})},Jr=({userId:t})=>{const{adminClient:a}=Z(),[s,n]=u(0),[h,i]=u([]),[l,f]=u(!0),[m,c]=u(""),[p,d]=u(!1),{realm:k}=Pe(),{addAlert:T,addError:S}=de(),{t:I}=z(),{hasAccess:C,hasSomeAccess:U}=$e(),G=U("manage-identity-providers","view-identity-providers");ke(()=>a.users.listFederatedIdentities({id:t}),g=>{i(g.map(x=>x.identityProvider)),f(!1)},[t,s]);const ee=()=>{n(new Date().getTime()),f(!0)},H=_t().identityProviders,V=async()=>{const g=await a.users.listFederatedIdentities({id:t});if(G){const x=await a.identityProviders.find();for(const B of g)B.providerId=x.find(j=>j.alias===B.identityProvider)?.providerId}return g},_=async()=>V(),J=async(g,x,B)=>{const j={first:g,max:x,realmOnly:!1,capability:"USER_LINKING"};return B&&(j.search=B),await a.identityProviders.find(j)},[E,O]=pe({titleKey:I("unlinkAccountTitle",{provider:ye(m)}),messageKey:I("unlinkAccountConfirm",{provider:ye(m)}),continueButtonLabel:"unlink",continueButtonVariant:he.primary,onConfirm:async()=>{try{await a.users.delFromFederatedIdentity({id:t,federatedIdentityId:m}),T(I("idpUnlinkSuccess"),X.success),ee()}catch(g){S("mappingDeletedError",g)}}}),o=g=>G?e(mt,{to:Jt({realm:k,providerId:g.providerId,alias:g.identityProvider,tab:"settings"}),children:ye(g.identityProvider)}):e("span",{children:ye(g.identityProvider)}),R=g=>{const x=H?.find(B=>B.id===g.identityProvider)?.groupName;return e(_e,{color:x==="Social"?"blue":"orange",children:I(x==="Social"?"idpType.social":"idpType.custom")})},K=g=>{const x=H?.find(B=>B.id===g.providerId)?.groupName;return e(_e,{color:x==="User-defined"?"orange":"blue",children:x==="User-defined"?"Custom":x==="Social"?I("idpType.social"):x})},P=g=>C("manage-users")?e(N,{variant:"link",onClick:()=>{c(g.identityProvider),E()},children:I("unlinkAccount")}):e("span",{}),ne=g=>h.includes(g.alias)?e("span",{}):e(N,{variant:"link",onClick:()=>{c(g.alias),d(!0)},children:I("linkAccount")}),Q=()=>{const g=[{name:"identityProvider",displayKey:"name",cellRenderer:o,transforms:[$(20)]},{name:"userId",displayKey:"userID",cellFormatters:[Ue()],transforms:[$(30)]},{name:"userName",displayKey:"username",cellFormatters:[Ue()],transforms:[$(20)]},{name:"",cellRenderer:P,transforms:[$(20)]}];return G&&g.splice(1,0,{name:"type",displayKey:"type",cellRenderer:R,transforms:[$(10)]}),g};return y(Y,{children:[p&&e($r,{userId:t,federatedId:m,onClose:()=>d(!1),onRefresh:ee}),e(O,{}),y(fe,{variant:"light",className:"pf-v5-u-p-0",children:[y(rt,{title:I("linkedIdPs"),className:"kc-linked-idps",children:[e(xe,{children:e(Re,{className:"kc-available-idps-text",children:I("linkedIdPsText")})}),e(Ie,{loader:_,isPaginated:!1,ariaLabelKey:"LinkedIdPs",className:"kc-linked-IdPs-table",columns:Q(),emptyState:e(xe,{className:"kc-no-providers-text",children:e(Re,{children:I("noProvidersLinked")})})},s)]}),C("manage-users")&&G&&y(rt,{className:"kc-available-idps",title:I("availableIdPs"),children:[e(xe,{children:e(Re,{className:"kc-available-idps-text",children:I("availableIdPsText")})}),l?e(Wt,{}):e(Ie,{loader:J,isPaginated:!0,searchPlaceholderKey:"searchForProvider",ariaLabelKey:"LinkedIdPs",className:"kc-linked-IdPs-table",columns:[{name:"alias",displayKey:"name",cellFormatters:[Ue(),$t()],transforms:[$(20)]},{name:"type",displayKey:"type",cellRenderer:K,transforms:[$(60)]},{name:"",cellRenderer:ne}],emptyState:e(xe,{className:"kc-no-providers-text",children:e(Re,{children:I("noAvailableIdentityProviders")})})},s)]})]})]})},Qr=({id:t,name:a})=>{const{adminClient:s}=Z(),{t:n}=z(),{addAlert:h,addError:i}=de();return e(Lr,{name:a,id:t,type:"users",save:async f=>{try{const m=f.filter(c=>c.client===void 0).map(c=>c.role).flat();await s.users.addRealmRoleMappings({id:t,roles:m}),await Promise.all(f.filter(c=>c.client!==void 0).map(c=>s.users.addClientRoleMappings({id:t,clientUniqueId:c.client.id,roles:[c.role]}))),h(n("userRoleMappingUpdatedSuccess"),X.success)}catch(m){i("roleMappingUpdatedError",m)}}})},Yr=()=>{const{adminClient:t}=Z(),{id:a}=Je(),{realm:s}=Pe(),{t:n}=z();return e(fe,{variant:"light",className:"pf-v5-u-p-0",children:e(yr,{loader:()=>t.users.listSessions({id:a,realm:s}),hiddenColumns:["username","type"],emptyInstructions:n("noSessionsForUser"),logoutUser:a})})};function $a(){const{adminClient:t}=Z(),{t:a}=z(),{addAlert:s,addError:n}=de(),h=it(),{hasAccess:i}=$e(),{id:l}=Je(),{realm:f,realmRepresentation:m}=Pe(),p=De({mode:"onChange",resolver:async D=>({values:D,errors:{}})}),[d,k]=u(),[T,S]=u(),[I,C]=u(),[U,G]=u(),[ee,H]=u(0),V=()=>H(D=>D+1),_=Cr(d?.id),[J,E]=u(),[O,o]=u(!1),K=Qt()(Yt.Organizations)&&m?.organizationsEnabled,P=D=>Xt({realm:f,id:d?.id||"",tab:D}),[ne,Q]=u("userEvents"),g=ue(P("settings")),x=ue(P("attributes")),B=ue(P("credentials")),j=ue(P("role-mapping")),be=ue(P("groups")),Ce=ue(P("organizations")),L=ue(P("consents")),F=ue(P("identity-provider-links")),q=ue(P("sessions")),le=ue(P("events"));ke(async()=>Promise.all([t.users.findOne({id:l,userProfileMetadata:!0}),t.attackDetection.findOne({id:l}),t.users.getUnmanagedAttributes({id:l}),t.users.getProfile({realm:f}),K?t.organizations.find({first:0,max:1}):[]]),([D,oe,me,r,b])=>{if(!D||!m||!oe)throw new Error(a("notFound"));const{userProfileMetadata:v,...w}=D;G(v),w.unmanagedAttributes=me,w.attributes=pr(w.attributes,me),r.unmanagedAttributePolicy!==void 0&&C(!0),k(w),E(r);const A=m.bruteForceProtected,te=A&&oe.disabled;S({isBruteForceProtected:A,isLocked:te}),o(b.length===1),p.reset(Oe(w))},[ee]);const ie=async D=>{try{await t.users.update({id:d.id},gr(D)),s(a("userSaved"),X.success),V()}catch(oe){if(tr(oe)){if(I&&Array.isArray(D.unmanagedAttributes)){const me=new Array(D.unmanagedAttributes.length);let r=!1;at(oe,(b,v)=>{if(b.startsWith("attributes.")){const w=b.substring(11);D.unmanagedAttributes.forEach((A,te)=>{A.key===w&&(me[te]=v,r=!0)})}else p.setError(b,v)},((b,v)=>a(b,v))),r&&p.setError("unmanagedAttributes",me)}else at(oe,p.setError,((me,r)=>a(me,r)));n("userNotSaved","")}else n("userCreateError",oe)}},[Le,ve]=pe({titleKey:"disableConfirmUserTitle",messageKey:"disableConfirmUser",continueButtonLabel:"disable",onConfirm:async()=>{await ie({...Oe(d),enabled:!1})}}),[we,ce]=pe({titleKey:"deleteConfirmUsers",messageKey:"deleteConfirmCurrentUser",continueButtonLabel:"delete",continueButtonVariant:he.danger,onConfirm:async()=>{try{_?await t.users.logout({id:d.id}):await t.users.del({id:d.id}),s(a("userDeletedSuccess"),X.success),h(ot({realm:f}))}catch(D){n("userDeletedError",D)}}}),[Ae,Se]=pe({titleKey:"impersonateConfirm",messageKey:"impersonateConfirmDialog",continueButtonLabel:"impersonate",onConfirm:async()=>{try{const D=await t.users.impersonation({id:d.id},{user:d.id,realm:f});D.sameRealm?window.location=D.redirect:window.open(D.redirect,"_blank")}catch(D){n("impersonateError",D)}}});return!d||!T?e(pt,{}):y(Y,{children:[e(Se,{}),e(ce,{}),e(ve,{}),e(nr,{titleKey:d.username,className:"kc-username-view-header",divider:!1,badges:_?[{text:e(Zt,{content:a("transientUserTooltip"),children:e(_e,{"data-testid":"user-details-label-transient-user",icon:e(er,{}),children:a("transientUser")})})}]:[],dropdownItems:[e(Te,{isDisabled:!d.access?.impersonate,onClick:()=>Ae(),children:a("impersonate")},"impersonate"),e(Te,{isDisabled:!d.access?.manage,onClick:()=>we(),children:a("delete")},"delete")],onToggle:async D=>{D?await ie({...Oe(d),enabled:D}):Le()},isEnabled:d.enabled}),e(fe,{variant:"light",className:"pf-v5-u-p-0",children:e(ir,{children:e(ze,{...p,children:y(sr,{isBox:!0,mountOnEnter:!0,defaultLocation:P("settings"),children:[e(ae,{"data-testid":"user-details-tab",title:e(se,{children:a("details")}),...g,children:e(fe,{variant:"light",children:e(hr,{form:p,realm:m,user:d,bruteForce:T,userProfileMetadata:U,refresh:V,save:ie})})}),I&&e(ae,{"data-testid":"attributesTab",title:e(se,{children:a("attributes")}),...x,children:e(Fr,{user:d,save:ie,upConfig:J})}),e(ae,{"data-testid":"credentials",isHidden:!d.access?.view,title:e(se,{children:a("credentials")}),...B,children:e(_r,{user:d,setUser:k})}),e(ae,{"data-testid":"role-mapping-tab",isHidden:!d.access?.view,title:e(se,{children:a("roleMapping")}),...j,children:e(Qr,{id:d.id,name:d.username})}),i("query-groups")&&e(ae,{"data-testid":"user-groups-tab",title:e(se,{children:a("groups")}),...be,children:e(Wr,{user:d})}),K&&O&&e(ae,{"data-testid":"user-organizations-tab",title:e(se,{children:a("organizations")}),...Ce,children:e(Nr,{user:d})}),e(ae,{"data-testid":"user-consents-tab",title:e(se,{children:a("consents")}),...L,children:e(Br,{})}),e(ae,{"data-testid":"identity-provider-links-tab",title:e(se,{children:a("identityProviderLinks")}),...F,children:e(Jr,{userId:d.id})}),e(ae,{"data-testid":"user-sessions-tab",title:e(se,{children:a("sessions")}),...q,children:e(Yr,{})}),i("view-events")&&e(ae,{"data-testid":"events-tab",title:e(se,{children:a("events")}),...le,children:y(Er,{activeKey:ne,onSelect:(D,oe)=>Q(oe),children:[e(ae,{eventKey:"userEvents",title:e(se,{children:a("userEvents")}),children:e(Ar,{user:d.id})}),e(ae,{eventKey:"adminEvents",title:e(se,{children:a("adminEvents")}),children:e(Sr,{resourcePath:`users/${d.id}`})})]})})]})})})})]})}export{$a as default};
//# sourceMappingURL=EditUser-DTVs8lbN.js.map
