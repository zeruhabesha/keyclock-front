{"version":3,"file":"ClientScopesSection-DxeunTpt.js","sources":["../../../../../../../src/client-scopes/ClientScopesSection.tsx"],"sourcesContent":["import {\r\n  AlertVariant,\r\n  Button,\r\n  ButtonVariant,\r\n  Dropdown,\r\n  DropdownItem,\r\n  DropdownList,\r\n  MenuToggle,\r\n  PageSection,\r\n  ToolbarItem,\r\n} from \"@patternfly/react-core\";\r\nimport { EllipsisVIcon } from \"@patternfly/react-icons\";\r\nimport { cellWidth } from \"@patternfly/react-table\";\r\nimport { useState } from \"react\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { Link } from \"react-router-dom\";\r\nimport { useAdminClient } from \"../admin-client\";\r\nimport type { Row } from \"../clients/scopes/ClientScopes\";\r\nimport { getProtocolName } from \"../clients/utils\";\r\nimport { useAlerts } from \"@keycloak/keycloak-ui-shared\";\r\nimport {\r\n  AllClientScopeType,\r\n  AllClientScopes,\r\n  CellDropdown,\r\n  ClientScope,\r\n  ClientScopeDefaultOptionalType,\r\n  changeScope,\r\n  removeScope,\r\n} from \"../components/client-scope/ClientScopeTypes\";\r\nimport { useConfirmDialog } from \"../components/confirm-dialog/ConfirmDialog\";\r\nimport { Action, KeycloakDataTable } from \"@keycloak/keycloak-ui-shared\";\r\nimport { ViewHeader } from \"../components/view-header/ViewHeader\";\r\nimport { useRealm } from \"../context/realm-context/RealmContext\";\r\nimport helpUrls from \"../help-urls\";\r\nimport { emptyFormatter } from \"../util\";\r\nimport useLocaleSort, { mapByKey } from \"../utils/useLocaleSort\";\r\nimport { ChangeTypeDropdown } from \"./ChangeTypeDropdown\";\r\nimport {\r\n  ProtocolType,\r\n  SearchDropdown,\r\n  SearchToolbar,\r\n  SearchType,\r\n  nameFilter,\r\n  protocolFilter,\r\n  typeFilter,\r\n} from \"./details/SearchFilter\";\r\nimport { toClientScope } from \"./routes/ClientScope\";\r\nimport { toNewClientScope } from \"./routes/NewClientScope\";\r\n\r\ntype TypeSelectorProps = ClientScopeDefaultOptionalType & {\r\n  refresh: () => void;\r\n};\r\n\r\nconst TypeSelector = (scope: TypeSelectorProps) => {\r\n  const { adminClient } = useAdminClient();\r\n\r\n  const { t } = useTranslation();\r\n  const { addAlert, addError } = useAlerts();\r\n\r\n  return (\r\n    <CellDropdown\r\n      clientScope={scope}\r\n      type={scope.type}\r\n      all\r\n      onSelect={async (value) => {\r\n        try {\r\n          await changeScope(adminClient, scope, value as AllClientScopeType);\r\n          addAlert(t(\"clientScopeSuccess\"), AlertVariant.success);\r\n          scope.refresh();\r\n        } catch (error) {\r\n          addError(\"clientScopeError\", error);\r\n        }\r\n      }}\r\n    />\r\n  );\r\n};\r\n\r\nconst ClientScopeDetailLink = ({\r\n  id,\r\n  name,\r\n}: ClientScopeDefaultOptionalType) => {\r\n  const { realm } = useRealm();\r\n  return (\r\n    <Link key={id} to={toClientScope({ realm, id: id!, tab: \"settings\" })}>\r\n      {name}\r\n    </Link>\r\n  );\r\n};\r\n\r\nexport default function ClientScopesSection() {\r\n  const { adminClient } = useAdminClient();\r\n\r\n  const { realm } = useRealm();\r\n  const { t } = useTranslation();\r\n  const { addAlert, addError } = useAlerts();\r\n\r\n  const [kebabOpen, setKebabOpen] = useState(false);\r\n  const [selectedScopes, setSelectedScopes] = useState<\r\n    ClientScopeDefaultOptionalType[]\r\n  >([]);\r\n\r\n  const [searchType, setSearchType] = useState<SearchType>(\"name\");\r\n  const [searchTypeType, setSearchTypeType] = useState<AllClientScopes>(\r\n    AllClientScopes.none,\r\n  );\r\n  const [searchProtocol, setSearchProtocol] = useState<ProtocolType>(\"all\");\r\n  const localeSort = useLocaleSort();\r\n\r\n  const [key, setKey] = useState(0);\r\n  const refresh = () => {\r\n    setSelectedScopes([]);\r\n    setKey(key + 1);\r\n  };\r\n\r\n  const loader = async (first?: number, max?: number, search?: string) => {\r\n    const defaultScopes =\r\n      await adminClient.clientScopes.listDefaultClientScopes();\r\n    const optionalScopes =\r\n      await adminClient.clientScopes.listDefaultOptionalClientScopes();\r\n    const clientScopes = await adminClient.clientScopes.find();\r\n\r\n    const filter =\r\n      searchType === \"name\"\r\n        ? nameFilter(search)\r\n        : searchType === \"type\"\r\n          ? typeFilter(searchTypeType)\r\n          : protocolFilter(searchProtocol);\r\n\r\n    const transformed = clientScopes\r\n      .map((scope) => {\r\n        const row: Row = {\r\n          ...scope,\r\n          type: defaultScopes.find(\r\n            (defaultScope) => defaultScope.name === scope.name,\r\n          )\r\n            ? ClientScope.default\r\n            : optionalScopes.find(\r\n                  (optionalScope) => optionalScope.name === scope.name,\r\n                )\r\n              ? ClientScope.optional\r\n              : AllClientScopes.none,\r\n        };\r\n        return row;\r\n      })\r\n      .filter(filter);\r\n\r\n    return localeSort(transformed, mapByKey(\"name\")).slice(\r\n      first,\r\n      Number(first) + Number(max),\r\n    );\r\n  };\r\n\r\n  const [toggleDeleteDialog, DeleteConfirm] = useConfirmDialog({\r\n    titleKey: t(\"deleteClientScope\", {\r\n      count: selectedScopes.length,\r\n      name: selectedScopes[0]?.name,\r\n    }),\r\n    messageKey: \"deleteConfirmClientScopes\",\r\n    continueButtonLabel: \"delete\",\r\n    continueButtonVariant: ButtonVariant.danger,\r\n    onConfirm: async () => {\r\n      const clientScopes = await adminClient.clientScopes.find();\r\n      const clientScopeLength = Object.keys(clientScopes).length;\r\n      if (clientScopeLength - selectedScopes.length > 0) {\r\n        try {\r\n          for (const scope of selectedScopes) {\r\n            try {\r\n              await removeScope(adminClient, scope);\r\n            } catch (error: any) {\r\n              console.warn(\r\n                \"could not remove scope\",\r\n                error.response?.data?.errorMessage || error,\r\n              );\r\n            }\r\n            await adminClient.clientScopes.del({ id: scope.id! });\r\n          }\r\n          addAlert(t(\"deletedSuccessClientScope\"), AlertVariant.success);\r\n          refresh();\r\n        } catch (error) {\r\n          addError(\"deleteErrorClientScope\", error);\r\n        }\r\n      } else {\r\n        addAlert(t(\"notAllowedToDeleteAllClientScopes\"), AlertVariant.danger);\r\n      }\r\n    },\r\n  });\r\n\r\n  return (\r\n    <>\r\n      <DeleteConfirm />\r\n      <ViewHeader\r\n        titleKey=\"clientScopes\"\r\n        subKey=\"clientScopeExplain\"\r\n        helpUrl={helpUrls.clientScopesUrl}\r\n      />\r\n      <PageSection variant=\"light\" className=\"pf-v5-u-p-0\">\r\n        <KeycloakDataTable\r\n          key={key}\r\n          loader={loader}\r\n          ariaLabelKey=\"clientScopeList\"\r\n          searchPlaceholderKey={\r\n            searchType === \"name\" ? \"searchForClientScope\" : undefined\r\n          }\r\n          isSearching={searchType !== \"name\"}\r\n          searchTypeComponent={\r\n            <SearchDropdown\r\n              searchType={searchType}\r\n              onSelect={(searchType) => setSearchType(searchType)}\r\n              withProtocol\r\n            />\r\n          }\r\n          isPaginated\r\n          onSelect={(clientScopes) => setSelectedScopes([...clientScopes])}\r\n          canSelectAll\r\n          toolbarItem={\r\n            <>\r\n              <SearchToolbar\r\n                searchType={searchType}\r\n                type={searchTypeType}\r\n                onSelect={(searchType) => {\r\n                  setSearchType(searchType);\r\n                  setSearchProtocol(\"all\");\r\n                  setSearchTypeType(AllClientScopes.none);\r\n                  refresh();\r\n                }}\r\n                onType={(value) => {\r\n                  setSearchTypeType(value);\r\n                  setSearchProtocol(\"all\");\r\n                  refresh();\r\n                }}\r\n                protocol={searchProtocol}\r\n                onProtocol={(protocol) => {\r\n                  setSearchProtocol(protocol);\r\n                  setSearchTypeType(AllClientScopes.none);\r\n                  refresh();\r\n                }}\r\n              />\r\n\r\n              <ToolbarItem>\r\n                <Button\r\n                  component={(props) => (\r\n                    <Link {...props} to={toNewClientScope({ realm })} />\r\n                  )}\r\n                >\r\n                  {t(\"createClientScope\")}\r\n                </Button>\r\n              </ToolbarItem>\r\n              <ToolbarItem>\r\n                <ChangeTypeDropdown\r\n                  selectedRows={selectedScopes}\r\n                  refresh={refresh}\r\n                />\r\n              </ToolbarItem>\r\n              <ToolbarItem>\r\n                <Dropdown\r\n                  shouldFocusToggleOnSelect\r\n                  onOpenChange={(isOpen) => setKebabOpen(isOpen)}\r\n                  toggle={(ref) => (\r\n                    <MenuToggle\r\n                      data-testid=\"kebab\"\r\n                      aria-label=\"Kebab toggle\"\r\n                      ref={ref}\r\n                      onClick={() => setKebabOpen(!kebabOpen)}\r\n                      variant=\"plain\"\r\n                    >\r\n                      <EllipsisVIcon />\r\n                    </MenuToggle>\r\n                  )}\r\n                  isOpen={kebabOpen}\r\n                >\r\n                  <DropdownList>\r\n                    <DropdownItem\r\n                      data-testid=\"delete\"\r\n                      isDisabled={selectedScopes.length === 0}\r\n                      onClick={() => {\r\n                        toggleDeleteDialog();\r\n                        setKebabOpen(false);\r\n                      }}\r\n                    >\r\n                      {t(\"delete\")}\r\n                    </DropdownItem>\r\n                  </DropdownList>\r\n                </Dropdown>\r\n              </ToolbarItem>\r\n            </>\r\n          }\r\n          actions={[\r\n            {\r\n              title: t(\"delete\"),\r\n              onRowClick: (clientScope) => {\r\n                setSelectedScopes([clientScope]);\r\n                toggleDeleteDialog();\r\n              },\r\n            } as Action<Row>,\r\n          ]}\r\n          columns={[\r\n            {\r\n              name: \"name\",\r\n              cellRenderer: ClientScopeDetailLink,\r\n            },\r\n            {\r\n              name: \"type\",\r\n              displayKey: \"assignedType\",\r\n              cellRenderer: (row) => (\r\n                <TypeSelector {...row} refresh={refresh} />\r\n              ),\r\n            },\r\n            {\r\n              name: \"protocol\",\r\n              displayKey: \"protocol\",\r\n              cellRenderer: (client) =>\r\n                getProtocolName(t, client.protocol ?? \"openid-connect\"),\r\n              transforms: [cellWidth(15)],\r\n            },\r\n            {\r\n              name: \"attributes['gui.order']\",\r\n              displayKey: \"displayOrder\",\r\n              cellFormatters: [emptyFormatter()],\r\n              transforms: [cellWidth(15)],\r\n            },\r\n            { name: \"description\", cellFormatters: [emptyFormatter()] },\r\n          ]}\r\n        />\r\n      </PageSection>\r\n    </>\r\n  );\r\n}\r\n"],"names":["TypeSelector","scope","adminClient","useAdminClient","t","useTranslation","addAlert","addError","useAlerts","jsx","CellDropdown","value","changeScope","AlertVariant","error","ClientScopeDetailLink","id","name","realm","useRealm","Link","toClientScope","ClientScopesSection","kebabOpen","setKebabOpen","useState","selectedScopes","setSelectedScopes","searchType","setSearchType","searchTypeType","setSearchTypeType","AllClientScopes","searchProtocol","setSearchProtocol","localeSort","useLocaleSort","key","setKey","refresh","loader","first","max","search","defaultScopes","optionalScopes","clientScopes","filter","nameFilter","typeFilter","protocolFilter","transformed","defaultScope","ClientScope","optionalScope","mapByKey","toggleDeleteDialog","DeleteConfirm","useConfirmDialog","ButtonVariant","removeScope","jsxs","Fragment","ViewHeader","helpUrls","PageSection","KeycloakDataTable","SearchDropdown","SearchToolbar","protocol","ToolbarItem","Button","props","toNewClientScope","ChangeTypeDropdown","Dropdown","isOpen","ref","MenuToggle","EllipsisVIcon","DropdownList","DropdownItem","clientScope","row","client","getProtocolName","cellWidth","emptyFormatter"],"mappings":"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"}