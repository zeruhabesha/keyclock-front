{"version":3,"file":"AttributesGroupDetails-B2WxSRci.js","sources":["../../../../../../../src/realm-settings/user-profile/AttributesGroupForm.tsx","../../../../../../../src/realm-settings/user-profile/AttributesGroupDetails.tsx"],"sourcesContent":["import type { UserProfileGroup } from \"@keycloak/keycloak-admin-client/lib/defs/userProfileMetadata\";\r\nimport { HelpItem, TextControl, useAlerts } from \"@keycloak/keycloak-ui-shared\";\r\nimport {\r\n  ActionGroup,\r\n  Button,\r\n  FormGroup,\r\n  PageSection,\r\n  Text,\r\n  TextContent,\r\n} from \"@patternfly/react-core\";\r\nimport { useEffect, useMemo } from \"react\";\r\nimport { FormProvider, SubmitHandler, useForm } from \"react-hook-form\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { Link, useNavigate, useParams } from \"react-router-dom\";\r\nimport { useAdminClient } from \"../../admin-client\";\r\nimport { FormAccess } from \"../../components/form/FormAccess\";\r\nimport { KeyValueInput } from \"../../components/key-value-form/KeyValueInput\";\r\nimport type { KeyValueType } from \"../../components/key-value-form/key-value-convert\";\r\nimport { ViewHeader } from \"../../components/view-header/ViewHeader\";\r\nimport { useRealm } from \"../../context/realm-context/RealmContext\";\r\nimport \"../realm-settings-section.css\";\r\nimport type { EditAttributesGroupParams } from \"../routes/EditAttributesGroup\";\r\nimport { toUserProfile } from \"../routes/UserProfile\";\r\nimport { useUserProfile } from \"./UserProfileContext\";\r\nimport { saveTranslations, Translations } from \"./attribute/TranslatableField\";\r\nimport { TranslatableField } from \"./attribute/TranslatableField\";\r\n\r\nfunction parseAnnotations(input: Record<string, unknown>): KeyValueType[] {\r\n  return Object.entries(input).reduce((p, [key, value]) => {\r\n    if (typeof value === \"string\") {\r\n      return [...p, { key, value }];\r\n    } else {\r\n      return [...p];\r\n    }\r\n  }, [] as KeyValueType[]);\r\n}\r\n\r\nfunction transformAnnotations(input: KeyValueType[]): Record<string, unknown> {\r\n  return Object.fromEntries(\r\n    input\r\n      .filter((annotation) => annotation.key.length > 0)\r\n      .map((annotation) => [annotation.key, annotation.value] as const),\r\n  );\r\n}\r\n\r\ntype FormFields = Required<Omit<UserProfileGroup, \"annotations\">> &\r\n  Translations & {\r\n    annotations: KeyValueType[];\r\n  };\r\n\r\nconst defaultValues: FormFields = {\r\n  annotations: [],\r\n  displayDescription: \"\",\r\n  displayHeader: \"\",\r\n  name: \"\",\r\n  translation: { key: [] },\r\n};\r\n\r\nexport default function AttributesGroupForm() {\r\n  const { adminClient } = useAdminClient();\r\n  const { t } = useTranslation();\r\n  const { realm: realmName, realmRepresentation: realm } = useRealm();\r\n  const { config, save } = useUserProfile();\r\n  const navigate = useNavigate();\r\n  const params = useParams<EditAttributesGroupParams>();\r\n  const form = useForm<FormFields>({ defaultValues });\r\n  const { addError } = useAlerts();\r\n  const editMode = params.name ? true : false;\r\n\r\n  const matchingGroup = useMemo(\r\n    () => config?.groups?.find(({ name }) => name === params.name),\r\n    [config?.groups, params.name],\r\n  );\r\n\r\n  useEffect(() => {\r\n    if (!matchingGroup) {\r\n      return;\r\n    }\r\n\r\n    const annotations = matchingGroup.annotations\r\n      ? parseAnnotations(matchingGroup.annotations)\r\n      : [];\r\n\r\n    form.reset({ ...defaultValues, ...matchingGroup, annotations });\r\n  }, [matchingGroup, form]);\r\n\r\n  const onSubmit: SubmitHandler<FormFields> = async (values) => {\r\n    if (!config) {\r\n      return;\r\n    }\r\n\r\n    const groups = [...(config.groups ?? [])];\r\n    const updateAt = matchingGroup ? groups.indexOf(matchingGroup) : -1;\r\n    const { translation, ...groupValues } = values;\r\n    const updatedGroup: UserProfileGroup = {\r\n      ...groupValues,\r\n      annotations: transformAnnotations(values.annotations),\r\n    };\r\n\r\n    if (updateAt === -1) {\r\n      groups.push(updatedGroup);\r\n    } else {\r\n      groups[updateAt] = updatedGroup;\r\n    }\r\n\r\n    const success = await save({ ...config, groups });\r\n\r\n    if (success) {\r\n      if (realm?.internationalizationEnabled) {\r\n        try {\r\n          await saveTranslations({\r\n            adminClient,\r\n            realmName,\r\n            translationsData: { translation },\r\n          });\r\n        } catch (error) {\r\n          addError(t(\"errorSavingTranslations\"), error);\r\n        }\r\n      }\r\n      navigate(toUserProfile({ realm: realmName, tab: \"attributes-group\" }));\r\n    }\r\n  };\r\n\r\n  return (\r\n    <FormProvider {...form}>\r\n      <ViewHeader\r\n        titleKey={matchingGroup ? \"editGroupText\" : \"createGroupText\"}\r\n        divider\r\n      />\r\n      <PageSection variant=\"light\" onSubmit={form.handleSubmit(onSubmit)}>\r\n        <FormAccess isHorizontal role=\"manage-realm\">\r\n          <TextControl\r\n            name=\"name\"\r\n            label={t(\"nameField\")}\r\n            labelIcon={t(\"nameHintHelp\")}\r\n            isDisabled={!!matchingGroup || editMode}\r\n            rules={{\r\n              required: t(\"required\"),\r\n            }}\r\n          />\r\n          <FormGroup\r\n            label={t(\"displayHeader\")}\r\n            labelIcon={\r\n              <HelpItem\r\n                helpText={t(\"displayHeaderHintHelp\")}\r\n                fieldLabelId=\"displayHeader\"\r\n              />\r\n            }\r\n            fieldId=\"kc-attributes-group-display-header\"\r\n          >\r\n            <TranslatableField\r\n              fieldName=\"displayHeader\"\r\n              attributeName=\"name\"\r\n              prefix=\"profile.attribute-group\"\r\n            />\r\n          </FormGroup>\r\n          <FormGroup\r\n            label={t(\"displayDescription\")}\r\n            labelIcon={\r\n              <HelpItem\r\n                helpText={t(\"displayDescriptionHintHelp\")}\r\n                fieldLabelId=\"displayDescription\"\r\n              />\r\n            }\r\n            fieldId=\"kc-attributes-group-display-description\"\r\n          >\r\n            <TranslatableField\r\n              fieldName=\"displayDescription\"\r\n              attributeName=\"name\"\r\n              prefix=\"profile.attribute-group-description\"\r\n            />\r\n          </FormGroup>\r\n          <TextContent>\r\n            <Text component=\"h2\">{t(\"annotationsText\")}</Text>\r\n          </TextContent>\r\n          <FormGroup label={t(\"annotationsText\")} fieldId=\"kc-annotations\">\r\n            <KeyValueInput label={t(\"annotationsText\")} name=\"annotations\" />\r\n          </FormGroup>\r\n          <ActionGroup>\r\n            <Button variant=\"primary\" type=\"submit\" data-testid=\"saveGroupBtn\">\r\n              {t(\"save\")}\r\n            </Button>\r\n            <Button\r\n              variant=\"link\"\r\n              component={(props) => (\r\n                <Link\r\n                  {...props}\r\n                  to={toUserProfile({\r\n                    realm: realmName,\r\n                    tab: \"attributes-group\",\r\n                  })}\r\n                />\r\n              )}\r\n            >\r\n              {t(\"cancel\")}\r\n            </Button>\r\n          </ActionGroup>\r\n        </FormAccess>\r\n      </PageSection>\r\n    </FormProvider>\r\n  );\r\n}\r\n","import AttributesGroupForm from \"./AttributesGroupForm\";\r\nimport { UserProfileProvider } from \"./UserProfileContext\";\r\n\r\nconst AttributesGroupDetails = () => (\r\n  <UserProfileProvider>\r\n    <AttributesGroupForm />\r\n  </UserProfileProvider>\r\n);\r\n\r\nexport default AttributesGroupDetails;\r\n"],"names":["parseAnnotations","input","p","key","value","transformAnnotations","annotation","defaultValues","AttributesGroupForm","adminClient","useAdminClient","t","useTranslation","realmName","realm","useRealm","config","save","useUserProfile","navigate","useNavigate","params","useParams","form","useForm","addError","useAlerts","editMode","matchingGroup","useMemo","name","useEffect","annotations","onSubmit","values","groups","updateAt","translation","groupValues","updatedGroup","saveTranslations","error","toUserProfile","jsxs","FormProvider","jsx","ViewHeader","PageSection","FormAccess","TextControl","FormGroup","HelpItem","TranslatableField","TextContent","Text","KeyValueInput","ActionGroup","Button","props","Link","AttributesGroupDetails","UserProfileProvider"],"mappings":"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"}