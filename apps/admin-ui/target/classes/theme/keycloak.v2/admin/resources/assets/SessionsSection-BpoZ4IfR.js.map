{"version":3,"file":"SessionsSection-BpoZ4IfR.js","sources":["../../../../../../../src/sessions/RevocationModal.tsx","../../../../../../../src/sessions/SessionsSection.tsx"],"sourcesContent":["import type GlobalRequestResult from \"@keycloak/keycloak-admin-client/lib/defs/globalRequestResult\";\r\nimport {\r\n  AlertVariant,\r\n  Button,\r\n  ButtonVariant,\r\n  Form,\r\n  FormGroup,\r\n  Modal,\r\n  ModalVariant,\r\n  TextContent,\r\n  TextInput,\r\n} from \"@patternfly/react-core\";\r\nimport { useForm } from \"react-hook-form\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { useAdminClient } from \"../admin-client\";\r\nimport { useAlerts } from \"@keycloak/keycloak-ui-shared\";\r\nimport { useRealm } from \"../context/realm-context/RealmContext\";\r\n\r\ntype RevocationModalProps = {\r\n  handleModalToggle: () => void;\r\n  save: () => void;\r\n};\r\n\r\nexport const RevocationModal = ({\r\n  handleModalToggle,\r\n  save,\r\n}: RevocationModalProps) => {\r\n  const { adminClient } = useAdminClient();\r\n\r\n  const { t } = useTranslation();\r\n  const { addAlert, addError } = useAlerts();\r\n\r\n  const { realm: realmName, realmRepresentation: realm, refresh } = useRealm();\r\n  const { register, handleSubmit } = useForm();\r\n\r\n  const parseResult = (result: GlobalRequestResult, prefixKey: string) => {\r\n    const successCount = result.successRequests?.length || 0;\r\n    const failedCount = result.failedRequests?.length || 0;\r\n\r\n    if (successCount === 0 && failedCount === 0) {\r\n      addAlert(t(\"noAdminUrlSet\"), AlertVariant.warning);\r\n    } else if (failedCount > 0) {\r\n      addAlert(\r\n        t(prefixKey + \"Success\", {\r\n          successNodes: result.successRequests,\r\n        }),\r\n        AlertVariant.success,\r\n      );\r\n      addAlert(\r\n        t(prefixKey + \"Fail\", {\r\n          failedNodes: result.failedRequests,\r\n        }),\r\n        AlertVariant.danger,\r\n      );\r\n    } else {\r\n      addAlert(\r\n        t(prefixKey + \"Success\", {\r\n          successNodes: result.successRequests,\r\n        }),\r\n        AlertVariant.success,\r\n      );\r\n    }\r\n  };\r\n\r\n  const setToNow = async () => {\r\n    try {\r\n      await adminClient.realms.update(\r\n        { realm: realmName },\r\n        {\r\n          realm: realmName,\r\n          notBefore: Date.now() / 1000,\r\n        },\r\n      );\r\n\r\n      addAlert(t(\"notBeforeSuccess\"), AlertVariant.success);\r\n    } catch (error) {\r\n      addError(\"setToNowError\", error);\r\n    }\r\n  };\r\n\r\n  const clearNotBefore = async () => {\r\n    try {\r\n      await adminClient.realms.update(\r\n        { realm: realmName },\r\n        {\r\n          realm: realmName,\r\n          notBefore: 0,\r\n        },\r\n      );\r\n      addAlert(t(\"notBeforeClearedSuccess\"), AlertVariant.success);\r\n      refresh();\r\n    } catch (error) {\r\n      addError(\"notBeforeError\", error);\r\n    }\r\n  };\r\n\r\n  const push = async () => {\r\n    const result = await adminClient.realms.pushRevocation({\r\n      realm: realmName,\r\n    });\r\n    parseResult(result, \"notBeforePush\");\r\n\r\n    refresh();\r\n  };\r\n\r\n  return (\r\n    <Modal\r\n      variant={ModalVariant.small}\r\n      title={t(\"revocation\")}\r\n      isOpen={true}\r\n      onClose={handleModalToggle}\r\n      actions={[\r\n        <Button\r\n          data-testid=\"set-to-now-button\"\r\n          key=\"set-to-now\"\r\n          variant=\"tertiary\"\r\n          onClick={async () => {\r\n            await setToNow();\r\n            handleModalToggle();\r\n          }}\r\n          form=\"revocation-modal-form\"\r\n        >\r\n          {t(\"setToNow\")}\r\n        </Button>,\r\n        <Button\r\n          data-testid=\"clear-not-before-button\"\r\n          key=\"clear\"\r\n          variant=\"tertiary\"\r\n          onClick={async () => {\r\n            await clearNotBefore();\r\n            handleModalToggle();\r\n          }}\r\n          form=\"revocation-modal-form\"\r\n        >\r\n          {t(\"clear\")}\r\n        </Button>,\r\n        <Button\r\n          data-testid=\"modal-test-connection-button\"\r\n          key=\"push\"\r\n          variant=\"secondary\"\r\n          onClick={async () => {\r\n            await push();\r\n            handleModalToggle();\r\n          }}\r\n          form=\"revocation-modal-form\"\r\n        >\r\n          {t(\"push\")}\r\n        </Button>,\r\n        <Button\r\n          id=\"modal-cancel\"\r\n          data-testid=\"cancel\"\r\n          key=\"cancel\"\r\n          variant={ButtonVariant.link}\r\n          onClick={() => {\r\n            handleModalToggle();\r\n          }}\r\n        >\r\n          {t(\"cancel\")}\r\n        </Button>,\r\n      ]}\r\n    >\r\n      <TextContent className=\"kc-revocation-description-text\">\r\n        {t(\"revocationDescription\")}\r\n      </TextContent>\r\n      <Form\r\n        id=\"revocation-modal-form\"\r\n        isHorizontal\r\n        onSubmit={handleSubmit(save)}\r\n      >\r\n        <FormGroup\r\n          className=\"kc-revocation-modal-form-group\"\r\n          label={t(\"notBefore\")}\r\n          name=\"notBefore\"\r\n          fieldId=\"not-before\"\r\n        >\r\n          <TextInput\r\n            data-testid=\"not-before-input\"\r\n            autoFocus\r\n            readOnly\r\n            value={\r\n              realm?.notBefore === 0\r\n                ? (t(\"none\") as string)\r\n                : new Date(realm?.notBefore! * 1000).toString()\r\n            }\r\n            type=\"text\"\r\n            id=\"not-before\"\r\n            {...register(\"notBefore\")}\r\n          />\r\n        </FormGroup>\r\n      </Form>\r\n    </Modal>\r\n  );\r\n};\r\n","import UserSessionRepresentation from \"@keycloak/keycloak-admin-client/lib/defs/userSessionRepresentation\";\r\nimport { KeycloakSelect } from \"@keycloak/keycloak-ui-shared\";\r\nimport {\r\n  DropdownItem,\r\n  PageSection,\r\n  SelectOption,\r\n} from \"@patternfly/react-core\";\r\nimport { FilterIcon } from \"@patternfly/react-icons\";\r\nimport { useState } from \"react\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { useAdminClient } from \"../admin-client\";\r\nimport { useAlerts } from \"@keycloak/keycloak-ui-shared\";\r\nimport { useConfirmDialog } from \"../components/confirm-dialog/ConfirmDialog\";\r\nimport { ViewHeader } from \"../components/view-header/ViewHeader\";\r\nimport { fetchAdminUI } from \"../context/auth/admin-ui-endpoint\";\r\nimport { useRealm } from \"../context/realm-context/RealmContext\";\r\nimport helpUrls from \"../help-urls\";\r\nimport useToggle from \"../utils/useToggle\";\r\nimport { RevocationModal } from \"./RevocationModal\";\r\nimport SessionsTable from \"./SessionsTable\";\r\n\r\nimport \"./SessionsSection.css\";\r\n\r\ntype FilterType = \"ALL\" | \"REGULAR\" | \"OFFLINE\";\r\n\r\ntype SessionFilterProps = {\r\n  filterType: FilterType;\r\n  onChange: (filterType: FilterType) => void;\r\n};\r\n\r\nconst SessionFilter = ({ filterType, onChange }: SessionFilterProps) => {\r\n  const { t } = useTranslation();\r\n\r\n  const [open, toggle] = useToggle();\r\n\r\n  return (\r\n    <KeycloakSelect\r\n      data-testid=\"filter-session-type-select\"\r\n      isOpen={open}\r\n      onToggle={toggle}\r\n      toggleIcon={<FilterIcon />}\r\n      onSelect={(value) => {\r\n        const filter = value as FilterType;\r\n        onChange(filter);\r\n        toggle();\r\n      }}\r\n      selections={filterType}\r\n    >\r\n      <SelectOption data-testid=\"all-sessions-option\" value=\"ALL\">\r\n        {t(\"sessionsType.allSessions\")}\r\n      </SelectOption>\r\n      <SelectOption data-testid=\"regular-sso-option\" value=\"REGULAR\">\r\n        {t(\"sessionsType.regularSSO\")}\r\n      </SelectOption>\r\n      <SelectOption data-testid=\"offline-option\" value=\"OFFLINE\">\r\n        {t(\"sessionsType.offline\")}\r\n      </SelectOption>\r\n    </KeycloakSelect>\r\n  );\r\n};\r\n\r\nexport default function SessionsSection() {\r\n  const { adminClient } = useAdminClient();\r\n\r\n  const { t } = useTranslation();\r\n\r\n  const [key, setKey] = useState(0);\r\n  const refresh = () => setKey(key + 1);\r\n  const { addError } = useAlerts();\r\n  const { realm } = useRealm();\r\n\r\n  const [revocationModalOpen, setRevocationModalOpen] = useState(false);\r\n  const [filterType, setFilterType] = useState<FilterType>(\"ALL\");\r\n  const [noSessions, setNoSessions] = useState(false);\r\n\r\n  const handleRevocationModalToggle = () => {\r\n    setRevocationModalOpen(!revocationModalOpen);\r\n  };\r\n\r\n  const loader = async (first?: number, max?: number, search?: string) => {\r\n    const data = await fetchAdminUI<UserSessionRepresentation[]>(\r\n      adminClient,\r\n      \"ui-ext/sessions\",\r\n      {\r\n        first: `${first}`,\r\n        max: `${max}`,\r\n        type: filterType,\r\n        search: search || \"\",\r\n      },\r\n    );\r\n    setNoSessions(data.length === 0);\r\n    return data;\r\n  };\r\n\r\n  const [toggleLogoutDialog, LogoutConfirm] = useConfirmDialog({\r\n    titleKey: \"logoutAllSessions\",\r\n    messageKey: \"logoutAllDescription\",\r\n    continueButtonLabel: \"confirm\",\r\n    onConfirm: async () => {\r\n      try {\r\n        await adminClient.realms.logoutAll({ realm });\r\n        refresh();\r\n      } catch (error) {\r\n        addError(\"logoutAllSessionsError\", error);\r\n      }\r\n    },\r\n  });\r\n\r\n  return (\r\n    <>\r\n      <LogoutConfirm />\r\n      <ViewHeader\r\n        dropdownItems={[\r\n          <DropdownItem\r\n            key=\"toggle-modal\"\r\n            data-testid=\"revocation\"\r\n            component=\"button\"\r\n            onClick={() => handleRevocationModalToggle()}\r\n          >\r\n            {t(\"revocation\")}\r\n          </DropdownItem>,\r\n          <DropdownItem\r\n            key=\"delete-role\"\r\n            data-testid=\"logout-all\"\r\n            component=\"button\"\r\n            isDisabled={noSessions}\r\n            onClick={toggleLogoutDialog}\r\n          >\r\n            {t(\"signOutAllActiveSessions\")}\r\n          </DropdownItem>,\r\n        ]}\r\n        titleKey=\"titleSessions\"\r\n        subKey=\"sessionExplain\"\r\n        helpUrl={helpUrls.sessionsUrl}\r\n      />\r\n      <PageSection variant=\"light\" className=\"pf-v5-u-p-0\">\r\n        {revocationModalOpen && (\r\n          <RevocationModal\r\n            handleModalToggle={handleRevocationModalToggle}\r\n            save={() => {\r\n              handleRevocationModalToggle();\r\n            }}\r\n          />\r\n        )}\r\n        <SessionsTable\r\n          key={key}\r\n          loader={loader}\r\n          isSearching={filterType !== \"ALL\"}\r\n          isPaginated\r\n          filter={\r\n            <SessionFilter\r\n              filterType={filterType}\r\n              onChange={(type) => {\r\n                setFilterType(type);\r\n                refresh();\r\n              }}\r\n            />\r\n          }\r\n        />\r\n      </PageSection>\r\n    </>\r\n  );\r\n}\r\n"],"names":["RevocationModal","handleModalToggle","save","adminClient","useAdminClient","useTranslation","addAlert","addError","useAlerts","realmName","realm","refresh","useRealm","register","handleSubmit","useForm","parseResult","result","prefixKey","successCount","failedCount","AlertVariant","setToNow","error","clearNotBefore","push","jsxs","Modal","ModalVariant","jsx","Button","ButtonVariant","TextContent","Form","FormGroup","TextInput","SessionFilter","filterType","onChange","t","open","toggle","useToggle","KeycloakSelect","FilterIcon","value","SelectOption","SessionsSection","key","setKey","useState","revocationModalOpen","setRevocationModalOpen","setFilterType","noSessions","setNoSessions","handleRevocationModalToggle","loader","first","max","search","data","fetchAdminUI","toggleLogoutDialog","LogoutConfirm","useConfirmDialog","Fragment","ViewHeader","DropdownItem","helpUrls","PageSection","SessionsTable","type"],"mappings":"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"}