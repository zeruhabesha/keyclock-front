import{jsx as e,jsxs as l,Fragment as v}from"react/jsx-runtime";import{V as Ce}from"./ViewHeader-BDBsroi3.js";import{a as D,aM as me,aN as he,al as be,D as $,_ as pe,j as Ue,fa as Te,H,I as L,J as W,aW as Ne,bw as fe,bx as z,a3 as ne,g as F,eP as xe,cc as Ie,A as Se,B as Y,bp as De,bq as we,ak as Ee,cf as ie,o as B,aS as ge,T as P,a_ as Pe,cA as Fe,e3 as Ke,u as Ve,d as J,b as Re,y as _e,fb as Oe,eV as Le,p as Be,x as qe,aY as Q,a8 as je,a9 as Ge,ab as Me,v as We,L as $e,bT as He,aL as ye,ba as ze,fc as Qe,at as le,bS as Ye,aD as Je,Y as Ze,Z as Xe,an as et,ao as tt,ap as rt,P as at,dP as oe}from"./main-o1hptXRo.js";import{P as st}from"./PermissionTab-CNBT0MGG.js";import{useState as f}from"react";import{u as ce}from"./ConfirmDialog-BkU7melV.js";import{b as nt}from"./RoleMapping-BOcI-Nkp.js";import{F as it}from"./filter-icon-DYNmdQ7O.js";import{D as lt}from"./DropdownPanel-vRJu3PnV.js";import{W as Ae}from"./warning-triangle-icon-Cc02WUGl.js";import{u as ot,R as ct}from"./RoutableTabs-DyhWhd6v.js";/* empty css                     */import{a as ue,b as de}from"./Tabs-DSwQhKoJ.js";import"react-dom";import"./useLocaleSort-C-diWts5.js";import"./Trans-CicUNvCL.js";import"./translationFormatter-DQJeO7lr.js";import"./PageHandler-B1ed5nYb.js";import"./DynamicComponents-CnLlz98z.js";import"./ClientSelect-BY77LEpN.js";import"./IdentityProviderSelect-rmWlUbIg.js";import"./GroupPickerDialog-U3luvxlw.js";import"./DataListItemRow-B_0B-ko6.js";import"./ActionListItem-Cy-NQlq4.js";import"./MultiLineInput-OP0faqms.js";import"./CodeEditor-C4IS5oxi.js";import"./useParams-CGVhlaFZ.js";import"./constants-BclHbWtx.js";const ut=({searchType:t,onSelect:a})=>{const{t:u}=D(),[m,p]=f(!1),n=i=>e($,{onClick:()=>{a(i),p(!1)},children:u(`searchType.${i}`)},i),A=[n("default"),n("attribute")];return e(me,{className:"keycloak__users__searchtype",onOpenChange:i=>p(i),toggle:i=>e(be,{"data-testid":"user-search-toggle",ref:i,id:"toggle-id",onClick:()=>p(!m),icon:e(it,{}),children:u(`searchType.${t}`)}),isOpen:m,children:e(he,{children:A})})};function dt({activeFilters:t,setActiveFilters:a,profile:u,createAttributeSearchChips:m,searchUserWithAttributes:p}){const{t:n}=D(),{addAlert:A}=pe(),[i,k]=f(!1),C={name:"",displayName:"",value:""},{getValues:h,register:g,reset:U,formState:{errors:b},setValue:K,setError:T,clearErrors:R}=Ue({mode:"onChange",defaultValues:C}),d=()=>t.userAttribute.some(s=>s.name===h().name),o=()=>{let s=!1;return h().name.length?t.userAttribute.some(c=>c.name===h().name)?T("name",{type:"conflict",message:n("searchUserByAttributeKeyAlreadyInUseError")}):s=!0:T("name",{type:"empty",message:n("searchUserByAttributeMissingKeyError")}),s},N=()=>{let s=!1;return h().value.length?s=!0:T("value",{type:"empty",message:n("searchUserByAttributeMissingValueError")}),s},x=()=>o()&&N(),w=()=>{x()?(a({...t,userAttribute:[...t.userAttribute,{...h()}]}),U(C)):(b.name?.message&&A(b.name.message,B.danger),b.value?.message&&A(b.value.message,B.danger))},E=()=>{const s=[...t.userAttribute].filter(c=>c.name!==c.name);a({...t,userAttribute:s})},V=()=>u?e(De,{"data-testid":"search-attribute-name-select",variant:we.typeahead,onToggle:s=>k(s),selections:h().displayName,onSelect:s=>{K("displayName",s.toString()),d()?T("name",{type:"conflict"}):R("name")},isOpen:i,placeholderText:n("selectAttribute"),validated:b.name&&"error",maxHeight:300,...g("displayName",{required:!0,validate:o}),children:u.attributes?.map(s=>e(Ee,{value:ie(n,s.displayName,s.name),onClick:c=>{c.stopPropagation(),k(!1),K("name",s.name)},children:ie(n,s.displayName,s.name)},s.name))}):e(ne,{id:"name",placeholder:n("keyPlaceholder"),validated:b.name&&"error",onKeyDown:s=>s.key==="Enter"&&w(),...g("name",{required:!0,validate:o})});return l(Te,{className:"user-attribute-search-form","data-testid":"user-attribute-search-form",children:[e(H,{className:"user-attribute-search-form-headline",children:e(L,{component:W.h2,children:n("selectAttributes")})}),e(Ne,{isInline:!0,className:"user-attribute-search-form-alert",variant:"info",title:n("searchUserByAttributeDescription"),component:"h3"}),l(H,{className:"user-attribute-search-form-key-value",children:[e("div",{className:"user-attribute-search-form-left",children:e(L,{component:W.h3,children:n("key")})}),e("div",{className:"user-attribute-search-form-right",children:e(L,{component:W.h3,children:n("value")})})]}),e("div",{className:"user-attribute-search-form-left",children:V()}),e("div",{className:"user-attribute-search-form-right",children:l(fe,{children:[e(z,{children:e(ne,{id:"value",placeholder:n("valuePlaceholder"),validated:b.value&&"error",onKeyDown:s=>{s.key==="Enter"&&(s.preventDefault(),w())},...g("value",{required:!0,validate:N})})}),e(z,{children:e(F,{"data-testid":"user-attribute-search-add-filter-button",variant:"control",icon:e(xe,{}),onClick:w,"aria-label":n("addToFilter")})})]})}),m(),e("div",{className:"pf-v5-u-pt-lg",children:e(Ie,{id:"exact","data-testid":"exact",label:n("exactSearch"),isChecked:t.exact,onChange:(s,c)=>{a({...t,exact:c})}})}),l(Se,{className:"user-attribute-search-form-action-group",children:[e(F,{"data-testid":"search-user-attribute-btn",variant:"primary",type:"submit",isDisabled:!t.userAttribute.length,onClick:p,children:n("search")}),e(F,{variant:Y.link,onClick:()=>{U(),E()},children:n("reset")})]})]})}function mt({searchDropdownOpen:t,setSearchDropdownOpen:a,realm:u,hasSelectedRows:m,toggleDeleteDialog:p,toggleUnlockUsersDialog:n,goToCreate:A,searchType:i,setSearchType:k,searchUser:C,setSearchUser:h,activeFilters:g,setActiveFilters:U,refresh:b,profile:K,clearAllFilters:T,createAttributeSearchChips:R,searchUserWithAttributes:d}){const{t:o}=D(),[N,x]=f(!1),{hasAccess:w}=ge(),E=w("query-users"),V=()=>e(P,{children:l(fe,{children:[e(z,{children:e(ut,{searchType:i,onSelect:y=>{T(),k(y)}})}),i==="default"&&s(),i==="attribute"&&c()]})}),s=()=>e(P,{children:e(Fe,{"data-testid":"table-search-input",placeholder:o("searchForUser"),"aria-label":o("search"),value:C,onSearch:(y,_,G)=>{h(G.haswords),b()},onKeyDown:y=>{if(y.key==="Enter"){const _=y.target;h(_.value),b()}},onClear:()=>{h(""),b()}})}),c=()=>l(v,{children:[e(lt,{"data-testid":"select-attributes-dropdown",buttonText:o("selectAttributes"),setSearchDropdownOpen:a,searchDropdownOpen:t,width:"15vw",children:e(dt,{activeFilters:g,setActiveFilters:U,profile:K,createAttributeSearchChips:R,searchUserWithAttributes:()=>{d(),a(!1)}})}),e(F,{icon:e(Ke,{}),variant:"control",onClick:()=>{d(),a(!1)},"aria-label":o("searchAttributes")})]}),q=u.bruteForceProtected?e(P,{children:e(me,{onOpenChange:y=>x(y),toggle:y=>e(be,{ref:y,isExpanded:N,variant:"plain",onClick:()=>x(!N),children:e(Pe,{})}),isOpen:N,shouldFocusToggleOnSelect:!0,children:l(he,{children:[e($,{component:"button",isDisabled:m,onClick:()=>{p(),x(!1)},children:o("deleteUser")},"deleteUser"),e($,{component:"button",onClick:()=>{n(),x(!1)},children:o("unlockAllUsers")},"unlock")]})})}):e(P,{children:e(F,{variant:Y.link,onClick:p,"data-testid":"delete-user-btn",isDisabled:m,children:o("deleteUser")})}),j=l(v,{children:[e(P,{children:e(F,{"data-testid":"add-user",onClick:A,children:o("addUser")})}),q]});return l(v,{children:[V(),E?j:null]})}const ht=t=>{const{t:a}=D(),{realm:u}=J();return l(v,{children:[l($e,{to:He({realm:u,id:t.id,tab:"settings"}),children:[t.username,e(bt,{user:t})]}),t.attributes?.is_temporary_admin?.[0]==="true"&&e(ye,{content:a("temporaryAdmin"),children:e(Ae,{className:"pf-v5-u-ml-sm",id:"temporary-admin-label"})})]})},bt=({user:t})=>{const{t:a}=D();return l(v,{children:[!t.enabled&&e(le,{color:"red",icon:e(Ye,{}),children:a("disabled")}),t.bruteForceStatus?.disabled&&e(le,{color:"orange",icon:e(Ae,{}),children:a("temporaryLocked")})]})},pt=t=>{const{t:a}=D();return l(v,{children:[!t.emailVerified&&e(ye,{content:a("notVerified"),children:e(ze,{className:"keycloak__user-section__email-verified"})})," ",Q()(t.email)]})};function ft(){const{adminClient:t}=Ve(),{t:a}=D(),{addAlert:u,addError:m}=pe(),{realm:p,realmRepresentation:n}=J(),A=Re(),[i,k]=f({}),[C,h]=f(""),[g,U]=f([]),[b,K]=f("default"),[T,R]=f(!1),[d,o]=f({exact:!1,userAttribute:[]}),[N,x]=f({}),[w,E]=f(""),[V,s]=f(0),c=()=>s(V+1);_e(async()=>{try{return await Promise.all([Oe(t),t.users.getProfile()])}catch(r){if(r instanceof Le&&r?.response?.status===403)return[{},{}];throw r}},([r,I])=>{k(r),x(I)},[]);const q=async(r,I,ae)=>{const S={first:r,max:I,q:w},O=ae||C||"";if(O&&(S.search=O),d.exact&&(S.exact=!0),!X&&!(S.search||S.q))return[];try{return await nt(t,{briefRepresentation:!0,...S})}catch(se){return i.userProfileProvidersEnabled?m("noUsersFoundErrorStorage",se):m("noUsersFoundError",se),[]}},[j,y]=ce({titleKey:"unlockAllUsers",messageKey:"unlockUsersConfirm",continueButtonLabel:"unlock",onConfirm:async()=>{try{await t.attackDetection.delAll(),c(),u(a("unlockUsersSuccess"),B.success)}catch(r){m("unlockUsersError",r)}}}),[_,G]=ce({titleKey:a("deleteConfirmUsers",{count:g.length,name:g[0]?.username}),messageKey:a("deleteConfirmDialog",{count:g.length}),continueButtonLabel:"delete",continueButtonVariant:Y.danger,onConfirm:async()=>{try{for(const r of g)await t.users.del({id:r.id});U([]),M(),u(a("userDeletedSuccess"),B.success)}catch(r){m("userDeletedError",r)}}}),Z=()=>A(Qe({realm:p}));if(i.userProfileProvidersEnabled===void 0||!n)return e(Be,{});const X=!i.userProfileProvidersEnabled,M=()=>{o({exact:!1,userAttribute:[]}),h(""),E(""),c()},ee=r=>r.userAttribute.map(I=>`${I.name}:${I.value}`).join(" "),ve=()=>{const r=ee(d);E(r),c()},te=()=>e(Je,{children:d.userAttribute.length>0&&e(v,{children:Object.values(d.userAttribute).map(r=>e(Ze,{className:"pf-v5-u-mt-md pf-v5-u-mr-md","data-testid":"user-attribute-search-chips-group",categoryName:r.displayName.length?r.displayName:r.name,isClosable:!0,onClick:I=>{I.stopPropagation();const S={userAttribute:[...d.userAttribute].filter(O=>O.name!==r.name),exact:d.exact};o(S),E(ee(S)),c()},children:e(Xe,{isReadOnly:!0,children:r.value},r.name)},r.name))})}),re=()=>e(mt,{searchDropdownOpen:T,setSearchDropdownOpen:R,realm:n,hasSelectedRows:g.length===0,toggleDeleteDialog:_,toggleUnlockUsersDialog:j,goToCreate:Z,searchType:b,setSearchType:K,searchUser:C,setSearchUser:h,activeFilters:d,setActiveFilters:o,refresh:c,profile:N,clearAllFilters:M,createAttributeSearchChips:te,searchUserWithAttributes:ve}),ke=()=>{if(d.userAttribute.length)return l("div",{className:"user-attribute-search-form-subtoolbar",children:[e(P,{children:te()}),e(P,{children:e(F,{variant:"link",onClick:()=>{M()},children:a("clearAllFilters")})})]})};return l(v,{children:[e(G,{}),e(y,{}),e(qe,{isSearching:C!==""||d.userAttribute.length!==0,loader:q,isPaginated:!0,ariaLabelKey:"titleUsers",canSelectAll:!0,onSelect:r=>U([...r]),emptyState:X?e(We,{message:a("noUsersFound"),instructions:a("emptyInstructions"),primaryActionText:a("createNewUser"),onPrimaryAction:Z}):l(v,{children:[e(je,{children:e(Ge,{children:re()})}),e(Me,{"data-testid":"empty-state",variant:"lg",children:e(H,{className:"kc-search-users-text",children:e(L,{children:a("searchForUserDescription")})})})]}),toolbarItem:re(),subToolbar:ke(),actionResolver:r=>[{title:a("delete"),onClick:()=>{U([r.data]),_()}}],isRowDisabled:r=>!r.access?.manage,columns:[{name:"username",displayKey:"username",cellRenderer:ht},{name:"email",displayKey:"email",cellRenderer:pt},{name:"lastName",displayKey:"lastName",cellFormatters:[Q()]},{name:"firstName",displayKey:"firstName",cellFormatters:[Q()]}]},V)]})}function Wt(){const{t}=D(),{realm:a}=J(),{hasAccess:u}=ge(),p=et()(tt.AdminFineGrainedAuthz)&&u("manage-authorization","manage-users","manage-clients"),n=k=>ot(oe({realm:a,tab:k})),A=n("list"),i=n("permissions");return l(v,{children:[e(Ce,{titleKey:"titleUsers",subKey:"usersExplain",helpUrl:rt.usersUrl,divider:!1}),e(at,{"data-testid":"users-page",variant:"light",className:"pf-v5-u-p-0",children:l(ct,{"data-testid":"user-tabs",defaultLocation:oe({realm:a,tab:"list"}),isBox:!0,mountOnEnter:!0,children:[e(ue,{id:"list","data-testid":"listTab",title:e(de,{children:t("userList")}),...A,children:e(ft,{})}),p&&e(ue,{id:"permissions","data-testid":"permissionsTab",title:e(de,{children:t("permissions")}),...i,children:e(st,{type:"users"})})]})})]})}export{Wt as default};
//# sourceMappingURL=UsersSection-4-OFtKS4.js.map
