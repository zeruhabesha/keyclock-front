{"version":3,"file":"EditClientScope-hsJ1BW_a.js","sources":["../../../../../../../src/client-scopes/EditClientScope.tsx"],"sourcesContent":["import ClientScopeRepresentation from \"@keycloak/keycloak-admin-client/lib/defs/clientScopeRepresentation\";\r\nimport type ProtocolMapperRepresentation from \"@keycloak/keycloak-admin-client/lib/defs/protocolMapperRepresentation\";\r\nimport type { RoleMappingPayload } from \"@keycloak/keycloak-admin-client/lib/defs/roleRepresentation\";\r\nimport type { ProtocolMapperTypeRepresentation } from \"@keycloak/keycloak-admin-client/lib/defs/serverInfoRepesentation\";\r\nimport {\r\n  KeycloakSpinner,\r\n  useAlerts,\r\n  useFetch,\r\n  useHelp,\r\n} from \"@keycloak/keycloak-ui-shared\";\r\nimport {\r\n  Alert,\r\n  AlertVariant,\r\n  ButtonVariant,\r\n  DropdownItem,\r\n  PageSection,\r\n  Tab,\r\n  TabTitleText,\r\n} from \"@patternfly/react-core\";\r\nimport { useState } from \"react\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { useNavigate } from \"react-router-dom\";\r\nimport { useAdminClient } from \"../admin-client\";\r\nimport {\r\n  AllClientScopes,\r\n  ClientScope,\r\n  ClientScopeDefaultOptionalType,\r\n  changeScope,\r\n} from \"../components/client-scope/ClientScopeTypes\";\r\nimport { useConfirmDialog } from \"../components/confirm-dialog/ConfirmDialog\";\r\nimport { RoleMapping, Row } from \"../components/role-mapping/RoleMapping\";\r\nimport {\r\n  RoutableTabs,\r\n  useRoutableTab,\r\n} from \"../components/routable-tabs/RoutableTabs\";\r\nimport { ViewHeader } from \"../components/view-header/ViewHeader\";\r\nimport { useRealm } from \"../context/realm-context/RealmContext\";\r\nimport { convertFormValuesToObject } from \"../util\";\r\nimport { useParams } from \"../utils/useParams\";\r\nimport { MapperList } from \"./details/MapperList\";\r\nimport { ScopeForm } from \"./details/ScopeForm\";\r\nimport { ClientScopeParams, toClientScope } from \"./routes/ClientScope\";\r\nimport { toClientScopes } from \"./routes/ClientScopes\";\r\nimport { toMapper } from \"./routes/Mapper\";\r\nimport { useAccess } from \"../context/access/Access\";\r\nimport { AdminEvents } from \"../events/AdminEvents\";\r\n\r\nexport default function EditClientScope() {\r\n  const { adminClient } = useAdminClient();\r\n\r\n  const { t } = useTranslation();\r\n  const navigate = useNavigate();\r\n  const { realm, realmRepresentation } = useRealm();\r\n  const { id } = useParams<ClientScopeParams>();\r\n  const { addAlert, addError } = useAlerts();\r\n  const { enabled } = useHelp();\r\n  const [clientScope, setClientScope] =\r\n    useState<ClientScopeDefaultOptionalType>();\r\n  const [key, setKey] = useState(0);\r\n  const refresh = () => setKey(key + 1);\r\n  const { hasAccess } = useAccess();\r\n\r\n  useFetch(\r\n    async () => {\r\n      const clientScope = await adminClient.clientScopes.findOne({ id });\r\n\r\n      if (!clientScope) {\r\n        throw new Error(t(\"notFound\"));\r\n      }\r\n\r\n      return {\r\n        ...clientScope,\r\n        type: await determineScopeType(clientScope),\r\n      };\r\n    },\r\n    (clientScope) => {\r\n      setClientScope(clientScope);\r\n    },\r\n    [key, id],\r\n  );\r\n\r\n  async function determineScopeType(clientScope: ClientScopeRepresentation) {\r\n    const defaultScopes =\r\n      await adminClient.clientScopes.listDefaultClientScopes();\r\n    const hasDefaultScope = defaultScopes.find(\r\n      (defaultScope) => defaultScope.name === clientScope.name,\r\n    );\r\n\r\n    if (hasDefaultScope) {\r\n      return ClientScope.default;\r\n    }\r\n\r\n    const optionalScopes =\r\n      await adminClient.clientScopes.listDefaultOptionalClientScopes();\r\n    const hasOptionalScope = optionalScopes.find(\r\n      (optionalScope) => optionalScope.name === clientScope.name,\r\n    );\r\n\r\n    return hasOptionalScope ? ClientScope.optional : AllClientScopes.none;\r\n  }\r\n\r\n  const settingsTab = useRoutableTab(\r\n    toClientScope({ realm, id, tab: \"settings\" }),\r\n  );\r\n  const mappersTab = useRoutableTab(\r\n    toClientScope({ realm, id, tab: \"mappers\" }),\r\n  );\r\n  const scopeTab = useRoutableTab(toClientScope({ realm, id, tab: \"scope\" }));\r\n  const eventsTab = useRoutableTab(toClientScope({ realm, id, tab: \"events\" }));\r\n\r\n  const onSubmit = async (formData: ClientScopeDefaultOptionalType) => {\r\n    const clientScope = convertFormValuesToObject({\r\n      ...formData,\r\n      name: formData.name?.trim().replace(/ /g, \"_\"),\r\n    });\r\n\r\n    try {\r\n      await adminClient.clientScopes.update({ id }, clientScope);\r\n      await changeScope(adminClient, { ...clientScope, id }, clientScope.type);\r\n\r\n      addAlert(t(\"updateSuccessClientScope\"), AlertVariant.success);\r\n    } catch (error) {\r\n      addError(\"updateErrorClientScope\", error);\r\n    }\r\n  };\r\n\r\n  const [toggleDeleteDialog, DeleteConfirm] = useConfirmDialog({\r\n    titleKey: t(\"deleteClientScope\", {\r\n      count: 1,\r\n      name: clientScope?.name,\r\n    }),\r\n    messageKey: \"deleteConfirmClientScopes\",\r\n    continueButtonLabel: \"delete\",\r\n    continueButtonVariant: ButtonVariant.danger,\r\n    onConfirm: async () => {\r\n      try {\r\n        await adminClient.clientScopes.del({ id });\r\n        addAlert(t(\"deletedSuccessClientScope\"), AlertVariant.success);\r\n        navigate(toClientScopes({ realm }));\r\n      } catch (error) {\r\n        addError(\"deleteErrorClientScope\", error);\r\n      }\r\n    },\r\n  });\r\n\r\n  const assignRoles = async (rows: Row[]) => {\r\n    try {\r\n      const realmRoles = rows\r\n        .filter((row) => row.client === undefined)\r\n        .map((row) => row.role as RoleMappingPayload)\r\n        .flat();\r\n      await adminClient.clientScopes.addRealmScopeMappings(\r\n        {\r\n          id,\r\n        },\r\n        realmRoles,\r\n      );\r\n      await Promise.all(\r\n        rows\r\n          .filter((row) => row.client !== undefined)\r\n          .map((row) =>\r\n            adminClient.clientScopes.addClientScopeMappings(\r\n              {\r\n                id,\r\n                client: row.client!.id!,\r\n              },\r\n              [row.role as RoleMappingPayload],\r\n            ),\r\n          ),\r\n      );\r\n      addAlert(t(\"roleMappingUpdatedSuccess\"), AlertVariant.success);\r\n    } catch (error) {\r\n      addError(\"roleMappingUpdatedError\", error);\r\n    }\r\n  };\r\n\r\n  const addMappers = async (\r\n    mappers: ProtocolMapperTypeRepresentation | ProtocolMapperRepresentation[],\r\n  ): Promise<void> => {\r\n    if (!Array.isArray(mappers)) {\r\n      const mapper = mappers as ProtocolMapperTypeRepresentation;\r\n      navigate(\r\n        toMapper({\r\n          realm,\r\n          id: clientScope!.id!,\r\n          mapperId: mapper.id!,\r\n          viewMode: \"new\",\r\n        }),\r\n      );\r\n    } else {\r\n      try {\r\n        await adminClient.clientScopes.addMultipleProtocolMappers(\r\n          { id: clientScope!.id! },\r\n          mappers as ProtocolMapperRepresentation[],\r\n        );\r\n        refresh();\r\n        addAlert(t(\"mappingCreatedSuccess\"), AlertVariant.success);\r\n      } catch (error) {\r\n        addError(\"mappingCreatedError\", error);\r\n      }\r\n    }\r\n  };\r\n\r\n  const onDelete = async (mapper: ProtocolMapperRepresentation) => {\r\n    try {\r\n      await adminClient.clientScopes.delProtocolMapper({\r\n        id: clientScope!.id!,\r\n        mapperId: mapper.id!,\r\n      });\r\n      addAlert(t(\"mappingDeletedSuccess\"), AlertVariant.success);\r\n      refresh();\r\n    } catch (error) {\r\n      addError(\"mappingDeletedError\", error);\r\n    }\r\n    return true;\r\n  };\r\n\r\n  if (!clientScope) {\r\n    return <KeycloakSpinner />;\r\n  }\r\n\r\n  return (\r\n    <>\r\n      <DeleteConfirm />\r\n      <ViewHeader\r\n        titleKey={clientScope.name!}\r\n        dropdownItems={[\r\n          <DropdownItem key=\"delete\" onClick={toggleDeleteDialog}>\r\n            {t(\"delete\")}\r\n          </DropdownItem>,\r\n        ]}\r\n        badges={[{ text: clientScope.protocol }]}\r\n        divider={false}\r\n      />\r\n\r\n      <PageSection variant=\"light\" className=\"pf-v5-u-p-0\">\r\n        <RoutableTabs isBox mountOnEnter unmountOnExit>\r\n          <Tab\r\n            id=\"settings\"\r\n            data-testid=\"settings\"\r\n            title={<TabTitleText>{t(\"settings\")}</TabTitleText>}\r\n            {...settingsTab}\r\n          >\r\n            <PageSection variant=\"light\">\r\n              <ScopeForm save={onSubmit} clientScope={clientScope} />\r\n            </PageSection>\r\n          </Tab>\r\n          <Tab\r\n            id=\"mappers\"\r\n            data-testid=\"mappers\"\r\n            title={<TabTitleText>{t(\"mappers\")}</TabTitleText>}\r\n            {...mappersTab}\r\n          >\r\n            <MapperList\r\n              model={clientScope}\r\n              onAdd={addMappers}\r\n              onDelete={onDelete}\r\n              detailLink={(id) =>\r\n                toMapper({\r\n                  realm,\r\n                  id: clientScope.id!,\r\n                  mapperId: id!,\r\n                  viewMode: \"edit\",\r\n                })\r\n              }\r\n            />\r\n          </Tab>\r\n          <Tab\r\n            id=\"scope\"\r\n            data-testid=\"scopeTab\"\r\n            title={<TabTitleText>{t(\"scope\")}</TabTitleText>}\r\n            {...scopeTab}\r\n          >\r\n            {enabled && (\r\n              <PageSection>\r\n                <Alert\r\n                  variant=\"info\"\r\n                  isInline\r\n                  title={t(\"clientScopesRolesScope\")}\r\n                  component=\"h2\"\r\n                />\r\n              </PageSection>\r\n            )}\r\n            <RoleMapping\r\n              id={clientScope.id!}\r\n              name={clientScope.name!}\r\n              type=\"clientScopes\"\r\n              save={assignRoles}\r\n            />\r\n          </Tab>\r\n          {realmRepresentation?.adminEventsEnabled &&\r\n            hasAccess(\"view-events\") && (\r\n              <Tab\r\n                data-testid=\"admin-events-tab\"\r\n                title={<TabTitleText>{t(\"adminEvents\")}</TabTitleText>}\r\n                {...eventsTab}\r\n              >\r\n                <AdminEvents resourcePath={`*client-scopes/${id}`} />\r\n              </Tab>\r\n            )}\r\n        </RoutableTabs>\r\n      </PageSection>\r\n    </>\r\n  );\r\n}\r\n"],"names":["EditClientScope","adminClient","useAdminClient","t","useTranslation","navigate","useNavigate","realm","realmRepresentation","useRealm","id","useParams","addAlert","addError","useAlerts","enabled","useHelp","clientScope","setClientScope","useState","key","setKey","refresh","hasAccess","useAccess","useFetch","determineScopeType","defaultScope","ClientScope","optionalScope","AllClientScopes","settingsTab","useRoutableTab","toClientScope","mappersTab","scopeTab","eventsTab","onSubmit","formData","convertFormValuesToObject","changeScope","AlertVariant","error","toggleDeleteDialog","DeleteConfirm","useConfirmDialog","ButtonVariant","toClientScopes","assignRoles","rows","realmRoles","row","addMappers","mappers","mapper","toMapper","onDelete","jsxs","Fragment","jsx","ViewHeader","DropdownItem","PageSection","RoutableTabs","Tab","TabTitleText","ScopeForm","MapperList","Alert","RoleMapping","AdminEvents","KeycloakSpinner"],"mappings":"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"}