{"version":3,"file":"AddSamlConnect-D-GjCb8w.js","sources":["../../../../../../../src/identity-providers/add/SamlConnectSettings.tsx","../../../../../../../src/identity-providers/add/AddSamlConnect.tsx"],"sourcesContent":["import { fetchWithError } from \"@keycloak/keycloak-admin-client\";\r\nimport type IdentityProviderRepresentation from \"@keycloak/keycloak-admin-client/lib/defs/identityProviderRepresentation\";\r\nimport {\r\n  FormErrorText,\r\n  HelpItem,\r\n  TextControl,\r\n  useEnvironment,\r\n} from \"@keycloak/keycloak-ui-shared\";\r\nimport { FormGroup, Title } from \"@patternfly/react-core\";\r\nimport { useFormContext } from \"react-hook-form\";\r\nimport { useTranslation } from \"react-i18next\";\r\n\r\nimport { useAdminClient } from \"../../admin-client\";\r\nimport { FileUploadForm } from \"../../components/json-file-upload/FileUploadForm\";\r\nimport { useRealm } from \"../../context/realm-context/RealmContext\";\r\nimport type { Environment } from \"../../environment\";\r\nimport { addTrailingSlash } from \"../../util\";\r\nimport { getAuthorizationHeaders } from \"../../utils/getAuthorizationHeaders\";\r\nimport { DiscoveryEndpointField } from \"../component/DiscoveryEndpointField\";\r\nimport { DescriptorSettings } from \"./DescriptorSettings\";\r\n\r\ntype FormFields = IdentityProviderRepresentation & {\r\n  discoveryError: string;\r\n};\r\n\r\nexport const SamlConnectSettings = () => {\r\n  const { adminClient } = useAdminClient();\r\n  const { environment } = useEnvironment<Environment>();\r\n\r\n  const { t } = useTranslation();\r\n  const id = \"saml\";\r\n\r\n  const { realm } = useRealm();\r\n  const {\r\n    setValue,\r\n    setError,\r\n    clearErrors,\r\n    formState: { errors },\r\n  } = useFormContext<FormFields>();\r\n\r\n  const setupForm = (result: IdentityProviderRepresentation) => {\r\n    Object.entries(result).map(([key, value]) =>\r\n      setValue(`config.${key}`, value),\r\n    );\r\n  };\r\n\r\n  const fileUpload = async (xml: string) => {\r\n    clearErrors(\"discoveryError\");\r\n    if (!xml) {\r\n      return;\r\n    }\r\n    const formData = new FormData();\r\n    formData.append(\"providerId\", id);\r\n    formData.append(\"file\", new Blob([xml]));\r\n\r\n    try {\r\n      const response = await fetchWithError(\r\n        `${addTrailingSlash(\r\n          adminClient.baseUrl,\r\n        )}admin/realms/${realm}/identity-provider/import-config`,\r\n        {\r\n          method: \"POST\",\r\n          body: formData,\r\n          headers: getAuthorizationHeaders(await adminClient.getAccessToken()),\r\n        },\r\n      );\r\n      if (response.ok) {\r\n        const result = await response.json();\r\n        setupForm(result);\r\n      } else {\r\n        setError(\"discoveryError\", {\r\n          type: \"manual\",\r\n          message: response.statusText,\r\n        });\r\n      }\r\n    } catch (error) {\r\n      setError(\"discoveryError\", {\r\n        type: \"manual\",\r\n        message: (error as Error).message,\r\n      });\r\n    }\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <Title headingLevel=\"h2\" size=\"xl\" className=\"kc-form-panel__title\">\r\n        {t(\"samlSettings\")}\r\n      </Title>\r\n\r\n      <TextControl\r\n        name=\"config.entityId\"\r\n        label={t(\"serviceProviderEntityId\")}\r\n        labelIcon={t(\"serviceProviderEntityIdHelp\")}\r\n        defaultValue={`${environment.serverBaseUrl}/realms/${realm}`}\r\n        rules={{\r\n          required: t(\"required\"),\r\n        }}\r\n      />\r\n\r\n      <DiscoveryEndpointField\r\n        id=\"saml\"\r\n        fileUpload={\r\n          <FormGroup\r\n            label={t(\"importConfig\")}\r\n            fieldId=\"kc-import-config\"\r\n            labelIcon={\r\n              <HelpItem\r\n                helpText={t(\"importConfigHelp\")}\r\n                fieldLabelId=\"importConfig\"\r\n              />\r\n            }\r\n          >\r\n            <FileUploadForm\r\n              id=\"kc-import-config\"\r\n              extension=\".xml\"\r\n              hideDefaultPreview\r\n              unWrap\r\n              validated={errors.discoveryError ? \"error\" : \"default\"}\r\n              onChange={(value) => fileUpload(value)}\r\n            />\r\n            {errors.discoveryError && (\r\n              <FormErrorText\r\n                message={errors.discoveryError.message as string}\r\n              />\r\n            )}\r\n          </FormGroup>\r\n        }\r\n      >\r\n        {(readonly) => <DescriptorSettings readOnly={readonly} />}\r\n      </DiscoveryEndpointField>\r\n    </>\r\n  );\r\n};\r\n","import type IdentityProviderRepresentation from \"@keycloak/keycloak-admin-client/lib/defs/identityProviderRepresentation\";\r\nimport {\r\n  ActionGroup,\r\n  AlertVariant,\r\n  Button,\r\n  PageSection,\r\n} from \"@patternfly/react-core\";\r\nimport { FormProvider, useForm } from \"react-hook-form\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { Link, useNavigate } from \"react-router-dom\";\r\nimport { useAdminClient } from \"../../admin-client\";\r\nimport { useAlerts } from \"@keycloak/keycloak-ui-shared\";\r\nimport { FormAccess } from \"../../components/form/FormAccess\";\r\nimport { ViewHeader } from \"../../components/view-header/ViewHeader\";\r\nimport { useRealm } from \"../../context/realm-context/RealmContext\";\r\nimport { toIdentityProvider } from \"../routes/IdentityProvider\";\r\nimport { toIdentityProviders } from \"../routes/IdentityProviders\";\r\nimport { SamlConnectSettings } from \"./SamlConnectSettings\";\r\nimport { SamlGeneralSettings } from \"./SamlGeneralSettings\";\r\n\r\ntype DiscoveryIdentityProvider = IdentityProviderRepresentation & {\r\n  discoveryEndpoint?: string;\r\n};\r\n\r\nexport default function AddSamlConnect() {\r\n  const { adminClient } = useAdminClient();\r\n\r\n  const { t } = useTranslation();\r\n  const navigate = useNavigate();\r\n  const id = \"saml\";\r\n\r\n  const form = useForm<DiscoveryIdentityProvider>({\r\n    defaultValues: { alias: id, config: { allowCreate: \"true\" } },\r\n    mode: \"onChange\",\r\n  });\r\n  const {\r\n    handleSubmit,\r\n    formState: { isDirty },\r\n  } = form;\r\n\r\n  const { addAlert, addError } = useAlerts();\r\n  const { realm } = useRealm();\r\n\r\n  const onSubmit = async (provider: DiscoveryIdentityProvider) => {\r\n    delete provider.discoveryEndpoint;\r\n    try {\r\n      await adminClient.identityProviders.create({\r\n        ...provider,\r\n        providerId: id,\r\n      });\r\n      addAlert(t(\"createIdentityProviderSuccess\"), AlertVariant.success);\r\n      navigate(\r\n        toIdentityProvider({\r\n          realm,\r\n          providerId: id,\r\n          alias: provider.alias!,\r\n          tab: \"settings\",\r\n        }),\r\n      );\r\n    } catch (error: any) {\r\n      addError(\"createIdentityProviderError\", error);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <ViewHeader titleKey={t(\"addSamlProvider\")} />\r\n      <PageSection variant=\"light\">\r\n        <FormProvider {...form}>\r\n          <FormAccess\r\n            role=\"manage-identity-providers\"\r\n            isHorizontal\r\n            onSubmit={handleSubmit(onSubmit)}\r\n          >\r\n            <SamlGeneralSettings />\r\n            <SamlConnectSettings />\r\n            <ActionGroup>\r\n              <Button\r\n                isDisabled={!isDirty}\r\n                variant=\"primary\"\r\n                type=\"submit\"\r\n                data-testid=\"createProvider\"\r\n              >\r\n                {t(\"add\")}\r\n              </Button>\r\n              <Button\r\n                variant=\"link\"\r\n                data-testid=\"cancel\"\r\n                component={(props) => (\r\n                  <Link {...props} to={toIdentityProviders({ realm })} />\r\n                )}\r\n              >\r\n                {t(\"cancel\")}\r\n              </Button>\r\n            </ActionGroup>\r\n          </FormAccess>\r\n        </FormProvider>\r\n      </PageSection>\r\n    </>\r\n  );\r\n}\r\n"],"names":["SamlConnectSettings","adminClient","useAdminClient","environment","useEnvironment","useTranslation","id","realm","useRealm","setValue","setError","clearErrors","errors","useFormContext","setupForm","result","key","value","fileUpload","xml","formData","response","fetchWithError","addTrailingSlash","getAuthorizationHeaders","error","jsxs","Fragment","jsx","Title","TextControl","DiscoveryEndpointField","FormGroup","HelpItem","FileUploadForm","FormErrorText","readonly","DescriptorSettings","AddSamlConnect","t","navigate","useNavigate","form","useForm","handleSubmit","isDirty","addAlert","addError","useAlerts","onSubmit","provider","AlertVariant","toIdentityProvider","ViewHeader","PageSection","FormProvider","FormAccess","SamlGeneralSettings","ActionGroup","Button","props","Link","toIdentityProviders"],"mappings":"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"}