import{jsx as e,jsxs as r,Fragment as D}from"react/jsx-runtime";import{aL as De,av as w,e8 as S,aw as Oe,e9 as _e,cn as ze,at as Se,ea as Be,g as $,eb as Ge,a as G,E as Me,H as Ee,I as F,j as re,C as oe,N as le,aM as Fe,l as ce,F as $e,Q as je,U as J,A as xe,al as Ke,M as Ue,k as We,aQ as Ae,bo as Re,ay as U,aK as k,aR as Ie,aP as I,J as He,aW as de,u as me,b as qe,_ as ue,d as Y,y as Ne,B as Qe,o as we,p as Je,P as pe,ec as X,aB as Ye,L as Xe,e7 as Ze,bs as et,T as fe,v as ne,ch as Z,cj as ee,aS as Le,bz as tt,a1 as st,a2 as be,bA as ge,bB as ye,ed as at,aE as it,e1 as nt,dU as W,n as Te,m as rt}from"./main-o1hptXRo.js";import*as u from"react";import{useState as L,useRef as ot,useEffect as ve,useMemo as Q}from"react";import{T as lt,c as ct,a as H,d as q,P as dt,A as mt}from"./Policies-7P-WRxCs.js";import{u as ut,C as pt}from"./ConfirmDialog-BkU7melV.js";import{u as te,R as ht}from"./RoutableTabs-DyhWhd6v.js";import{V as ft}from"./ViewHeader-BDBsroi3.js";import{R as bt,u as Ve,C as gt}from"./useSortedResourceTypes-DOYOPDde.js";import{c as Ce}from"./capitalize-_YB1UYl_.js";import{F as yt}from"./FormAccess-BnhQnYb9.js";import{U as Tt}from"./NewPolicyDialog-CIlfdiTN.js";import{s as se}from"./sortBy-DjlFeX8O.js";import{a as ae,b as ie}from"./Tabs-DSwQhKoJ.js";import"react-dom";import"./DescriptionListTerm-CNzJUZBE.js";import"./useIsAdminPermissionsClient-BY-AG4cQ.js";import"./PageHandler-B1ed5nYb.js";import"./DynamicComponents-CnLlz98z.js";import"./ClientSelect-BY77LEpN.js";import"./IdentityProviderSelect-rmWlUbIg.js";import"./GroupPickerDialog-U3luvxlw.js";import"./DataListItemRow-B_0B-ko6.js";import"./ActionListItem-Cy-NQlq4.js";import"./MultiLineInput-OP0faqms.js";import"./RoleMapping-BOcI-Nkp.js";import"./translationFormatter-DQJeO7lr.js";import"./useLocaleSort-C-diWts5.js";import"./CodeEditor-C4IS5oxi.js";import"./useParams-CGVhlaFZ.js";import"./constants-BclHbWtx.js";import"./_baseSlice-F8doVSIJ.js";import"./ClientScopeTypes-D2w5c8Pp.js";import"./utils-C-TUnOch.js";import"./filter-icon-DYNmdQ7O.js";import"./SwitchControl-CU1bUhmR.js";import"./DatePicker-DiXxo4Fo.js";import"./debounce-Dbkg0MD5.js";import"./_baseFlatten-BLlCkxtA.js";class he extends u.Component{constructor(t){super(t),this.headingRef=u.createRef(),this.toggleCollapse=()=>{this.setState(s=>({isOpen:!s.isOpen,isTooltipVisible:!!(this.headingRef.current&&this.headingRef.current.offsetWidth<this.headingRef.current.scrollWidth)}))},this.state={isOpen:this.props.defaultIsOpen,isTooltipVisible:!1}}componentDidMount(){this.setState({isTooltipVisible:!!(this.headingRef.current&&this.headingRef.current.offsetWidth<this.headingRef.current.scrollWidth)})}renderLabel(t){const{categoryName:s,tooltipPosition:a}=this.props,{isTooltipVisible:p}=this.state;return p?u.createElement(De,{position:a,content:s},u.createElement("span",{tabIndex:0,ref:this.headingRef,className:w(S.labelGroupLabel)},u.createElement("span",{"aria-hidden":"true",id:t},s))):u.createElement("span",{ref:this.headingRef,className:w(S.labelGroupLabel),"aria-hidden":"true",id:t},s)}render(){const t=this.props,{categoryName:s,children:a,className:p,isClosable:h,isCompact:c,closeBtnAriaLabel:f,"aria-label":N,onClick:y,numLabels:l,expandedText:b,collapsedText:g,defaultIsOpen:C,tooltipPosition:_,isVertical:V,isEditable:T,hasEditableTextArea:o,editableTextAreaProps:P,addLabelControl:A}=t,E=Oe(t,["categoryName","children","className","isClosable","isCompact","closeBtnAriaLabel","aria-label","onClick","numLabels","expandedText","collapsedText","defaultIsOpen","tooltipPosition","isVertical","isEditable","hasEditableTextArea","editableTextAreaProps","addLabelControl"]),{isOpen:m}=this.state,v=u.Children.toArray(a),z=v.length,R=_e(g,{remaining:z-l}),B=d=>{const i=m?v:v.slice(0,l),M=u.createElement(u.Fragment,null,s&&this.renderLabel(d),u.createElement("ul",Object.assign({className:w(S.labelGroupList)},s&&{"aria-labelledby":d},!s&&{"aria-label":N},{role:"list"},E),i.map((O,j)=>u.createElement("li",{className:w(S.labelGroupListItem),key:j},O)),z>l&&u.createElement("li",{className:w(S.labelGroupListItem)},u.createElement(Se,{isOverflowLabel:!0,onClick:this.toggleCollapse,className:w(c&&Be.modifiers.compact)},m?b:R)),A&&u.createElement("li",{className:w(S.labelGroupListItem)},A),T&&o&&u.createElement("li",{className:w(S.labelGroupListItem,S.modifiers.textarea)},u.createElement("textarea",Object.assign({className:w(S.labelGroupTextarea),rows:1,tabIndex:0},P))))),x=u.createElement("div",{className:w(S.labelGroupClose)},u.createElement($,{variant:"plain","aria-label":f,onClick:y,id:`remove_group_${d}`,"aria-labelledby":`remove_group_${d} ${d}`},u.createElement(Ge,{"aria-hidden":"true"})));return u.createElement("div",{className:w(S.labelGroup,p,s&&S.modifiers.category,V&&S.modifiers.vertical,T&&S.modifiers.editable)},u.createElement("div",{className:w(S.labelGroupMain)},M),h&&x)};return z===0&&A===void 0?null:u.createElement(ze,null,d=>B(this.props.id||d))}}he.displayName="LabelGroup";he.defaultProps={expandedText:"Show Less",collapsedText:"${remaining} more",categoryName:"",defaultIsOpen:!1,numLabels:3,isClosable:!1,isCompact:!1,onClick:n=>{},closeBtnAriaLabel:"Close label group",tooltipPosition:"top","aria-label":"Label group category",isVertical:!1,isEditable:!1,hasEditableTextArea:!1};const vt=({row:n})=>{const{t}=G(),s=n.associatedScopes||[];return e(he,{children:s.map((a,p)=>e(Me,{"aria-label":`Authorization scope popover for ${a.name}`,position:"top",hasAutoWidth:!0,bodyContent:r(Ee,{children:[e(F,{className:"pf-v5-u-font-size-md pf-v5-u-font-weight-bold",children:t("authorizationScopeDetailsTitle")}),e(F,{className:"pf-v5-u-font-size-sm",children:t("authorizationScopeDetailsSubtitle")}),r(lt,{component:ct.dl,className:"pf-v5-u-font-size-sm",children:[e(H,{component:q.dt,children:t("authorizationScopeDetailsName")}),e(H,{component:q.dd,children:Ce(a.name)}),e(H,{component:q.dt,children:t("authorizationScopeDetailsDescription")}),r(H,{component:q.dd,children:[" ",t(`authorizationScope.${n.resourceType}.${a.name}`)]})]})]}),children:e(Se,{color:"blue",children:Ce(a.name)})},p))})},Ct=({types:n,search:t,onSearch:s})=>{const{t:a}=G(),p=re({mode:"onChange",defaultValues:t}),{reset:h,formState:{isDirty:c},handleSubmit:f}=p,[N,y]=oe(),[l,b]=L([]),g=le({control:p.control,name:"resourceType",defaultValue:""}),[C,_]=L(0),V=ot("clients"),T=o=>{y(),s(o)};return ve(()=>{const o=n?.find(P=>P.type===g);b(o?.scopes||[])},[g,n]),ve(()=>{h(t),_(o=>o+1)},[t]),e(Fe,{toggle:o=>e(Ke,{"data-testid":"searchdropdown_dorpdown",ref:o,onClick:y,className:"keycloak__client_authentication__searchdropdown",children:a("searchClientAuthorizationPermission")}),isOpen:N,children:e(ce,{...p,children:r($e,{isHorizontal:!0,className:"keycloak__client_authentication__searchdropdown_form",onSubmit:f(T),children:[e(je,{name:"name",label:a("name")}),e(J,{name:"resourceType",label:a("type"),controller:{defaultValue:""},options:[{key:"",value:a("choose")},...n.map(({type:o,name:P})=>({key:o,value:P||o}))],onSelect:(o,P)=>{V.current!==o&&(V.current=o,p.setValue("resources",void 0)),P(o)}}),g!==""&&r(D,{children:[e(bt,{resourceType:g||"clients",withEnforceAccessTo:!1}),e(J,{name:"scope",label:a("authorizationScope"),controller:{defaultValue:""},options:[...(l||[]).map(o=>({key:o,value:o}))]})]}),r(xe,{children:[e($,{variant:"primary",type:"submit","data-testid":"search-btn",isDisabled:!c,children:a("search")}),e($,{variant:"link","data-testid":"revert-btn",onClick:()=>{h({}),s({})},children:a("clear")})]})]},C)})})},Pe=({resourceTypes:n,onSelect:t,toggleDialog:s})=>{const{t:a}=G();return e(Ue,{"aria-label":a("createPermission"),variant:We.medium,header:r(Ee,{children:[e(F,{component:He.h1,children:a("chooseAResourceType")}),e(de,{variant:"info",isInline:!0,title:a("chooseAResourceTypeInstructions"),component:"p"})]}),isOpen:!0,onClose:s,children:r(Ae,{"aria-label":a("permissions"),variant:"compact",children:[e(Re,{children:r(U,{children:[e(k,{children:a("resourceType")}),e(k,{children:a("description")})]})}),e(Ie,{children:Object.keys(n||{}).map(p=>{const h=n[p];return r(U,{"data-testid":h.type,onRowClick:()=>{t(h)},isClickable:!0,children:[e(I,{children:h.type}),e(I,{style:{textWrap:"wrap"},children:a(`resourceType.${h.type}`)})]},h.type)})})]})})},Pt=({clientId:n})=>{const{adminClient:t}=me(),{t:s}=G(),a=qe(),{addAlert:p,addError:h}=ue(),{realm:c}=Y(),[f,N]=L(),[y,l]=L(),[b,g]=L({}),[C,_]=L(0),V=()=>_(C+1),[T,o]=L(10),[P,A]=L(0),[E,m]=oe(),v=Ve({clientId:n});Ne(async()=>{const i=await t.clients.listPermissionScope({first:P,max:T+1,id:n,...b});return await Promise.all((i||[]).map(async x=>{const O=await t.clients.getAssociatedPolicies({id:n,permissionId:x.id}),j=await t.clients.getAssociatedScopes({id:n,permissionId:x.id}),K=await t.clients.getAssociatedResources({id:n,permissionId:x.id});return{...x,policies:O,scopes:j,resources:K,isExpanded:!1}}))},i=>{N(i)},[C,b,P,T]);const[z,R]=ut({titleKey:"deletePermission",messageKey:s("deleteAdminPermissionConfirm",{permission:y?.name}),continueButtonVariant:Qe.danger,continueButtonLabel:"confirm",onConfirm:async()=>{try{await t.clients.delPermission({id:n,type:y?.type,permissionId:y?.id}),p(s("permissionDeletedSuccess"),we.success),V()}catch(i){h("permissionDeletedError",i)}}});if(!f)return e(Je,{});const B=f.length===0,d=Object.keys(b).length!==0;return r(pe,{variant:"light",className:"pf-v5-u-p-0",children:[e(R,{}),(!B||d)&&r(D,{children:[E&&e(Pe,{resourceTypes:v,onSelect:i=>a(X({realm:c,permissionClientId:n,resourceType:i.type})),toggleDialog:m}),e(Ye,{count:f.length,first:P,max:T,onNextClick:A,onPreviousClick:A,onPerPageSelect:(i,M)=>{A(i),o(M)},toolbarItem:r(D,{children:[e(fe,{children:e(Ct,{types:v,search:b,onSearch:g})}),e(fe,{children:e($,{"data-testid":"createScopeBasedPermissionBtn",variant:"primary",onSelect:i=>a(X({realm:c,permissionClientId:n,resourceType:i.type})),onClick:m,children:s("createPermission")},"confirm")})]}),children:!B&&r(Ae,{"aria-label":s("permissions"),variant:"compact",children:[e(Re,{children:r(U,{children:[e(k,{"aria-hidden":"true"}),e(k,{children:s("adminPermissionName")}),e(k,{children:s("resourceType")}),e(k,{children:s("authorizationScopes")}),e(k,{children:s("description")}),e(k,{"aria-hidden":"true"})]})}),f.map((i,M)=>r(Ie,{isExpanded:i.isExpanded,children:[r(U,{children:[e(I,{expand:{rowIndex:M,isExpanded:i.isExpanded,onToggle:(x,O)=>{const j=f.map((K,ke)=>ke===O?{...K,isExpanded:!K.isExpanded}:K);N(j)}}}),e(I,{"data-testid":`name-column-${i.name}`,children:e(Xe,{to:Ze({realm:c,permissionClientId:n,permissionId:i.id,resourceType:i.resourceType}),children:i.name})}),e(I,{children:i.resourceType}),e(I,{children:e(vt,{row:{resourceType:i.resourceType||"",associatedScopes:i.scopes?.map(x=>({name:x.name||""}))}})}),e(I,{children:i.description||"â€”"}),e(I,{actions:{items:[{title:s("delete"),onClick:async()=>{l(i),z()}}]}})]}),r(U,{isExpanded:i.isExpanded,children:[e(I,{}),e(I,{colSpan:5,children:e(et,{children:i.isExpanded&&r(D,{children:[e(k,{children:s("resources")}),i.resources&&i.resources?.length>0?i.resources.map((x,O)=>e(I,{children:e("span",{style:{marginLeft:"8px"},children:x.displayName||x.name})},O)):e(I,{children:e("span",{style:{marginLeft:"8px"},children:s("allResources")})}),e("br",{}),e(k,{children:s("assignedPolicies")}),i.policies.map((x,O)=>e(I,{children:e("span",{style:{marginLeft:"8px"},children:x.name})},O))]})})})]},`child-${i.id}`)]},i.id))]})})]}),B&&!d&&r(D,{children:[E&&e(Pe,{resourceTypes:v,onSelect:i=>a(X({realm:c,permissionClientId:n,resourceType:i.type})),toggleDialog:m}),e(ne,{message:s("emptyPermissions"),instructions:s("emptyPermissionsInstructions"),primaryActionText:s("createPermission"),onPrimaryAction:m})]}),B&&d&&e(ne,{isSearchVariant:!0,message:s("noSearchResults"),instructions:s("noPermissionSearchResultsInstructions")})]})},St=({evaluateResult:n})=>{const{t}=G(),a=(n?.results||[])[0]||{},p=a?.resource?.name??t("permissionEvaluationAlertTitle"),h=n?.status==="PERMIT"?"success":"warning",c=Q(()=>se(a?.allowedScopes||[],"name"),[a]),f=Q(()=>se(a?.deniedScopes||[],"name"),[a]),N=Q(()=>se(a?.policies||[],"name"),[a]),y=function(l,b){const g=N.filter(C=>C.status===b);if(g.length!=0)return r(D,{children:[r(F,{className:"pf-v5-u-pt-sm",children:[e("strong",{children:t(l)}),":"]}),e(Z,{className:"pf-v5-u-mt-sm",children:g.map(C=>e(ee,{children:t("evaluatedPolicy",{name:C.policy?.name,status:C.status})},C.policy?.id))})]})};return r(de,{isInline:!0,variant:h,title:p,component:"h6",children:[c.length>0&&r(D,{children:[e(F,{children:e("b",{children:t("grantedScope")})}),e(Z,{className:"pf-v5-u-mt-sm",children:c.map(l=>e(ee,{children:l.name},l.id))})]}),f.length>0&&r(D,{children:[e(F,{className:"pf-v5-u-pt-sm",children:e("strong",{children:t("deniedScope")})}),e(Z,{className:"pf-v5-u-mt-sm",children:f.map(l=>e(ee,{children:l.name},l.id))})]}),y("grantedPermissions","PERMIT"),y("deniedPermissions","DENY")]})},Et=n=>{const{hasAccess:t}=Le();return t("view-users")?e(xt,{...n}):e(tt,{permissionNeeded:"view-users"})},xt=({client:n})=>{const{t}=G(),{adminClient:s}=me(),a=Y(),{addError:p}=ue(),h=re({mode:"onChange",defaultValues:{user:[],resourceType:"",authScopes:[]}}),{control:c,getValues:f,reset:N,trigger:y}=h,[l,b]=L(),[g,C]=L(!0),[_,V]=L(!1),T=Ve({clientId:n.id}),o=le({control:c,name:"resourceType",defaultValue:""}),P=Q(()=>T.find(v=>v.type===o)?.scopes||[],[o,T]),A=gt[o?.toLowerCase()||""],E=async()=>{if(!await y())return;const m=f(),v=d=>Array.isArray(d)?d?.[0]:d,R=(d=>{switch(d){case"Groups":return v(m.groups);case"Users":return v(m.users);case"Clients":return v(m.clients);case"Roles":return v(m.roles);default:return}})(m.resourceType),B={roleIds:m.roleIds??[],userId:m.user[0],resourceType:m.resourceType,resources:[{name:R,scopes:m.authScopes.map(d=>({name:d}))}],entitlements:!1,context:{attributes:{}}};try{const d=await s.clients.evaluateResource({id:n.id,realm:a.realm},B);b(d),V(!0)}catch(d){p("evaluateError",d)}};return e(pe,{children:r(st,{hasGutter:!0,children:[e(be,{children:r(ce,{...h,children:[e(ge,{children:e(ye,{style:{width:"50rem"},children:r(yt,{isHorizontal:!0,role:"view-clients",children:[g&&e(de,{variant:"info",isInline:!0,title:t("permissionsEvaluationInstructions"),component:"p",actionClose:e(at,{onClose:()=>C(!1)})}),e(Tt,{name:"user",label:t("user"),helpText:t("selectUser"),defaultValue:[],variant:"typeahead",isRequired:!0}),e(J,{name:"resourceType",label:t("resourceType"),labelIcon:t("resourceTypeSelectHelp"),variant:"single",controller:{defaultValue:T.length?T[0]?.type:"",rules:{required:!0}},options:T.map(m=>m.type)}),A&&e(A,{name:o?.toLowerCase(),label:t(`${o}`),helpText:t(`select${o}`),defaultValue:[],variant:"typeahead",isRequired:!0,isRadio:!0}),e(J,{name:"authScopes",label:t("authScope"),labelIcon:t("authScopeSelectHelp"),controller:{defaultValue:[]},variant:"single",options:P})]})})}),r(xe,{children:[e($,{"data-testid":"permission-eval",id:"permission-eval",className:"pf-v5-u-mr-md",isDisabled:!h.formState.isValid,onClick:()=>E(),children:t("evaluate")}),e($,{"data-testid":"permission-eval-revert",id:"permission-eval-revert",className:"pf-v5-u-mr-md",variant:"link",onClick:()=>{N(),b({}),V(!1)},children:t("revert")})]})]})}),e(be,{children:r(ge,{children:[e(dt,{children:e(it,{headingLevel:"h1",size:"md",children:t("permissionEvaluationPreview")})}),e(ye,{children:_?e(St,{evaluateResult:l}):e(ne,{icon:nt,message:t("noPermissionsEvaluationResults"),instructions:t("noPermissionsEvaluationResultsInstructions")})})]})})]})})};function ds(){const{adminClient:n}=me(),{t}=G(),{realm:s}=Y(),{hasAccess:a}=Le(),{addAlert:p,addError:h}=ue(),[c,f]=L(),[N,y]=oe(),l=re(),{realmRepresentation:b}=Y(),g=le({control:l.control,name:"clientAuthenticatorType",defaultValue:"client-secret"}),C=a("manage-authorization"),_=a("view-users"),V=te(W({realm:s,permissionClientId:b?.adminPermissionsClient?.id,tab:"permissions"})),T=te(W({realm:s,permissionClientId:b?.adminPermissionsClient?.id,tab:"policies"})),o=te(W({realm:s,permissionClientId:b?.adminPermissionsClient?.id,tab:"evaluation"}));Ne(async()=>(await n.clients.find({clientId:"admin-permissions"}))[0],E=>{f(E)},[]);const P=E=>{l.reset({...E}),rt(E,l.setValue)},A=async({confirmed:E=!1,messageKey:m="clientSaveSuccess"}={confirmed:!1,messageKey:"clientSaveSuccess"})=>{if(!await l.trigger())return;if(!c?.publicClient&&c?.clientAuthenticatorType!==g&&!E){y();return}const v=Te(l.getValues()),z=Te(v);try{const R={...c,...z};R.clientId=R.clientId?.trim(),await n.clients.update({id:c.clientId},R),P(R),f(R),p(t(m),we.success)}catch(R){h("clientSaveError",R)}};return c&&r(D,{children:[e(pt,{continueButtonLabel:"yes",cancelButtonLabel:"no",titleKey:t("changeAuthenticatorConfirmTitle",{clientAuthenticatorType:g}),open:N,toggleDialog:y,onConfirm:()=>A({confirmed:!0}),children:e(D,{children:t("changeAuthenticatorConfirm",{clientAuthenticatorType:g})})}),e(pe,{variant:"light",className:"pf-v5-u-p-0",children:r(ce,{...l,children:[e(ft,{titleKey:t("permissions"),subKey:t("permissionsSubTitle")}),r(ht,{mountOnEnter:!0,unmountOnExit:!0,defaultLocation:W({realm:s,permissionClientId:c.id,tab:"permissions"}),children:[e(ae,{id:"resources","data-testid":"permissionsResources",title:e(ie,{children:t("permissions")}),...V,children:e(Pt,{clientId:c.id})}),e(ae,{id:"policies","data-testid":"permissionsPolicies",title:e(ie,{children:t("policies")}),...T,children:e(mt,{clientId:c.id,isDisabled:!C})}),_&&e(ae,{id:"evaluation","data-testid":"permissionsEvaluation",title:e(ie,{children:t("evaluation")}),...o,children:e(Et,{client:c,save:A})})]})]})})]})}export{ds as default};
//# sourceMappingURL=PermissionsConfigurationSection-CrVuiKtY.js.map
