{"version":3,"file":"ExecutorForm-Dt5MaWsz.js","sources":["../../../../../../../src/realm-settings/ExecutorForm.tsx"],"sourcesContent":["import type { ConfigPropertyRepresentation } from \"@keycloak/keycloak-admin-client/lib/defs/authenticatorConfigInfoRepresentation\";\r\nimport type ClientProfileRepresentation from \"@keycloak/keycloak-admin-client/lib/defs/clientProfileRepresentation\";\r\nimport type ComponentTypeRepresentation from \"@keycloak/keycloak-admin-client/lib/defs/componentTypeRepresentation\";\r\nimport {\r\n  HelpItem,\r\n  KeycloakSelect,\r\n  SelectVariant,\r\n  useAlerts,\r\n  useFetch,\r\n} from \"@keycloak/keycloak-ui-shared\";\r\nimport {\r\n  ActionGroup,\r\n  AlertVariant,\r\n  Button,\r\n  FormGroup,\r\n  PageSection,\r\n  SelectOption,\r\n} from \"@patternfly/react-core\";\r\nimport { useState } from \"react\";\r\nimport { Controller, FormProvider, useForm } from \"react-hook-form\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { Link, useNavigate } from \"react-router-dom\";\r\nimport { useAdminClient } from \"../admin-client\";\r\nimport { DynamicComponents } from \"../components/dynamic/DynamicComponents\";\r\nimport { FormAccess } from \"../components/form/FormAccess\";\r\nimport { ViewHeader } from \"../components/view-header/ViewHeader\";\r\nimport { useServerInfo } from \"../context/server-info/ServerInfoProvider\";\r\nimport { useParams } from \"../utils/useParams\";\r\nimport { ClientProfileParams, toClientProfile } from \"./routes/ClientProfile\";\r\nimport type { ExecutorParams } from \"./routes/Executor\";\r\n\r\ntype ExecutorForm = {\r\n  config?: object;\r\n  executor: string;\r\n};\r\n\r\nconst defaultValues: ExecutorForm = {\r\n  config: {},\r\n  executor: \"\",\r\n};\r\n\r\nexport default function ExecutorForm() {\r\n  const { adminClient } = useAdminClient();\r\n\r\n  const { t } = useTranslation();\r\n  const navigate = useNavigate();\r\n  const { realm, profileName } = useParams<ClientProfileParams>();\r\n  const { executorName } = useParams<ExecutorParams>();\r\n  const { addAlert, addError } = useAlerts();\r\n  const [selectExecutorTypeOpen, setSelectExecutorTypeOpen] = useState(false);\r\n  const serverInfo = useServerInfo();\r\n  const executorTypes =\r\n    serverInfo.componentTypes?.[\r\n      \"org.keycloak.services.clientpolicy.executor.ClientPolicyExecutorProvider\"\r\n    ];\r\n  const [executors, setExecutors] = useState<ComponentTypeRepresentation[]>([]);\r\n  const [executorProperties, setExecutorProperties] = useState<\r\n    ConfigPropertyRepresentation[]\r\n  >([]);\r\n  const [globalProfiles, setGlobalProfiles] = useState<\r\n    ClientProfileRepresentation[]\r\n  >([]);\r\n  const [profiles, setProfiles] = useState<ClientProfileRepresentation[]>([]);\r\n  const form = useForm({ defaultValues });\r\n  const { control, reset, handleSubmit } = form;\r\n  const editMode = !!executorName;\r\n\r\n  const setupForm = (profiles: ClientProfileRepresentation[]) => {\r\n    const profile = profiles.find((profile) => profile.name === profileName);\r\n    const executor = profile?.executors?.find(\r\n      (executor) => executor.executor === executorName,\r\n    );\r\n    if (executor) reset({ config: executor.configuration });\r\n  };\r\n\r\n  useFetch(\r\n    () =>\r\n      adminClient.clientPolicies.listProfiles({ includeGlobalProfiles: true }),\r\n    (profiles) => {\r\n      setGlobalProfiles(profiles.globalProfiles!);\r\n      setProfiles(profiles.profiles!);\r\n\r\n      setupForm(profiles.profiles!);\r\n      setupForm(profiles.globalProfiles!);\r\n    },\r\n    [],\r\n  );\r\n\r\n  const save = async () => {\r\n    const formValues = form.getValues();\r\n    const updatedProfiles = profiles.map((profile) => {\r\n      if (profile.name !== profileName) {\r\n        return profile;\r\n      }\r\n\r\n      const executors = (profile.executors ?? []).concat({\r\n        executor: formValues.executor,\r\n        configuration: formValues.config || {},\r\n      });\r\n\r\n      if (editMode) {\r\n        const profileExecutor = profile.executors!.find(\r\n          (executor) => executor.executor === executorName,\r\n        );\r\n        profileExecutor!.configuration = {\r\n          ...profileExecutor!.configuration,\r\n          ...formValues.config,\r\n        };\r\n      }\r\n\r\n      if (editMode) {\r\n        return profile;\r\n      }\r\n      return {\r\n        ...profile,\r\n        executors,\r\n      };\r\n    });\r\n    try {\r\n      await adminClient.clientPolicies.createProfiles({\r\n        profiles: updatedProfiles,\r\n        globalProfiles: globalProfiles,\r\n      });\r\n      addAlert(\r\n        editMode ? t(\"updateExecutorSuccess\") : t(\"addExecutorSuccess\"),\r\n        AlertVariant.success,\r\n      );\r\n\r\n      navigate(toClientProfile({ realm, profileName }));\r\n    } catch (error) {\r\n      addError(editMode ? \"updateExecutorError\" : \"addExecutorError\", error);\r\n    }\r\n  };\r\n\r\n  const globalProfile = globalProfiles.find(\r\n    (globalProfile) => globalProfile.name === profileName,\r\n  );\r\n\r\n  const profileExecutorType = executorTypes?.find(\r\n    (executor) => executor.id === executorName,\r\n  );\r\n\r\n  const editedProfileExecutors =\r\n    profileExecutorType?.properties.map<ConfigPropertyRepresentation>(\r\n      (property) => {\r\n        const globalDefaultValues = editMode ? property.defaultValue : \"\";\r\n        return {\r\n          ...property,\r\n          defaultValue: globalDefaultValues,\r\n        };\r\n      },\r\n    );\r\n\r\n  return (\r\n    <>\r\n      <ViewHeader\r\n        titleKey={editMode ? executorName : t(\"addExecutor\")}\r\n        divider\r\n      />\r\n      <PageSection variant=\"light\">\r\n        <FormAccess\r\n          isHorizontal\r\n          role=\"manage-realm\"\r\n          className=\"pf-v5-u-mt-lg\"\r\n          isReadOnly={!!globalProfile}\r\n        >\r\n          <FormGroup\r\n            label={t(\"executorType\")}\r\n            fieldId=\"kc-executorType\"\r\n            labelIcon={\r\n              executors.length > 0 && executors[0].helpText! !== \"\" ? (\r\n                <HelpItem\r\n                  helpText={executors[0].helpText}\r\n                  fieldLabelId=\"executorTypeHelpText\"\r\n                />\r\n              ) : editMode ? (\r\n                <HelpItem\r\n                  helpText={profileExecutorType?.helpText}\r\n                  fieldLabelId=\"executorTypeHelpText\"\r\n                />\r\n              ) : undefined\r\n            }\r\n          >\r\n            <Controller\r\n              name=\"executor\"\r\n              defaultValue=\"\"\r\n              control={control}\r\n              render={({ field }) => (\r\n                <KeycloakSelect\r\n                  toggleId=\"kc-executor\"\r\n                  placeholderText=\"Select an executor\"\r\n                  onToggle={(isOpen) => setSelectExecutorTypeOpen(isOpen)}\r\n                  onSelect={(value) => {\r\n                    reset({ ...defaultValues, executor: value.toString() });\r\n                    const selectedExecutor = executorTypes?.filter(\r\n                      (type) => type.id === value,\r\n                    );\r\n                    setExecutors(selectedExecutor ?? []);\r\n                    setExecutorProperties(\r\n                      selectedExecutor?.[0].properties ?? [],\r\n                    );\r\n                    setSelectExecutorTypeOpen(false);\r\n                  }}\r\n                  selections={editMode ? executorName : field.value}\r\n                  variant={SelectVariant.single}\r\n                  data-testid=\"executorType-select\"\r\n                  aria-label={t(\"executorType\")}\r\n                  isOpen={selectExecutorTypeOpen}\r\n                  maxHeight={580}\r\n                  isDisabled={editMode}\r\n                >\r\n                  {executorTypes?.map((option) => (\r\n                    <SelectOption\r\n                      data-testid={option.id}\r\n                      selected={option.id === field.value}\r\n                      key={option.id}\r\n                      value={option.id}\r\n                      description={option.helpText}\r\n                    >\r\n                      {option.id}\r\n                    </SelectOption>\r\n                  ))}\r\n                </KeycloakSelect>\r\n              )}\r\n            />\r\n          </FormGroup>\r\n          <FormProvider {...form}>\r\n            <DynamicComponents\r\n              properties={\r\n                editMode ? editedProfileExecutors! : executorProperties\r\n              }\r\n            />\r\n          </FormProvider>\r\n          {!globalProfile && (\r\n            <ActionGroup>\r\n              <Button\r\n                variant=\"primary\"\r\n                onClick={() => handleSubmit(save)()}\r\n                data-testid=\"addExecutor-saveBtn\"\r\n              >\r\n                {editMode ? t(\"save\") : t(\"add\")}\r\n              </Button>\r\n              <Button\r\n                variant=\"link\"\r\n                component={(props) => (\r\n                  <Link\r\n                    {...props}\r\n                    to={toClientProfile({ realm, profileName })}\r\n                  />\r\n                )}\r\n                data-testid=\"addExecutor-cancelBtn\"\r\n              >\r\n                {t(\"cancel\")}\r\n              </Button>\r\n            </ActionGroup>\r\n          )}\r\n        </FormAccess>\r\n        {editMode && globalProfile && (\r\n          <div className=\"kc-backToProfile\">\r\n            <Button\r\n              component={(props) => (\r\n                <Link {...props} to={toClientProfile({ realm, profileName })} />\r\n              )}\r\n              variant=\"primary\"\r\n            >\r\n              {t(\"back\")}\r\n            </Button>\r\n          </div>\r\n        )}\r\n      </PageSection>\r\n    </>\r\n  );\r\n}\r\n"],"names":["defaultValues","ExecutorForm","adminClient","useAdminClient","t","useTranslation","navigate","useNavigate","realm","profileName","useParams","executorName","addAlert","addError","useAlerts","selectExecutorTypeOpen","setSelectExecutorTypeOpen","useState","executorTypes","useServerInfo","executors","setExecutors","executorProperties","setExecutorProperties","globalProfiles","setGlobalProfiles","profiles","setProfiles","form","useForm","control","reset","handleSubmit","editMode","setupForm","executor","profile","useFetch","save","formValues","updatedProfiles","profileExecutor","AlertVariant","toClientProfile","error","globalProfile","profileExecutorType","editedProfileExecutors","property","globalDefaultValues","jsxs","Fragment","jsx","ViewHeader","PageSection","FormAccess","FormGroup","HelpItem","Controller","field","KeycloakSelect","isOpen","value","selectedExecutor","type","SelectVariant","option","SelectOption","FormProvider","DynamicComponents","ActionGroup","Button","props","Link"],"mappings":"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"}