{"version":3,"file":"NewClientPolicyCondition-DxiZ7-5X.js","sources":["../../../../../../../src/realm-settings/NewClientPolicyCondition.tsx"],"sourcesContent":["import type { ConfigPropertyRepresentation } from \"@keycloak/keycloak-admin-client/lib/defs/authenticatorConfigInfoRepresentation\";\r\nimport type ClientPolicyConditionRepresentation from \"@keycloak/keycloak-admin-client/lib/defs/clientPolicyConditionRepresentation\";\r\nimport type ClientPolicyRepresentation from \"@keycloak/keycloak-admin-client/lib/defs/clientPolicyRepresentation\";\r\nimport type ComponentTypeRepresentation from \"@keycloak/keycloak-admin-client/lib/defs/componentTypeRepresentation\";\r\nimport {\r\n  HelpItem,\r\n  KeycloakSelect,\r\n  SelectVariant,\r\n  useAlerts,\r\n  useFetch,\r\n} from \"@keycloak/keycloak-ui-shared\";\r\nimport {\r\n  ActionGroup,\r\n  AlertVariant,\r\n  Button,\r\n  FormGroup,\r\n  PageSection,\r\n  SelectOption,\r\n} from \"@patternfly/react-core\";\r\nimport { camelCase } from \"lodash-es\";\r\nimport { useState } from \"react\";\r\nimport { Controller, FormProvider, useForm } from \"react-hook-form\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { Link, useNavigate, useParams } from \"react-router-dom\";\r\nimport { useAdminClient } from \"../admin-client\";\r\nimport { DynamicComponents } from \"../components/dynamic/DynamicComponents\";\r\nimport { FormAccess } from \"../components/form/FormAccess\";\r\nimport { ViewHeader } from \"../components/view-header/ViewHeader\";\r\nimport { useRealm } from \"../context/realm-context/RealmContext\";\r\nimport { useServerInfo } from \"../context/server-info/ServerInfoProvider\";\r\nimport { toEditClientPolicy } from \"./routes/EditClientPolicy\";\r\nimport type { EditClientPolicyConditionParams } from \"./routes/EditCondition\";\r\n\r\nexport type ItemType = { value: string };\r\n\r\ntype ConfigProperty = ConfigPropertyRepresentation & {\r\n  conditions: any;\r\n  config: any;\r\n};\r\n\r\nexport default function NewClientPolicyCondition() {\r\n  const { adminClient } = useAdminClient();\r\n\r\n  const { t } = useTranslation();\r\n  const { addAlert, addError } = useAlerts();\r\n  const navigate = useNavigate();\r\n  const { realm } = useRealm();\r\n\r\n  const [openConditionType, setOpenConditionType] = useState(false);\r\n  const [isGlobalPolicy, setIsGlobalPolicy] = useState(false);\r\n  const [policies, setPolicies] = useState<ClientPolicyRepresentation[]>([]);\r\n\r\n  const [condition, setCondition] = useState<\r\n    ClientPolicyConditionRepresentation[]\r\n  >([]);\r\n  const [conditionData, setConditionData] =\r\n    useState<ClientPolicyConditionRepresentation>();\r\n  const [conditionType, setConditionType] = useState(\"\");\r\n  const [conditionProperties, setConditionProperties] = useState<\r\n    ConfigPropertyRepresentation[]\r\n  >([]);\r\n\r\n  const { policyName, conditionName } =\r\n    useParams<EditClientPolicyConditionParams>();\r\n\r\n  const serverInfo = useServerInfo();\r\n  const form = useForm<ConfigProperty>();\r\n\r\n  const conditionTypes =\r\n    serverInfo.componentTypes?.[\r\n      \"org.keycloak.services.clientpolicy.condition.ClientPolicyConditionProvider\"\r\n    ];\r\n\r\n  const setupForm = (condition: ClientPolicyConditionRepresentation) => {\r\n    form.reset({ config: condition.configuration || {} });\r\n  };\r\n\r\n  useFetch(\r\n    () =>\r\n      adminClient.clientPolicies.listPolicies({\r\n        includeGlobalPolicies: true,\r\n      }),\r\n\r\n    (policies) => {\r\n      setPolicies(policies.policies ?? []);\r\n\r\n      if (conditionName) {\r\n        let currentPolicy = policies.policies?.find(\r\n          (item) => item.name === policyName,\r\n        );\r\n        if (currentPolicy === undefined) {\r\n          currentPolicy = policies.globalPolicies?.find(\r\n            (item) => item.name === policyName,\r\n          );\r\n          setIsGlobalPolicy(currentPolicy !== undefined);\r\n        }\r\n\r\n        const typeAndConfigData = currentPolicy?.conditions?.find(\r\n          (item) => item.condition === conditionName,\r\n        );\r\n\r\n        const currentCondition = conditionTypes?.find(\r\n          (condition) => condition.id === conditionName,\r\n        );\r\n\r\n        setConditionData(typeAndConfigData!);\r\n        setConditionProperties(currentCondition?.properties!);\r\n        setupForm(typeAndConfigData!);\r\n      }\r\n    },\r\n    [],\r\n  );\r\n\r\n  const save = async (configPolicy: ConfigProperty) => {\r\n    const configValues = configPolicy.config;\r\n\r\n    const writeConfig = () => {\r\n      return conditionProperties.reduce((r: any, p) => {\r\n        r[p.name!] = configValues[p.name!];\r\n        return r;\r\n      }, {});\r\n    };\r\n\r\n    const updatedPolicies = policies.map((policy) => {\r\n      if (policy.name !== policyName) {\r\n        return policy;\r\n      }\r\n\r\n      let conditions = policy.conditions ?? [];\r\n\r\n      if (conditionName) {\r\n        const createdCondition = {\r\n          condition: conditionData?.condition,\r\n          configuration: writeConfig(),\r\n        };\r\n\r\n        const index = conditions.findIndex(\r\n          (condition) => conditionName === condition.condition,\r\n        );\r\n\r\n        if (index === -1) {\r\n          return;\r\n        }\r\n\r\n        const newConditions = [\r\n          ...conditions.slice(0, index),\r\n          createdCondition,\r\n          ...conditions.slice(index + 1),\r\n        ];\r\n\r\n        return {\r\n          ...policy,\r\n          conditions: newConditions,\r\n        };\r\n      }\r\n\r\n      conditions = conditions.concat({\r\n        condition: condition[0].condition,\r\n        configuration: writeConfig(),\r\n      });\r\n\r\n      return {\r\n        ...policy,\r\n        conditions,\r\n      };\r\n    }) as ClientPolicyRepresentation[];\r\n\r\n    try {\r\n      await adminClient.clientPolicies.updatePolicy({\r\n        policies: updatedPolicies,\r\n      });\r\n      setPolicies(updatedPolicies);\r\n      navigate(toEditClientPolicy({ realm, policyName: policyName! }));\r\n      addAlert(\r\n        conditionName\r\n          ? t(\"updateClientConditionSuccess\")\r\n          : t(\"createClientConditionSuccess\"),\r\n        AlertVariant.success,\r\n      );\r\n    } catch (error) {\r\n      addError(\"createClientConditionError\", error);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <ViewHeader\r\n        titleKey={\r\n          conditionName\r\n            ? isGlobalPolicy\r\n              ? t(\"viewCondition\")\r\n              : t(\"editCondition\")\r\n            : t(\"addCondition\")\r\n        }\r\n        divider\r\n      />\r\n      <PageSection variant=\"light\">\r\n        <FormAccess\r\n          isHorizontal\r\n          role=\"manage-realm\"\r\n          isReadOnly={isGlobalPolicy}\r\n          className=\"pf-v5-u-mt-lg\"\r\n          onSubmit={form.handleSubmit(save)}\r\n        >\r\n          <FormGroup\r\n            label={t(\"conditionType\")}\r\n            fieldId=\"conditionType\"\r\n            labelIcon={\r\n              <HelpItem\r\n                helpText={\r\n                  conditionType\r\n                    ? `${camelCase(conditionType.replace(/-/g, \" \"))}Help`\r\n                    : \"conditionsHelp\"\r\n                }\r\n                fieldLabelId=\"conditionType\"\r\n              />\r\n            }\r\n          >\r\n            <Controller\r\n              name=\"conditions\"\r\n              defaultValue={\"any-client\"}\r\n              control={form.control}\r\n              render={({ field }) => (\r\n                <KeycloakSelect\r\n                  placeholderText={t(\"selectACondition\")}\r\n                  className=\"kc-conditionType-select\"\r\n                  data-testid=\"conditionType-select\"\r\n                  toggleId=\"provider\"\r\n                  isDisabled={!!conditionName}\r\n                  onToggle={(toggle) => setOpenConditionType(toggle)}\r\n                  onSelect={(value) => {\r\n                    field.onChange(value);\r\n                    setConditionProperties(\r\n                      (value as ComponentTypeRepresentation).properties,\r\n                    );\r\n                    setConditionType((value as ComponentTypeRepresentation).id);\r\n                    setCondition([\r\n                      {\r\n                        condition: (value as ComponentTypeRepresentation).id,\r\n                      },\r\n                    ]);\r\n                    setOpenConditionType(false);\r\n                  }}\r\n                  selections={conditionName ? conditionName : conditionType}\r\n                  variant={SelectVariant.single}\r\n                  aria-label={t(\"conditionType\")}\r\n                  isOpen={openConditionType}\r\n                >\r\n                  {conditionTypes?.map((condition) => (\r\n                    <SelectOption\r\n                      data-testid={condition.id}\r\n                      selected={condition.id === field.value}\r\n                      description={t(\r\n                        camelCase(condition.id.replace(/-/g, \" \")),\r\n                      )}\r\n                      key={condition.id}\r\n                      value={condition}\r\n                    >\r\n                      {condition.id}\r\n                    </SelectOption>\r\n                  ))}\r\n                </KeycloakSelect>\r\n              )}\r\n            />\r\n          </FormGroup>\r\n\r\n          <FormProvider {...form}>\r\n            <DynamicComponents properties={conditionProperties} />\r\n          </FormProvider>\r\n          {!isGlobalPolicy && (\r\n            <ActionGroup>\r\n              <Button\r\n                variant=\"primary\"\r\n                type=\"submit\"\r\n                data-testid=\"addCondition-saveBtn\"\r\n                isDisabled={\r\n                  conditionType === \"\" && !conditionName && isGlobalPolicy\r\n                }\r\n              >\r\n                {conditionName ? t(\"save\") : t(\"add\")}\r\n              </Button>\r\n              <Button\r\n                variant=\"link\"\r\n                data-testid=\"addCondition-cancelBtn\"\r\n                onClick={() =>\r\n                  navigate(\r\n                    toEditClientPolicy({ realm, policyName: policyName! }),\r\n                  )\r\n                }\r\n              >\r\n                {t(\"cancel\")}\r\n              </Button>\r\n            </ActionGroup>\r\n          )}\r\n        </FormAccess>\r\n        {isGlobalPolicy && (\r\n          <div className=\"kc-backToProfile\">\r\n            <Button\r\n              component={(props) => (\r\n                <Link\r\n                  {...props}\r\n                  to={toEditClientPolicy({ realm, policyName: policyName! })}\r\n                />\r\n              )}\r\n              variant=\"primary\"\r\n            >\r\n              {t(\"back\")}\r\n            </Button>\r\n          </div>\r\n        )}\r\n      </PageSection>\r\n    </>\r\n  );\r\n}\r\n"],"names":["NewClientPolicyCondition","adminClient","useAdminClient","t","useTranslation","addAlert","addError","useAlerts","navigate","useNavigate","realm","useRealm","openConditionType","setOpenConditionType","useState","isGlobalPolicy","setIsGlobalPolicy","policies","setPolicies","condition","setCondition","conditionData","setConditionData","conditionType","setConditionType","conditionProperties","setConditionProperties","policyName","conditionName","useParams","serverInfo","useServerInfo","form","useForm","conditionTypes","setupForm","useFetch","currentPolicy","item","typeAndConfigData","currentCondition","save","configPolicy","configValues","writeConfig","r","p","updatedPolicies","policy","conditions","createdCondition","index","newConditions","toEditClientPolicy","AlertVariant","error","jsxs","Fragment","jsx","ViewHeader","PageSection","FormAccess","FormGroup","HelpItem","camelCase","Controller","field","KeycloakSelect","toggle","value","SelectVariant","SelectOption","FormProvider","DynamicComponents","ActionGroup","Button","props","Link"],"mappings":"m9BAwCA,SAAwBA,IAA2B,CACjD,KAAM,CAAE,YAAAC,CAAA,EAAgBC,EAAA,EAElB,CAAE,EAAAC,CAAA,EAAMC,EAAA,EACR,CAAE,SAAAC,EAAU,SAAAC,CAAA,EAAaC,EAAA,EACzBC,EAAWC,EAAA,EACX,CAAE,MAAAC,CAAA,EAAUC,EAAA,EAEZ,CAACC,EAAmBC,CAAoB,EAAIC,EAAS,EAAK,EAC1D,CAACC,EAAgBC,CAAiB,EAAIF,EAAS,EAAK,EACpD,CAACG,EAAUC,CAAW,EAAIJ,EAAuC,CAAA,CAAE,EAEnE,CAACK,EAAWC,CAAY,EAAIN,EAEhC,CAAA,CAAE,EACE,CAACO,EAAeC,CAAgB,EACpCR,EAAA,EACI,CAACS,EAAeC,CAAgB,EAAIV,EAAS,EAAE,EAC/C,CAACW,EAAqBC,CAAsB,EAAIZ,EAEpD,CAAA,CAAE,EAEE,CAAE,WAAAa,EAAY,cAAAC,CAAA,EAClBC,EAAA,EAEIC,EAAaC,EAAA,EACbC,EAAOC,EAAA,EAEPC,EACJJ,EAAW,iBACT,4EACF,EAEIK,EAAahB,GAAmD,CACpEa,EAAK,MAAM,CAAE,OAAQb,EAAU,eAAiB,CAAA,EAAI,CACtD,EAEAiB,EACE,IACEnC,EAAY,eAAe,aAAa,CACtC,sBAAuB,EAAA,CACxB,EAEFgB,GAAa,CAGZ,GAFAC,EAAYD,EAAS,UAAY,EAAE,EAE/BW,EAAe,CACjB,IAAIS,EAAgBpB,EAAS,UAAU,KACpCqB,GAASA,EAAK,OAASX,CAAA,EAEtBU,IAAkB,SACpBA,EAAgBpB,EAAS,gBAAgB,KACtCqB,GAASA,EAAK,OAASX,CAAA,EAE1BX,EAAkBqB,IAAkB,MAAS,GAG/C,MAAME,EAAoBF,GAAe,YAAY,KAClDC,GAASA,EAAK,YAAcV,CAAA,EAGzBY,EAAmBN,GAAgB,KACtCf,GAAcA,EAAU,KAAOS,CAAA,EAGlCN,EAAiBiB,CAAkB,EACnCb,EAAuBc,GAAkB,UAAW,EACpDL,EAAUI,CAAkB,CAC9B,CACF,EACA,CAAA,CAAC,EAGH,MAAME,EAAO,MAAOC,GAAiC,CACnD,MAAMC,EAAeD,EAAa,OAE5BE,EAAc,IACXnB,EAAoB,OAAO,CAACoB,EAAQC,KACzCD,EAAEC,EAAE,IAAK,EAAIH,EAAaG,EAAE,IAAK,EAC1BD,GACN,CAAA,CAAE,EAGDE,EAAkB9B,EAAS,IAAK+B,GAAW,CAC/C,GAAIA,EAAO,OAASrB,EAClB,OAAOqB,EAGT,IAAIC,EAAaD,EAAO,YAAc,CAAA,EAEtC,GAAIpB,EAAe,CACjB,MAAMsB,EAAmB,CACvB,UAAW7B,GAAe,UAC1B,cAAeuB,EAAA,CAAY,EAGvBO,EAAQF,EAAW,UACtB9B,GAAcS,IAAkBT,EAAU,SAAA,EAG7C,GAAIgC,IAAU,GACZ,OAGF,MAAMC,EAAgB,CACpB,GAAGH,EAAW,MAAM,EAAGE,CAAK,EAC5BD,EACA,GAAGD,EAAW,MAAME,EAAQ,CAAC,CAAA,EAG/B,MAAO,CACL,GAAGH,EACH,WAAYI,CAAA,CAEhB,CAEA,OAAAH,EAAaA,EAAW,OAAO,CAC7B,UAAW9B,EAAU,CAAC,EAAE,UACxB,cAAeyB,EAAA,CAAY,CAC5B,EAEM,CACL,GAAGI,EACH,WAAAC,CAAA,CAEJ,CAAC,EAED,GAAI,CACF,MAAMhD,EAAY,eAAe,aAAa,CAC5C,SAAU8C,CAAA,CACX,EACD7B,EAAY6B,CAAe,EAC3BvC,EAAS6C,EAAmB,CAAE,MAAA3C,EAAO,WAAAiB,CAAA,CAAyB,CAAC,EAC/DtB,EAEMF,EADJyB,EACM,+BACA,8BAD8B,EAEpC0B,GAAa,OAAA,CAEjB,OAASC,EAAO,CACdjD,EAAS,6BAA8BiD,CAAK,CAC9C,CACF,EAEA,OACEC,EAAAC,EAAA,CACE,SAAA,CAAAC,EAACC,GAAA,CACC,SAGQxD,EAFNyB,EACIb,EACI,gBACA,gBACF,cAFiB,EAIzB,QAAO,EAAA,CAAA,EAETyC,EAACI,EAAA,CAAY,QAAQ,QACnB,SAAA,CAAAJ,EAACK,GAAA,CACC,aAAY,GACZ,KAAK,eACL,WAAY9C,EACZ,UAAU,gBACV,SAAUiB,EAAK,aAAaS,CAAI,EAEhC,SAAA,CAAAiB,EAACI,GAAA,CACC,MAAO3D,EAAE,eAAe,EACxB,QAAQ,gBACR,UACEuD,EAACK,GAAA,CACC,SACExC,EACI,GAAGyC,EAAUzC,EAAc,QAAQ,KAAM,GAAG,CAAC,CAAC,OAC9C,iBAEN,aAAa,eAAA,CAAA,EAIjB,SAAAmC,EAACO,GAAA,CACC,KAAK,aACL,aAAc,aACd,QAASjC,EAAK,QACd,OAAQ,CAAC,CAAE,MAAAkC,CAAA,IACTR,EAACS,GAAA,CACC,gBAAiBhE,EAAE,kBAAkB,EACrC,UAAU,0BACV,cAAY,uBACZ,SAAS,WACT,WAAY,CAAC,CAACyB,EACd,SAAWwC,GAAWvD,EAAqBuD,CAAM,EACjD,SAAWC,GAAU,CACnBH,EAAM,SAASG,CAAK,EACpB3C,EACG2C,EAAsC,UAAA,EAEzC7C,EAAkB6C,EAAsC,EAAE,EAC1DjD,EAAa,CACX,CACE,UAAYiD,EAAsC,EAAA,CACpD,CACD,EACDxD,EAAqB,EAAK,CAC5B,EACA,WAAYe,GAAgCL,EAC5C,QAAS+C,GAAc,OACvB,aAAYnE,EAAE,eAAe,EAC7B,OAAQS,EAEP,SAAAsB,GAAgB,IAAKf,GACpBuC,EAACa,GAAA,CACC,cAAapD,EAAU,GACvB,SAAUA,EAAU,KAAO+C,EAAM,MACjC,YAAa/D,EACX6D,EAAU7C,EAAU,GAAG,QAAQ,KAAM,GAAG,CAAC,CAAA,EAG3C,MAAOA,EAEN,SAAAA,EAAU,EAAA,EAHNA,EAAU,EAAA,CAKlB,CAAA,CAAA,CACH,CAAA,CAEJ,CAAA,EAGFuC,EAACc,IAAc,GAAGxC,EAChB,WAACyC,GAAA,CAAkB,WAAYhD,EAAqB,CAAA,CACtD,EACC,CAACV,GACAyC,EAACkB,GAAA,CACC,SAAA,CAAAhB,EAACiB,EAAA,CACC,QAAQ,UACR,KAAK,SACL,cAAY,uBACZ,WACEpD,IAAkB,IAAM,CAACK,GAAiBb,EAG3C,SAAgBZ,EAAhByB,EAAkB,OAAY,KAAN,CAAW,CAAA,EAEtC8B,EAACiB,EAAA,CACC,QAAQ,OACR,cAAY,yBACZ,QAAS,IACPnE,EACE6C,EAAmB,CAAE,MAAA3C,EAAO,WAAAiB,CAAA,CAAyB,CAAA,EAIxD,WAAE,QAAQ,CAAA,CAAA,CACb,CAAA,CACF,CAAA,CAAA,CAAA,EAGHZ,GACC2C,EAAC,MAAA,CAAI,UAAU,mBACb,SAAAA,EAACiB,EAAA,CACC,UAAYC,GACVlB,EAACmB,GAAA,CACE,GAAGD,EACJ,GAAIvB,EAAmB,CAAE,MAAA3C,EAAO,WAAAiB,EAAyB,CAAA,CAAA,EAG7D,QAAQ,UAEP,WAAE,MAAM,CAAA,CAAA,CACX,CACF,CAAA,CAAA,CAEJ,CAAA,EACF,CAEJ"}