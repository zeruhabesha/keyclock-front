{"version":3,"file":"MappingDetails-BWsuhcy0.js","sources":["../../../../../../../src/client-scopes/details/MappingDetails.tsx"],"sourcesContent":["import type ProtocolMapperRepresentation from \"@keycloak/keycloak-admin-client/lib/defs/protocolMapperRepresentation\";\r\nimport type { ProtocolMapperTypeRepresentation } from \"@keycloak/keycloak-admin-client/lib/defs/serverInfoRepesentation\";\r\nimport { TextControl, useAlerts, useFetch } from \"@keycloak/keycloak-ui-shared\";\r\nimport {\r\n  ActionGroup,\r\n  AlertVariant,\r\n  Button,\r\n  ButtonVariant,\r\n  DropdownItem,\r\n  FormGroup,\r\n  PageSection,\r\n  TextInput,\r\n} from \"@patternfly/react-core\";\r\nimport { useState } from \"react\";\r\nimport { FormProvider, useForm } from \"react-hook-form\";\r\nimport { useTranslation } from \"react-i18next\";\r\nimport { Link, useMatch, useNavigate } from \"react-router-dom\";\r\nimport { useAdminClient } from \"../../admin-client\";\r\nimport { toDedicatedScope } from \"../../clients/routes/DedicatedScopeDetails\";\r\nimport { useConfirmDialog } from \"../../components/confirm-dialog/ConfirmDialog\";\r\nimport { DynamicComponents } from \"../../components/dynamic/DynamicComponents\";\r\nimport { FormAccess } from \"../../components/form/FormAccess\";\r\nimport { ViewHeader } from \"../../components/view-header/ViewHeader\";\r\nimport { useRealm } from \"../../context/realm-context/RealmContext\";\r\nimport { useServerInfo } from \"../../context/server-info/ServerInfoProvider\";\r\nimport { convertFormValuesToObject, convertToFormValues } from \"../../util\";\r\nimport { useParams } from \"../../utils/useParams\";\r\nimport { toClientScope } from \"../routes/ClientScope\";\r\nimport { MapperParams, MapperRoute } from \"../routes/Mapper\";\r\n\r\nexport default function MappingDetails() {\r\n  const { adminClient } = useAdminClient();\r\n\r\n  const { t } = useTranslation();\r\n  const { addAlert, addError } = useAlerts();\r\n\r\n  const { id, mapperId, viewMode } = useParams<MapperParams>();\r\n  const form = useForm();\r\n  const { setValue, handleSubmit } = form;\r\n  const [mapping, setMapping] = useState<ProtocolMapperTypeRepresentation>();\r\n  const [config, setConfig] = useState<{\r\n    protocol?: string;\r\n    protocolMapper?: string;\r\n  }>();\r\n\r\n  const navigate = useNavigate();\r\n  const { realm } = useRealm();\r\n  const serverInfo = useServerInfo();\r\n  const isUpdating = viewMode === \"edit\";\r\n\r\n  const isOnClientScope = !!useMatch(MapperRoute.path);\r\n  const toDetails = () =>\r\n    isOnClientScope\r\n      ? toClientScope({ realm, id, tab: \"mappers\" })\r\n      : toDedicatedScope({ realm, clientId: id, tab: \"mappers\" });\r\n\r\n  useFetch(\r\n    async () => {\r\n      let data: ProtocolMapperRepresentation | undefined;\r\n      if (isUpdating) {\r\n        if (isOnClientScope) {\r\n          data = await adminClient.clientScopes.findProtocolMapper({\r\n            id,\r\n            mapperId,\r\n          });\r\n        } else {\r\n          data = await adminClient.clients.findProtocolMapperById({\r\n            id,\r\n            mapperId,\r\n          });\r\n        }\r\n        if (!data) {\r\n          throw new Error(t(\"notFound\"));\r\n        }\r\n\r\n        const mapperTypes = serverInfo.protocolMapperTypes![data!.protocol!];\r\n        const mapping = mapperTypes.find(\r\n          (type) => type.id === data!.protocolMapper,\r\n        );\r\n\r\n        return {\r\n          config: {\r\n            protocol: data.protocol,\r\n            protocolMapper: data.protocolMapper,\r\n          },\r\n          mapping,\r\n          data,\r\n        };\r\n      } else {\r\n        const model = isOnClientScope\r\n          ? await adminClient.clientScopes.findOne({ id })\r\n          : await adminClient.clients.findOne({ id });\r\n        if (!model) {\r\n          throw new Error(t(\"notFound\"));\r\n        }\r\n        const protocolMappers =\r\n          serverInfo.protocolMapperTypes![model.protocol!];\r\n        const mapping = protocolMappers.find(\r\n          (mapper) => mapper.id === mapperId,\r\n        );\r\n        if (!mapping) {\r\n          throw new Error(t(\"notFound\"));\r\n        }\r\n        return {\r\n          mapping,\r\n          config: {\r\n            protocol: model.protocol,\r\n            protocolMapper: mapperId,\r\n          },\r\n        };\r\n      }\r\n    },\r\n    ({ config, mapping, data }) => {\r\n      setConfig(config);\r\n      setMapping(mapping);\r\n      if (data) {\r\n        convertToFormValues(data, setValue);\r\n      }\r\n    },\r\n    [],\r\n  );\r\n\r\n  const [toggleDeleteDialog, DeleteConfirm] = useConfirmDialog({\r\n    titleKey: \"deleteMappingTitle\",\r\n    messageKey: \"deleteMappingConfirm\",\r\n    continueButtonLabel: \"delete\",\r\n    continueButtonVariant: ButtonVariant.danger,\r\n    onConfirm: async () => {\r\n      try {\r\n        if (isOnClientScope) {\r\n          await adminClient.clientScopes.delProtocolMapper({\r\n            id,\r\n            mapperId,\r\n          });\r\n        } else {\r\n          await adminClient.clients.delProtocolMapper({\r\n            id,\r\n            mapperId,\r\n          });\r\n        }\r\n        addAlert(t(\"mappingDeletedSuccess\"), AlertVariant.success);\r\n        navigate(toDetails());\r\n      } catch (error) {\r\n        addError(\"mappingDeletedError\", error);\r\n      }\r\n    },\r\n  });\r\n\r\n  const save = async (formMapping: ProtocolMapperRepresentation) => {\r\n    const key = isUpdating ? \"Updated\" : \"Created\";\r\n    try {\r\n      const mapping = { ...config, ...convertFormValuesToObject(formMapping) };\r\n      if (isUpdating) {\r\n        if (isOnClientScope) {\r\n          await adminClient.clientScopes.updateProtocolMapper(\r\n            { id, mapperId },\r\n            { id: mapperId, ...mapping },\r\n          );\r\n        } else {\r\n          await adminClient.clients.updateProtocolMapper(\r\n            { id, mapperId },\r\n            { id: mapperId, ...mapping },\r\n          );\r\n        }\r\n      } else {\r\n        if (isOnClientScope) {\r\n          await adminClient.clientScopes.addProtocolMapper({ id }, mapping);\r\n        } else {\r\n          await adminClient.clients.addProtocolMapper({ id }, mapping);\r\n        }\r\n      }\r\n      addAlert(t(`mapping${key}Success`), AlertVariant.success);\r\n      if (!isUpdating) {\r\n        navigate(toDetails());\r\n      }\r\n    } catch (error) {\r\n      addError(`mapping${key}Error`, error);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <DeleteConfirm />\r\n      <ViewHeader\r\n        titleKey={isUpdating ? mapping?.name! : t(\"addMapper\")}\r\n        subKey={isUpdating ? mapperId : \"addMapperExplain\"}\r\n        dropdownItems={\r\n          isUpdating\r\n            ? [\r\n                <DropdownItem\r\n                  key=\"delete\"\r\n                  value=\"delete\"\r\n                  onClick={toggleDeleteDialog}\r\n                >\r\n                  {t(\"delete\")}\r\n                </DropdownItem>,\r\n              ]\r\n            : undefined\r\n        }\r\n      />\r\n      <PageSection variant=\"light\">\r\n        <FormProvider {...form}>\r\n          <FormAccess\r\n            isHorizontal\r\n            onSubmit={handleSubmit(save)}\r\n            role=\"manage-clients\"\r\n          >\r\n            <FormGroup label={t(\"mapperType\")} fieldId=\"mapperType\">\r\n              <TextInput\r\n                type=\"text\"\r\n                id=\"mapperType\"\r\n                name=\"mapperType\"\r\n                readOnlyVariant=\"default\"\r\n                value={mapping?.name}\r\n              />\r\n            </FormGroup>\r\n            <TextControl\r\n              name=\"name\"\r\n              label={t(\"name\")}\r\n              labelIcon={t(\"mapperNameHelp\")}\r\n              readOnlyVariant={isUpdating ? \"default\" : undefined}\r\n              rules={{ required: t(\"required\") }}\r\n            />\r\n            <DynamicComponents\r\n              properties={mapping?.properties || []}\r\n              isNew={!isUpdating}\r\n              stringify\r\n            />\r\n            <ActionGroup>\r\n              <Button variant=\"primary\" type=\"submit\" data-testid=\"save\">\r\n                {t(\"save\")}\r\n              </Button>\r\n              <Button\r\n                data-testid=\"cancel\"\r\n                variant=\"link\"\r\n                component={(props) => <Link {...props} to={toDetails()} />}\r\n              >\r\n                {t(\"cancel\")}\r\n              </Button>\r\n            </ActionGroup>\r\n          </FormAccess>\r\n        </FormProvider>\r\n      </PageSection>\r\n    </>\r\n  );\r\n}\r\n"],"names":["MappingDetails","adminClient","useAdminClient","t","useTranslation","addAlert","addError","useAlerts","id","mapperId","viewMode","useParams","form","useForm","setValue","handleSubmit","mapping","setMapping","useState","config","setConfig","navigate","useNavigate","realm","useRealm","serverInfo","useServerInfo","isUpdating","isOnClientScope","useMatch","MapperRoute","toDetails","toClientScope","toDedicatedScope","useFetch","data","type","model","mapper","convertToFormValues","toggleDeleteDialog","DeleteConfirm","useConfirmDialog","ButtonVariant","AlertVariant","error","save","formMapping","key","convertFormValuesToObject","jsxs","Fragment","jsx","ViewHeader","DropdownItem","PageSection","FormProvider","FormAccess","FormGroup","TextInput","TextControl","DynamicComponents","ActionGroup","Button","props","Link"],"mappings":"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"}